<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Compinent-Library-12306 | AllimacBlog</title><meta name="author" content="Allimac"><meta name="copyright" content="Allimac"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="12306项目开发Part1-组件库开发">
<meta property="og:type" content="article">
<meta property="og:title" content="Compinent-Library-12306">
<meta property="og:url" content="http://example.com/2025/03/26/Compinent-Library-12306/index.html">
<meta property="og:site_name" content="AllimacBlog">
<meta property="og:description" content="12306项目开发Part1-组件库开发">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.png">
<meta property="article:published_time" content="2025-03-26T03:39:58.000Z">
<meta property="article:modified_time" content="2025-03-26T03:42:25.638Z">
<meta property="article:author" content="Allimac">
<meta property="article:tag" content="组件库">
<meta property="article:tag" content="全局异常处理">
<meta property="article:tag" content="幂等">
<meta property="article:tag" content="分布式雪花算法id">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Compinent-Library-12306",
  "url": "http://example.com/2025/03/26/Compinent-Library-12306/",
  "image": "http://example.com/img/avatar.png",
  "datePublished": "2025-03-26T03:39:58.000Z",
  "dateModified": "2025-03-26T03:42:25.638Z",
  "author": [
    {
      "@type": "Person",
      "name": "Allimac",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/faviconcute.png"><link rel="canonical" href="http://example.com/2025/03/26/Compinent-Library-12306/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Compinent-Library-12306',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">67</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/nature_top_image.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">AllimacBlog</span></a><a class="nav-page-title" href="/"><span class="site-name">Compinent-Library-12306</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Compinent-Library-12306</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-26T03:39:58.000Z" title="发表于 2025-03-26 11:39:58">2025-03-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-26T03:42:25.638Z" title="更新于 2025-03-26 11:42:25">2025-03-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/12306/">12306</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">24.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>93分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>今天开始做一下12306的项目，这算是第一个大型项目。在此之前从零到一写了短连接服务，但code的过程中几乎没有写日志，没有在第一次的时候就沉淀学习。现在来记录一下这个项目的学习。为了篇幅的简洁，这个系列的博客仅记录核心内容，关键流程。</p>
<h1 id="组件库"><a href="#组件库" class="headerlink" title="组件库"></a>组件库</h1><h2 id="SpringBoot-Starter"><a href="#SpringBoot-Starter" class="headerlink" title="SpringBoot Starter"></a>SpringBoot Starter</h2><h3 id="1-Starter-定义"><a href="#1-Starter-定义" class="headerlink" title="1. Starter 定义"></a>1. Starter 定义</h3><p>SpringBoot Starter 类似于一种插件机制，抛弃了之前繁琐的配置，将复杂依赖统一集成进 Starter。</p>
<p>所有依赖模块都遵循着约定成俗的默认配置，并允许我们调整这些配置，即遵循“约定大于配置”的理念</p>
<h3 id="2-Starter-好处"><a href="#2-Starter-好处" class="headerlink" title="2. Starter 好处"></a>2. Starter 好处</h3><p>Starter 的出现极大的帮助开发者们从繁琐的框架配置中解放出来，从而更专注于业务代码。</p>
<p>并且 SpringBoot 官方提供除了企业级项目不同场景的 Starter 依赖模块，可以很便捷的集成进项目。</p>
<p>比如 SpringBoot 项目需要依赖 Redis，我们只需要加入 spring-boot-starter-data-redis 依赖，并配置一些必须的连接信息。</p>
<p>使用者只需要引用 Starter 依赖，SpringBoot 就可以自动加载项目所需要的配置依赖，彻底摆脱了不同的依赖库引用以及版本问题。</p>
<h2 id="自定义-Starter"><a href="#自定义-Starter" class="headerlink" title="自定义 Starter"></a>自定义 Starter</h2><h3 id="1-Starter-命名"><a href="#1-Starter-命名" class="headerlink" title="1. Starter 命名"></a>1. Starter 命名</h3><p>官方对 Starter 包定义的 ArtifactId 是有要求的，当然也可以不遵守（毕竟你的项目你做主）。</p>
<p>Spring 官方提供 Starter 通常命名为 spring-boot-starter-{name} 如：spring-boot-starter-web，spring-boot-starter-activemq 等，这里放一部分官方提供列表，详情查看 SpringBoot Starter 列表。</p>
<p>Spring 官方建议非官方提供的 Starter 命名应遵守 {name}-spring-boot-starter 的格式。</p>
<p>比如 MyBatis 出品的：mybatis-spring-boot-starter。</p>
<h1 id="基础组件模块"><a href="#基础组件模块" class="headerlink" title="基础组件模块"></a>基础组件模块</h1><h2 id="组件地址"><a href="#组件地址" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-base-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>index12306-base-spring-boot-starter</code> 在 12306 的整体规划中，属于顶层组件或基础组件。</p>
<p>那什么样的组件能被称为顶层？可以从几个方面去说明这个问题：</p>
<ul>
<li>兼容性：能够被所有组件或者所有客户端项目所依赖，不会存在兼容性的代码组件。</li>
<li>功能性：独立且公用的功能可被用户无感知依赖。比如当 fastjson 出现安全漏洞，可通过升级顶层组件来解决所有依赖包问题。</li>
</ul>
<h2 id="组件概览"><a href="#组件概览" class="headerlink" title="组件概览"></a>组件概览</h2><ol>
<li>定义全局配置常量和过滤器执行顺序。</li>
<li>封装 Spring 应用上下文 <code>ApplicationContextHolder</code>。</li>
<li>封装 FastJSON 安全模式，客户端可通过配置 <code>fastjson. safe-mode=true</code> 开启安全模式。</li>
<li>封装应用初始化事件，通过 Spring <code>ApplicationReadyEvent</code> 进行发布，并保证仅执行一次，<code>ApplicationInitializingEvent</code>。</li>
<li>单例对象容器，可避免重复创建对象，方便全局访问。</li>
</ol>
<h2 id="组件功能"><a href="#组件功能" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-全局变量-组件执行顺序"><a href="#1-全局变量-组件执行顺序" class="headerlink" title="1. 全局变量&amp;组件执行顺序"></a>1. 全局变量&amp;组件执行顺序</h3><p>我们先来看下，全局变量&amp;组件执行顺序功能在代码中的体现都是什么？</p>
<h4 id="全局用户常量"><a href="#全局用户常量" class="headerlink" title="全局用户常量"></a>全局用户常量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases.constant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户常量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserConstant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户 ID Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_ID_KEY</span> <span class="operator">=</span> <span class="string">&quot;userId&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名 Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_NAME_KEY</span> <span class="operator">=</span> <span class="string">&quot;username&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户真实名称 Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REAL_NAME_KEY</span> <span class="operator">=</span> <span class="string">&quot;realName&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思考下，为什么要定义这个全局变量定义常量类？<br>如果没有定义在顶级组件库中，那么这些常量都是定义在各个组件库中的。比如用户的常量定义在用户的组件库中。</p>
<p>那又为什么把这个抽象提炼出来？</p>
<p>一旦涉及到抽象提炼的工作，就能说明，这个常量肯定不是只在用户组件库中使用。因为在网关中，将用户 Token 进行解析，并放到 HTTP Header 中，最终放到用户请求上下文，也需要用到这些用户常量。</p>
<p>类似于这种多处使用的变量，分别定义肯定是不优雅的，那我们只能找个地方将这个定义，并被用户和网关同时使用。基础组件库因为要被每个组件库依赖，所以是最好的选择。</p>
<h4 id="全局过滤器顺序执行常量类"><a href="#全局过滤器顺序执行常量类" class="headerlink" title="全局过滤器顺序执行常量类"></a>全局过滤器顺序执行常量类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases.constant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局过滤器顺序执行常量类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FilterOrderConstant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户信息传递过滤器执行顺序排序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">USER_TRANSMIT_FILTER_ORDER</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤器、拦截器或 AOP 组件的执行顺序又为什么定义在基础组件库？</p>
<p>假设你的应用依赖了日志打印和幂等组件，方法执行时，需要打印日志和避免请求幂等。流程伪代码如下：</p>
<p>正常来说，要先打印日志，再触发幂等行为。但是，如果说日志和幂等的组件库开发者不是同一人，幂等在日志请求之前。如果不触发幂等还好，一旦触发幂等行为抛出异常，那么日志组件将不再执行。这对于生产日志以及排查问题来说非常不友好。</p>
<p><strong>所以说，每个基础组件的执行顺序需要在全局定义</strong></p>
<p><strong>定义类似于这种过滤器或拦截器再或者 AOP 时，需要从组件功能再结合全局组件功能考虑到执行顺序问题。</strong></p>
<p>正因为如此，将这些组件的执行顺序单独放到基础组件库中，一个是基础组库被全部组件库依赖，另一个就是定义组件时，也能看到其他组件库的功能以及执行顺序。避免出现信息孤岛问题。</p>
<p>总得来说，有以下这些优势：</p>
<ul>
<li>解耦和可复用性：通过将组件库的执行顺序抽象到一个基础的组件库中，可以将各个组件库之间的依赖和执行顺序解耦。这样，每个组件库可以独立开发、测试和维护，提高了代码的可复用性和可维护性。</li>
<li>灵活性：由于执行顺序被抽象到基础组件库中，可以根据具体的业务需求对组件库进行配置，灵活地调整组件的执行顺序。这种灵活性使得开发人员可以根据具体的场景和需求来定义过滤器的执行顺序，提供更好的定制化和灵活性。</li>
<li>执行顺序的统一管理：将执行顺序抽象到一个基础组件库中，可以实现对所有组件库中过滤器执行顺序的统一管理。开发人员只需关注各个组件库的业务逻辑实现，而不必关心过滤器的具体执行顺序。这样可以简化开发流程，提高开发效率。</li>
<li>扩展性：基础组件库可以提供一些通用的功能和特性，例如全局变量的管理、过滤器的注册和执行等。这样可以为其他组件库提供扩展性，使其能够更好地适应不同的业务场景和需求。</li>
</ul>
<h3 id="2-Spring-容器上下文"><a href="#2-Spring-容器上下文" class="headerlink" title="2. Spring 容器上下文"></a>2. Spring 容器上下文</h3><p>很多时候，我们也需要在非 Spring Bean 中使用到 Spring Bean。</p>
<p>如果说在 Spring Bean 中获取 Spring Bean，只需要通过构造器或者 @Autowired @Resource 就可以了。但是非 Spring Bean 却不行。</p>
<p>基于以上诉求，我们依赖 Spring 提供的 ApplicationContextAware接口，来将 Spring IOC 容器的对象放到一个自定义容器中，并持有 Spring IOC 容器。这样就可以通过自定义容器访问 Spring IOC 容器获取 Spring Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Application context holder.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextHolder</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext CONTEXT;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        ApplicationContextHolder.CONTEXT = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get ioc container bean by type.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT.getBean(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get ioc container bean by name and type.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(String name, Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT.getBean(name, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get a set of ioc container beans by type.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Map&lt;String, T&gt; <span class="title function_">getBeansOfType</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT.getBeansOfType(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Find whether the bean has annotations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotationType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;A&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;A <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; A <span class="title function_">findAnnotationOnBean</span><span class="params">(String beanName, Class&lt;A&gt; annotationType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT.findAnnotationOnBean(beanName, annotationType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get ApplicationContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-FastJSON-安全模式"><a href="#3-FastJSON-安全模式" class="headerlink" title="3. FastJSON 安全模式"></a>3. FastJSON 安全模式</h3><p>Fastjson 的 “autoType” 特性是指在反序列化过程中，允许将 JSON 字符串自动转换为指定的 Java 类型。它提供了一种方便的方式，使得开发人员可以直接将 JSON 数据转换为相应的 Java 对象，而无需手动指定目标类。</p>
<p>然而，这个特性也存在一定的安全风险。攻击者可以构造恶意的 JSON 数据，其中包含对不受信任的类的引用。当 “autoType” 特性被启用时，Fastjson 会尝试根据 JSON 字符串中的类信息实例化相应的对象，从而可能导致潜在的安全问题，例如远程代码执行攻击。</p>
<p>为了说明这个问题，考虑以下示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.example.EvilClass\&quot;,\&quot;data\&quot;:\&quot;Malicious Data\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonString);</span><br></pre></td></tr></table></figure>

<p>在上述示例中，JSON 字符串中的 “@type” 属性指定了一个名为 “com.example.EvilClass” 的类。如果 Fastjson 的 “autoType” 特性被启用，它将尝试将该 JSON 字符串转换为 “com.example.EvilClass” 类的实例，而不考虑该类是否可信或预期。</p>
<p>为了防止这种安全问题，Fastjson 默认情况下禁用了 “autoType” 特性，以提供一定的安全性。但是，在某些特定场景下，开发人员可能会手动启用该特性，例如在处理受信任的 JSON 数据时需要转换为多态对象。</p>
<p>我们 FastJSON 安全模式，会关闭该 autoType 特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases. safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FastJson安全模式，开启后关闭类型隐式传递</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonSafeMode</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;fastjson2.parser.safeMode&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果配置文件中配置了 <code>framework.fastjson. safe-mode=true</code> 那么则开启安全模式，反之无任何变化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.bases.ApplicationContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.bases.init.ApplicationContentPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.bases. safe.FastJsonSafeMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用基础自动装配</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationBaseAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(value = &quot;framework.fastjson. safe-mode&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FastJsonSafeMode <span class="title function_">congoFastJsonSafeMode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FastJsonSafeMode</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-安全初始化事件"><a href="#4-安全初始化事件" class="headerlink" title="4. 安全初始化事件"></a>4. 安全初始化事件</h3><p>我们在实际应用开发中，会依赖很多应用初始化时执行任务，比如说 <code>InitializingBean</code>、<code>CommandLineRunner</code> 等。</p>
<p>除此之外，还有一些比如依赖 Spring 初始化的一些事件。</p>
<ol>
<li>ContextRefreshedEvent： 当应用程序上下文（ApplicationContext）初始化或刷新完成后触发。这通常发生在应用程序启动过程中，并且表示应用程序已准备好接收请求和执行业务逻辑。可以使用该事件来执行一些初始化操作，例如加载缓存数据、启动后台任务等。</li>
<li>ContextStartedEvent： 当应用程序上下文启动时触发。这个事件在调用 ConfigurableApplicationContext 的 start() 方法后被发布。可以使用该事件来执行启动应用程序所需的特定逻辑，例如启动定时任务、启动消息监听器等。</li>
<li>ContextStoppedEvent： 当应用程序上下文停止时触发。这个事件在调用 ConfigurableApplicationContext 的 stop() 方法后被发布。可以使用该事件来执行停止应用程序所需的清理逻辑，例如关闭连接、释放资源等。</li>
<li>ContextClosedEvent： 当应用程序上下文关闭时触发。这个事件在调用 ConfigurableApplicationContext 的 close() 方法后被发布。可以使用该事件来执行一些最终的清理操作，例如释放数据库连接、销毁单例对象等。</li>
<li>ServletRequestHandledEvent： 当 Spring MVC 处理完一个 HTTP 请求时触发。该事件提供了有关请求处理的详细信息，包括请求的处理时间、处理器、处理器适配器等。可以使用该事件来进行请求处理的监控、日志记录或统计信息收集等操作。</li>
<li>ApplicationStartedEvent（Spring Boot）： 当 Spring Boot 应用程序启动时触发。这个事件在 SpringApplication.run() 方法完成后被发布。可以使用该事件来执行特定于应用程序的初始化逻辑。</li>
<li>ApplicationReadyEvent（Spring Boot）： 当 Spring Boot 应用程序准备就绪时触发。这个事件表示应用程序已经启动完毕，并且已经可以提供服务。可以使用该事件来执行应用程序的后续初始化操作，例如加载数据、发送通知等。</li>
</ol>
<p>有些场景是依赖 Spring 容器初始化完成后调用的，<code>ContextRefreshedEvent</code> 这个时间就比较合适。但是大家发现没有，它除了初始化调用，容器刷新也会调用。</p>
<p>为了避免容器刷新造成二次调用初始化逻辑，我们对一些比较常用的事件简单封装了一层逻辑。</p>
<p>首先定义初始化事件对象类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases.init;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用初始化事件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 规约事件，通过此事件可以查看业务系统所有初始化行为</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationInitializingEvent</span> <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new &#123;<span class="doctag">@code</span> ApplicationEvent&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source the object on which the event initially occurred or with</span></span><br><span class="line"><span class="comment">     *               which the event is associated (never &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApplicationInitializingEvent</span><span class="params">(Object source)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其次，定义应用初始化后置处理器，防止 Spring 事件被多次执行。</p>
<p>整体逻辑也比较简单，通过锁来保证同一时间只有一个事件进行初始化。初始化后设置一个标识，下次如果再触发，就不再执行，类似于幂等处理的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases.init;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.event.ApplicationReadyEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用初始化后置处理器，防止Spring事件被多次执行</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContentPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行标识，确保Spring事件 &#123;<span class="doctag">@link</span> ApplicationReadyEvent&#125; 有且执行一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">executeOnlyOnce</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!executeOnlyOnce.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        applicationContext.publishEvent(<span class="keyword">new</span> <span class="title class_">ApplicationInitializingEvent</span>(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-单例对象容器"><a href="#5-单例对象容器" class="headerlink" title="5. 单例对象容器"></a>5. 单例对象容器</h3><p>提供一种单例的访问模式，单例的优点如下：</p>
<ol>
<li>全局访问：单例对象可以在应用程序的任何地方被访问，而不需要传递对象的引用。这样可以方便地共享对象的状态和功能，简化了对象之间的通信和协作。</li>
<li>节省资源：由于只有一个对象实例存在，可以减少重复创建对象的开销。在需要频繁创建和销毁对象的情况下，单例对象可以显著节省系统资源，提高性能。</li>
</ol>
<p>应用场景也比较多，比如说，发送邮件时需要加载邮件的模板文件，重复加载就比较浪费性能。完全可以加载一次后，将该对象放到单例对象容器中缓存，下次使用时直接获取就好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.bases;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AccessLevel;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 单例对象容器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NoArgsConstructor(access = AccessLevel.PRIVATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Object&gt; SINGLE_OBJECT_POOL = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 key 获取单例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> SINGLE_OBJECT_POOL.get(key);</span><br><span class="line">        <span class="keyword">return</span> result == <span class="literal">null</span> ? <span class="literal">null</span> : (T) result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 key 获取单例对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; 为空时，通过 supplier 构建单例对象并放入容器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">get</span><span class="params">(String key, Supplier&lt;T&gt; supplier)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> SINGLE_OBJECT_POOL.get(key);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span> &amp;&amp; (result = supplier.get()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            SINGLE_OBJECT_POOL.put(key, result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result != <span class="literal">null</span> ? (T) result : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象放入容器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">        put(value.getClass().getName(), value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象放入容器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        SINGLE_OBJECT_POOL.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="规约组件模块"><a href="#规约组件模块" class="headerlink" title="规约组件模块"></a>规约组件模块</h1><h2 id="组件地址-1"><a href="#组件地址-1" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-convention-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述"><a href="#组件概述" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>定义异常码抽象和公共异常码。</li>
<li>定义抽象异常和客户端、服务端以及远程调用异常。</li>
<li>封装分页对象请求参数和返回参数实体。</li>
<li>封装公共响应对象。</li>
</ol>
<h2 id="组件功能-1"><a href="#组件功能-1" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-异常码抽象和公共异常码"><a href="#1-异常码抽象和公共异常码" class="headerlink" title="1. 异常码抽象和公共异常码"></a>1. 异常码抽象和公共异常码</h3><p>为什么要做异常码规范和抽象异常码？如果没有这些规范，大家项目中抛出异常是怎么样的？</p>
<p>假设不同项目中抛出了相同的业务异常，可能是这种场景：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># A项目</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># B项目</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;000001&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># C项目</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;500&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># xxx项目</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>异常码的不统一，带来的最直接后果就是返回结果异常码混乱，没有规律，也不方便排查问题。</p>
<h4 id="1）异常码接口抽象。"><a href="#1）异常码接口抽象。" class="headerlink" title="1）异常码接口抽象。"></a>1）异常码接口抽象。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.convention.errorcode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 平台错误码</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IErrorCode</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">code</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2）封装常用的公共异常码。"><a href="#2）封装常用的公共异常码。" class="headerlink" title="2）封装常用的公共异常码。"></a>2）封装常用的公共异常码。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.convention.errorcode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基础错误码定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BaseErrorCode</span> <span class="keyword">implements</span> <span class="title class_">IErrorCode</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 一级宏观错误码 客户端错误 ==========</span></span><br><span class="line">    CLIENT_ERROR(<span class="string">&quot;A000001&quot;</span>, <span class="string">&quot;用户端错误&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 二级宏观错误码 用户注册错误 ==========</span></span><br><span class="line">    USER_REGISTER_ERROR(<span class="string">&quot;A000100&quot;</span>, <span class="string">&quot;用户注册错误&quot;</span>),</span><br><span class="line">    USER_NAME_VERIFY_ERROR(<span class="string">&quot;A000110&quot;</span>, <span class="string">&quot;用户名校验失败&quot;</span>),</span><br><span class="line">    USER_NAME_EXIST_ERROR(<span class="string">&quot;A000111&quot;</span>, <span class="string">&quot;用户名已存在&quot;</span>),</span><br><span class="line">    USER_NAME_SENSITIVE_ERROR(<span class="string">&quot;A000112&quot;</span>, <span class="string">&quot;用户名包含敏感词&quot;</span>),</span><br><span class="line">    USER_NAME_SPECIAL_CHARACTER_ERROR(<span class="string">&quot;A000113&quot;</span>, <span class="string">&quot;用户名包含特殊字符&quot;</span>),</span><br><span class="line">    PASSWORD_VERIFY_ERROR(<span class="string">&quot;A000120&quot;</span>, <span class="string">&quot;密码校验失败&quot;</span>),</span><br><span class="line">    PASSWORD_SHORT_ERROR(<span class="string">&quot;A000121&quot;</span>, <span class="string">&quot;密码长度不够&quot;</span>),</span><br><span class="line">    PHONE_VERIFY_ERROR(<span class="string">&quot;A000151&quot;</span>, <span class="string">&quot;手机格式校验失败&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 二级宏观错误码 系统请求缺少幂等Token ==========</span></span><br><span class="line">    IDEMPOTENT_TOKEN_NULL_ERROR(<span class="string">&quot;A000200&quot;</span>, <span class="string">&quot;幂等Token为空&quot;</span>),</span><br><span class="line">    IDEMPOTENT_TOKEN_DELETE_ERROR(<span class="string">&quot;A000201&quot;</span>, <span class="string">&quot;幂等Token已被使用或失效&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 一级宏观错误码 系统执行出错 ==========</span></span><br><span class="line">    SERVICE_ERROR(<span class="string">&quot;B000001&quot;</span>, <span class="string">&quot;系统执行出错&quot;</span>),</span><br><span class="line">    <span class="comment">// ========== 二级宏观错误码 系统执行超时 ==========</span></span><br><span class="line">    SERVICE_TIMEOUT_ERROR(<span class="string">&quot;B000100&quot;</span>, <span class="string">&quot;系统执行超时&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 一级宏观错误码 调用第三方服务出错 ==========</span></span><br><span class="line">    REMOTE_ERROR(<span class="string">&quot;C000001&quot;</span>, <span class="string">&quot;调用第三方服务出错&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    BaseErrorCode(String code, String message) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-抽象异常体系"><a href="#2-抽象异常体系" class="headerlink" title="2. 抽象异常体系"></a>2. 抽象异常体系</h3><p>对可能出现的三类异常：客户端异常 服务端异常 远程调用异常共同继承 RuntimeException，那么肯定具备很多相似的地方，这里统一抽象一层 <code>AbstractException</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.congomall.springboot.starter.convention.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Strings;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.congomall.springboot.starter.convention.errorcode.IErrorCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象项目中三类异常体系，客户端异常、服务端异常以及远程服务调用异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chen.ma</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> &lt;a href=&quot;https://github.com/opengoofy&quot; /&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ClientException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ServiceException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> RemoteException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String errorCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String errorMessage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractException</span><span class="params">(String message, Throwable throwable, IErrorCode errorCode)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, throwable);</span><br><span class="line">        <span class="built_in">this</span>.errorCode = errorCode.code();</span><br><span class="line">        <span class="built_in">this</span>.errorMessage = Optional.ofNullable(Strings.emptyToNull(message)).orElse(errorCode.message());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-封装分页对象"><a href="#3-封装分页对象" class="headerlink" title="3. 封装分页对象"></a>3. 封装分页对象</h3><p>MyBatisPlus 分页对象已经足够好了，为什么还要单独封装分页对象？</p>
<p>如果是我刚开始开这个项目，我可能会有这样的疑问。在已经比较完善的框架上封装新的功能，这不是多此一举么？</p>
<p>对于业务比较单一公司来说，不需要考虑这种情况，但是如果公司业务比较多就会出现不同的场景。我觉得下面两个原因是我要封装分页对象的主要出发点：</p>
<ul>
<li>提供出去的 API 包，包里有个对象用了分页对象。但是依赖这个包的客户端没有使用 MyBatisPlus，难道要因为一个分页对象，把整个 MyBatisPlus 包都依赖进去么？</li>
<li>随着现在技术架构发展日新月异，谁也不能保证哪个框架可以长久留存。如果强依赖 MyBatisPlus，后续如果换了 ORM 框架，对于整体修改是个灾难。</li>
</ul>
<p>基于这两点考虑，抽象了分页入参和分页出参两个实体对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.convention.page;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页请求对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; &#123;<span class="doctag">@link</span> PageRequest&#125;、&#123;<span class="doctag">@link</span> PageResponse&#125;</span></span><br><span class="line"><span class="comment"> * 可以理解是防腐层的一种实现，不论底层 ORM 框架，对外分页参数属性不变</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每页显示条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.convention.page;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页返回对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; &#123;<span class="doctag">@link</span> PageRequest&#125;、&#123;<span class="doctag">@link</span> PageResponse&#125;</span></span><br><span class="line"><span class="comment"> * 可以理解是防腐层的一种实现，不论底层 ORM 框架，对外分页参数属性不变</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResponse</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long current;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每页显示条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询数据列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; records = Collections.emptyList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageResponse</span><span class="params">(<span class="type">long</span> current, <span class="type">long</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(current, size, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageResponse</span><span class="params">(<span class="type">long</span> current, <span class="type">long</span> size, <span class="type">long</span> total)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (current &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.current = current;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        <span class="built_in">this</span>.total = total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PageResponse <span class="title function_">setRecords</span><span class="params">(List&lt;T&gt; records)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.records = records;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R&gt; PageResponse&lt;R&gt; <span class="title function_">convert</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends R&gt; mapper)</span> &#123;</span><br><span class="line">        List&lt;R&gt; collect = <span class="built_in">this</span>.getRecords().stream().map(mapper).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> ((PageResponse&lt;R&gt;) <span class="built_in">this</span>).setRecords(collect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-封装公共响应对象"><a href="#4-封装公共响应对象" class="headerlink" title="4. 封装公共响应对象"></a>4. 封装公共响应对象</h3><p>如果接口返回的内容格式不规范，会对前端开发人员造成困扰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.convention.result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serial;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局返回对象</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Serial</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">5679018624309023727L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正确返回码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUCCESS_CODE</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String requestId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SUCCESS_CODE.equals(code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="用户基础组件库"><a href="#用户基础组件库" class="headerlink" title="用户基础组件库"></a>用户基础组件库</h1><h2 id="组件地址-2"><a href="#组件地址-2" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-user-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="组件概述-1"><a href="#组件概述-1" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>通过 JWT 生成用户登录唯一凭证。</li>
<li>封装当前请求用户上下文。</li>
<li>拦截带 Token 的请求，并将 Token 解析放入用户上下文中。</li>
</ol>
<h2 id="组件功能-2"><a href="#组件功能-2" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-JWT-Token-生成器"><a href="#1-JWT-Token-生成器" class="headerlink" title="1. JWT Token 生成器"></a>1. JWT Token 生成器</h3><p>通过 JWT 生成用户唯一 Token 凭证，并提供反解析 Token 凭证位用户信息方法。应用于用户服务以及网关服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.frameworks.starter.user.toolkit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.ExpiredJwtException;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.frameworks.starter.user.core.UserInfoDTO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.opengoofy.index12306.framework.starter.bases.constant.UserConstant.REAL_NAME_KEY;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.opengoofy.index12306.framework.starter.bases.constant.UserConstant.USER_ID_KEY;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.opengoofy.index12306.framework.starter.bases.constant.UserConstant.USER_NAME_KEY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT 工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">JWTUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EXPIRATION</span> <span class="operator">=</span> <span class="number">86400L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOKEN_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;Bearer &quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ISS</span> <span class="operator">=</span> <span class="string">&quot;index12306&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECRET</span> <span class="operator">=</span> <span class="string">&quot;SecretKey039245678901232039487623456783092349288901402967890140939827&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成用户 Token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户访问 Token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateAccessToken</span><span class="params">(UserInfoDTO userInfo)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; customerUserMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        customerUserMap.put(USER_ID_KEY, userInfo.getUserId());</span><br><span class="line">        customerUserMap.put(USER_NAME_KEY, userInfo.getUsername());</span><br><span class="line">        customerUserMap.put(REAL_NAME_KEY, userInfo.getRealName());</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, SECRET)</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                .setIssuer(ISS)</span><br><span class="line">                .setSubject(JSON.toJSONString(customerUserMap))</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + EXPIRATION * <span class="number">1000</span>))</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="keyword">return</span> TOKEN_PREFIX + jwtToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析用户 Token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken 用户访问 Token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserInfoDTO <span class="title function_">parseJwtToken</span><span class="params">(String jwtToken)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(jwtToken)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">actualJwtToken</span> <span class="operator">=</span> jwtToken.replace(TOKEN_PREFIX, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser().setSigningKey(SECRET).parseClaimsJws(actualJwtToken).getBody();</span><br><span class="line">                <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> claims.getExpiration();</span><br><span class="line">                <span class="keyword">if</span> (expiration.after(<span class="keyword">new</span> <span class="title class_">Date</span>())) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> claims.getSubject();</span><br><span class="line">                    <span class="keyword">return</span> JSON.parseObject(subject, UserInfoDTO.class);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExpiredJwtException ignored) &#123;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;JWT Token解析失败，请检查&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="设计模式组件库"><a href="#设计模式组件库" class="headerlink" title="设计模式组件库"></a>设计模式组件库</h1><h2 id="组件地址-3"><a href="#组件地址-3" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-designpattern-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述-2"><a href="#组件概述-2" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>封装构建者模式。</li>
<li>封装责任链模式</li>
<li>封装策略模式。</li>
</ol>
<h2 id="组件功能-3"><a href="#组件功能-3" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-封装构建者模式"><a href="#1-封装构建者模式" class="headerlink" title="1. 封装构建者模式"></a>1. 封装构建者模式</h3><p>构建者模式相对简单，仅需要提供一个抽象接口即可。构建者相关的特性均在实现类中完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.designpattern.builder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Builder 模式抽象接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Builder</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 构建后的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    T <span class="title function_">build</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-封装责任链模式"><a href="#2-封装责任链模式" class="headerlink" title="2. 封装责任链模式"></a>2. 封装责任链模式</h3><h4 id="什么是责任链模式"><a href="#什么是责任链模式" class="headerlink" title="什么是责任链模式"></a>什么是责任链模式</h4><blockquote>
<p>责任链设计模式是一种行为型设计模式，其主要目的是解耦请求发送者和请求接收者，让多个对象都有机会处理请求，从而避免请求发送者和接收者之间的紧耦合。</p>
<p>责任链模式的核心是一个链式结构，链中每个节点代表一个处理者对象，请求先经过第一个节点处理，如果该节点能够处理请求，则直接返回处理结果；否则，请求继续往下一个节点传递，直到找到能够处理该请求的节点为止。整个过程类似于流水线上的多个工作站，每个工作站负责一项工作，如果自己处理不了，就将工作交给下一个工作站，直到整个工作完成。</p>
<p>在责任链模式中，每个处理者对象都有一个指向下一个处理者对象的引用，这样就形成了一个处理者链。请求发送者只需要将请求发送给第一个节点即可，而不用关心请求会被哪个处理者对象处理。由于每个处理者对象都有机会处理请求，因此责任链模式可以实现请求的动态分配。</p>
</blockquote>
<p>举个例子，SpringMvc 中可以定义拦截器，并且可以定义多个。当一个用户发起请求时，顺利的话请求会经过所有拦截器，最终到达业务代码逻辑，SpringMvc 拦截器设计就是使用了责任链模式。</p>
<p>为什么说顺利的话会经过所有拦截器？因为请求不满足拦截器自定义规则会被打回，但这并不是责任链模式的唯一处理方式，继续往下看。</p>
<p>在责任链模式中，多个处理器（参照上述拦截器）依次处理同一个请求。一个请求先经过 A 处理器处理，然后再把请求传递给 B 处理器，B 处理器处理完后再传递给 C 处理器，以此类推，形成一个链条，链条上的每个处理器 <strong>各自承担各自的处理职责。</strong></p>
<p>责任链模式中多个处理器形成的处理器链在进行处理请求时，有两种处理方式：</p>
<ol>
<li>请求会被 <strong>所有的处理器都处理一遍，不存在中途终止的情况</strong>，这里参照 MyBatis 拦截器理解。</li>
<li>二则是处理器链执行请求中，某一处理器执行时，<strong>如果不符合自制定规则的话，停止流程，并且剩下未执行处理器就不会被执行</strong>，大家参照 SpringMvc 拦截器理解。</li>
</ol>
<h4 id="责任链场景业务设计"><a href="#责任链场景业务设计" class="headerlink" title="责任链场景业务设计"></a>责任链场景业务设计</h4><p>趁热打铁，本小节对使用的真实业务场景进行举例说明。假设业务场景是这样的，我们 <strong>系统处在一个下游服务</strong>，因为业务需求，系统中所使用的 <strong>基础数据需要从上游中台同步到系统数据库。</strong></p>
<p>基础数据包含了很多类型数据，虽然数据在中台会有一定验证，但是 <strong>数据只要是人为录入就极可能存在问题，遵从对上游系统不信任原则</strong>，需要对数据接收时进行一系列校验。</p>
<p>从我们系统的接入数据规则而言，个人觉得需要支持以下几套规则：</p>
<ol>
<li><strong>必填项校验</strong>，如果数据无法满足业务所必须字段要求，数据一旦落入库中就会产生一系列问题。</li>
<li><strong>非法字符校验</strong>，因为数据如何录入，上游系统的录入规则是什么样的我们都不清楚，这一项规则也是必须的。</li>
<li><strong>长度校验</strong>，理由同上，如果系统某字段长度限制 50，但是接入来的数据 500长度，这也会造成问题。</li>
</ol>
<p>现实的规则肯定不止这三套</p>
<p>需要达成的业务需求：将一个批量数据经过处理器链的处理，<strong>返回出符合要求的数据分类。</strong></p>
<p>我们可以抽象一个思路出来</p>
<blockquote>
<ul>
<li>定义验证接口：包含非空字段校验处理器，字段敏感词校验处理器，长度校验器，他们都实现验证接口。同时被Component注解。对传入的入参进行处理。</li>
<li>进行链式调用：VerifyHandlerChain 处理流程如下：<ul>
<li>实现自 InitializingBean 接口，在对应实现方法中获取 IOC 容器中类型为 VerifyHandler 的 Bean，也就是 EmptyVerifyHandler、SexyVerifyHandler。</li>
<li>将 VerifyHandler 类型的 Bean 添加到处理器链容器中。</li>
<li>定义校验方法 verify()，对入参数据展开处理器链的全部调用，如果过程中发现已无需要验证的数据，直接返回。</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h4><p>一定要使用责任链模式么？不使用能不能完成业务需求？</p>
<p>回答是肯定可以，设计模式只是帮助减少代码的复杂性，让其满足开闭原则，提高代码的扩展性。如果不使用同样可以完成需求。</p>
<p>如果不使用责任链模式，上面说的真实同步场景面临两个问题：</p>
<ol>
<li>如果把上述说的代码逻辑校验规则写到一起，<strong>毫无疑问这个类或者说这个方法函数奇大无比</strong>。减少代码复杂性一贯方法是：<strong>将大块代码逻辑拆分成函数，将大类拆分成小类</strong>，是应对代码复杂性的常用方法。如果此时说：可以把不同的校验规则拆分成不同的函数，不同的类，这样不也可以满足减少代码复杂性的要求么。这样拆分是能解决代码复杂性，但是这样就会面临第二个问题。</li>
<li>开闭原则：<strong>添加一个新的功能应该是，在已有代码基础上扩展代码，而非修改已有代码</strong>。大家设想一下，假设你写了三套校验规则，运行过一段时间，这时候领导让加第四套，是不是要在原有代码上改动。因为每一个校验处理器都继承了 VerifyHandler，获取处理器使用 application.getBeansOfType()。所以后续如果需要增加新的过滤器就只需要再写一个继承 VerifyHandler 的类即可，不需要修改原来的代码，提高代码的扩展性。</li>
</ol>
<p>综上所述，在合适的场景运用适合的设计模式，能够让代码设计复杂性降低，变得更为健壮</p>
<h4 id="Mybatis-Interceptor底层责任链模式"><a href="#Mybatis-Interceptor底层责任链模式" class="headerlink" title="Mybatis Interceptor底层责任链模式"></a>Mybatis Interceptor底层责任链模式</h4><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEBhKXR"><img src="https://s21.ax1x.com/2025/03/25/pEBhKXR.png" alt="pEBhKXR.png"></a></p>
<p>Mybatis Interceptor 不仅用到了责任链，还用到了动态代理，服务于 Mybatis 四大 “护教法王”，在创建对象时通过动态代理和责任链相结合组装而成插件模块。</p>
<ol>
<li>ParameterHandler。</li>
<li>ResultSetHandler。</li>
<li>StatementHandler。</li>
<li>Executor。</li>
</ol>
<h4 id="如何抽象责任链模式"><a href="#如何抽象责任链模式" class="headerlink" title="如何抽象责任链模式"></a>如何抽象责任链模式</h4><p>在电商系统下单接口中，前置校验是非常重要的环节。下面是一个可能的校验步骤列表：</p>
<ul>
<li>检查商品信息是否存在，包括商品名称、价格、规格等信息。</li>
<li>检查购买数量是否合法，是否超出了最大购买数量或最小购买数量的限制。</li>
<li>检查商品库存是否充足，以确保库存足够满足购买者的需求。</li>
<li>检查购买者的优惠券、积分等是否可以使用，以确保购买者能够享受相应的优惠或积分奖励。</li>
<li>检查收货地址信息是否完整和准确，以确保商品能够顺利地送达给购买者。</li>
<li>检查下单时间是否合法，例如检查购买者是否在限定的时间范围内下单。</li>
</ul>
<p>真实电商场景中，验证逻辑绝对不仅仅是这些，过之而无不及。</p>
<p>对于完成这些前置校验逻辑，大部分程序员可能的代码思路如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">createOrder</span><span class="params">(CreateOrderReqDTO xxx)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查商品信息是否存在，包括商品名称、价格、规格等信息</span></span><br><span class="line">  	<span class="comment">// 检查购买数量是否合法，是否超出了最大购买数量或最小购买数量的限制</span></span><br><span class="line">    <span class="comment">// 检查商品库存是否充足，以确保库存足够满足购买者的需求</span></span><br><span class="line">    <span class="comment">// 检查购买者的优惠券、积分等是否可以使用，以确保购买者能够享受相应的优惠或积分奖励</span></span><br><span class="line">    <span class="comment">// 检查收货地址信息是否完整和准确，以确保商品能够顺利地送达给购买者</span></span><br><span class="line">    <span class="comment">// 检查下单时间是否合法，例如检查购买者是否在限定的时间范围内下单</span></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码非常庞大</p>
<h5 id="责任链重构"><a href="#责任链重构" class="headerlink" title="责任链重构"></a>责任链重构</h5><p>定义一个责任链处理器接口，所有子任务都实现该接口以处理具体的业务逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderCreateChainHandler</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Ordered</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行责任链逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestParam 责任链执行入参</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(T requestParam)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>同时，为了方便对责任链流程中的任务进行顺序处理，我们需要继承 Spring 框架中的排序接口 Ordered。这将有助于保证责任链中的任务顺序执行</p>
<p>创建一个责任链上下文容器，用于存储与责任链相应的子任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateChainContext</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderCreateChainHandler&gt; orderCreateChainHandlerContainer = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 责任链组件执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestParam 请求参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(T requestParam)</span> &#123;</span><br><span class="line">        <span class="comment">// 此处根据 Ordered 实际值进行排序处理</span></span><br><span class="line">        orderCreateChainHandlerContainer.stream()</span><br><span class="line">                .sorted(Comparator.comparing(Ordered::getOrder)).forEach(each -&gt; each.handler(requestParam));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      	<span class="comment">// 通过 Spring 上下文容器，获取所有 CreateOrderChainContext Bean</span></span><br><span class="line">        Map&lt;String, OrderCreateChainHandler&gt; chainFilterMap = ApplicationContextHolder.getBeansOfType(OrderCreateChainHandler.class);</span><br><span class="line">      	<span class="comment">// 将对应 Bean 放入责任链上下文容器中</span></span><br><span class="line">        chainFilterMap.forEach((beanName, bean) -&gt; orderCreateChainHandlerContainer.add(bean););</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现 <code>OrderCreateChainHandler</code> 接口作为责任链处理器，每个具体的实现类负责执行特定的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单创建参数必填检验</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateParamNotNullChainHandler</span> <span class="keyword">implements</span> <span class="title class_">OrderCreateChainHandler</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">	    <span class="comment">// 逻辑执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单创建参数正确性检验</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateParamVerificationChainHandler</span> <span class="keyword">implements</span> <span class="title class_">OrderCreateChainHandler</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">	    <span class="comment">// 逻辑执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单创建商品 SKU 库存验证</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateProductSkuStockChainHandler</span> <span class="keyword">implements</span> <span class="title class_">OrderCreateChainHandler</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">	    <span class="comment">// 逻辑执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过责任链模式优化，创建订单接口前置校验代码从上千行缩减为一行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderCreateChainContext&lt;OrderCreateCommand&gt; orderCreateChainContext;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOrder</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">        <span class="comment">// 责任链模式: 执行订单创建参数验证</span></span><br><span class="line">        orderCreateChainContext.handler(requestParam);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="责任链抽象"><a href="#责任链抽象" class="headerlink" title="责任链抽象"></a>责任链抽象</h5><p>当业务使用越来越多的情况下，重复定义 <code>OrderCreateChainHandler</code> 以及 <code>OrderCreateChainContext</code> 会增加系统冗余代码量。</p>
<p>可以考虑将这两个基础类抽象出来，作为基础组件库中的通用组件，供所有系统下的业务使用，从而避免代码冗余。</p>
<p>定义抽象责任链处理接口，等同于 <code>OrderCreateChainHandler</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AbstractChainHandler</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Ordered</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行责任链逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestParam 责任链执行入参</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(T requestParam)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 责任链组件标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">mark</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mark</code> 方法是做什么的？接口增加 <code>mark</code> 方法，以便不同业务使用不同的标识。</p>
<p>假设项目中有两个业务场景：订单下单和用户创建都需要责任链模式去验证，<code>mark</code> 就是用来进行分组，在业务中进行调用责任链时传递不同的 <code>mark</code> 方法参数，通过该参数找到对应的一组责任链具体实现类集合。</p>
<p>定义抽象责任链上下文，等同于 <code>OrderCreateChainContext</code>。可以看到保存责任链处理类的容器从 List 改为了 Map，这样可以方便扩展更多的不同业务责任链子类。</p>
<p>通过实现 <code>CommandLineRunner</code> 接口在 SpringBoot 启动完成后，执行钩子函数将所有实现责任链抽象接口的实现类进行注册到责任链上下文中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">AbstractChainContext</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;AbstractChainHandler&gt;&gt; abstractChainHandlerContainer = Maps.newHashMap();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 责任链组件执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestParam 请求参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(String mark, T requestParam)</span> &#123;</span><br><span class="line">        abstractChainHandlerContainer.get(mark).stream()</span><br><span class="line">                .sorted(Comparator.comparing(Ordered::getOrder)).forEach(each -&gt; each.handler(requestParam));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取 Spring IOC 容器中所有 AbstractChainHandler 接口实现</span></span><br><span class="line">        Map&lt;String, AbstractChainHandler&gt; chainFilterMap = ApplicationContextHolder.getBeansOfType(AbstractChainHandler.class);</span><br><span class="line">        chainFilterMap.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">            List&lt;AbstractChainHandler&gt; abstractChainHandlers = abstractChainHandlerContainer.get(bean.mark());</span><br><span class="line">            <span class="keyword">if</span> (abstractChainHandlers == <span class="literal">null</span>) &#123;</span><br><span class="line">                abstractChainHandlers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            abstractChainHandlers.add(bean);</span><br><span class="line">            <span class="comment">// 根据 mark 标识将责任链模式分类，放入责任链容器上下文中</span></span><br><span class="line">            abstractChainHandlerContainer.put(bean.mark(), abstractChainHandlers);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="抽象业务接口"><a href="#抽象业务接口" class="headerlink" title="抽象业务接口"></a>抽象业务接口</h6><p>这里就是具体业务的责任链过滤器了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单创建责任链过滤器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderCreateChainFilter</span>&lt;T <span class="keyword">extends</span> <span class="title class_">OrderCreateCommand</span>&gt; <span class="keyword">extends</span> <span class="title class_">AbstractChainHandler</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">mark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OrderChainMarkEnum.ORDER_CREATE_FILTER.name();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，如果没有 <code>OrderCreateChainFilter</code> 接口，会是什么样的场景？</p>
<ul>
<li>由于责任链处理子类都需要依赖顶级抽象接口，因此要想知道某个业务场景下有多少具体子类是相当困难的。</li>
<li>由于责任链处理子类都需要实现 Mark 方法，实际上某一类责任链子类的 Mark 方法返回值是相同的。</li>
</ul>
<p>通过在业务层面上抽象出一个具体业务责任链接口，就能很好地解决上述两个问题。</p>
<p>现在，让我们继续探讨责任链子类的编写。实际上，改动并不多，只需要将之前的  <code>OrderCreateChainHandler</code>  实现接口改为  <code>OrderCreateChainFilter</code>  即可。</p>
<p>也就是说，我们在顶层handler和底层具体handler方法之间，<strong>加了一层OrderCreateChainFilter</strong>用来承上启下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单创建参数必填检验</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateParamNotNullChainHandler</span> <span class="keyword">implements</span> <span class="title class_">OrderCreateChainFilter</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">    	<span class="comment">// 逻辑执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单创建参数正确性检验</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateParamVerificationChainHandler</span> <span class="keyword">implements</span> <span class="title class_">OrderCreateChainFilter</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">    	<span class="comment">// 逻辑执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订单创建商品 SKU 库存验证</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">OrderCreateProductSkuStockChainHandler</span> <span class="keyword">implements</span> <span class="title class_">OrderCreateChainFilter</span>&lt;OrderCreateCommand&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">    	<span class="comment">// 逻辑执行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在具体业务场景中使用时，与之前相比并没有太大的差别。除了增加了 Mark 标识外，没有进行其他变更。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AbstractChainContext&lt;OrderCreateCommand&gt; abstractChainContext;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOrder</span><span class="params">(OrderCreateCommand requestParam)</span> &#123;</span><br><span class="line">        <span class="comment">// 责任链模式: 执行订单创建参数验证</span></span><br><span class="line">        abstractChainContext.handler(OrderChainMarkEnum.ORDER_CREATE_FILTER.name(), requestParam);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-封装策略模式"><a href="#3-封装策略模式" class="headerlink" title="3. 封装策略模式"></a>3. 封装策略模式</h3><p>策略模式还是比较简单并且使用较多的，平常我们多运用策略模式用来消除 if-else、switch 等多重判断的代码，消除 if-else、switch 多重判断 <strong>可以有效应对代码的复杂性。</strong></p>
<p>如果分支判断会不断变化（增、删、改），那么可以使用别的技巧让其满足开闭原则，提高代码的扩展性 （策略模式场景主要负责解耦，开闭原则需要额外支持）。</p>
<p>。下述代码可能大家都能联想出对应的业务，<strong>根据对应的优惠类型，对价格作出相应的优惠。</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEB4P8e"><img src="https://s21.ax1x.com/2025/03/25/pEB4P8e.png" alt="pEB4P8e.png"></a></p>
<p>这段代码是能够满足项目中业务需求的，而且很多已上线生产环境的代码也有这类代码。但是，这一段代码存在存在两个弊端：</p>
<ol>
<li>代码的复杂性，正常业务代码逻辑肯定会比这个代码块复杂很多，这也就 <strong>导致了 if-else 的分支以及代码数量过多</strong>。这种方式可以通过将代码拆分成独立函数或者拆分成类来解决。</li>
<li>开闭原则，价格优惠肯定会 <strong>随着不同的时期作出不同的改变</strong>，或许新增、删除或修改。如果在一个函数中修改无疑是件恐怖的事情，想想可能多个开发者分别进行开发，杂乱无章的注释，混乱的代码逻辑等情况十有八九会发生。</li>
</ol>
<p>如何运用策略模式优化上述代码，使程序设计看着简约、可扩展等特性。</p>
<ol>
<li>简化代码的复杂性，将不同的优惠类型定义为不同的策略算法实现类。</li>
<li>保证开闭原则，增加程序的健壮性以及可扩展性。</li>
</ol>
<h4 id="策略模式示例"><a href="#策略模式示例" class="headerlink" title="策略模式示例"></a>策略模式示例</h4><p>将上述代码块改造为策略设计模式，大致需要三个步骤。</p>
<ol>
<li>定义抽象策略接口，因为业务使用接口而不是具体的实现类的话，便可以灵活的替换不同的策略；</li>
<li>定义具体策略实现类，实现自抽象策略接口，其内部封装具体的业务实现；</li>
<li>定义策略工厂，封装创建策略实现（算法），对客户端屏蔽具体的创建细节。</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEB4igH"><img src="https://s21.ax1x.com/2025/03/25/pEB4igH.png" alt="pEB4igH.png"></a></p>
<p>目前把抽象策略接口、具体的策略实现类以及策略工厂都已经创建了，现在可以看一下客户端需要如何调用，又是如何对客户端屏蔽具体实现细节的。</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEB4mUf"><img src="https://s21.ax1x.com/2025/03/25/pEB4mUf.png" alt="pEB4mUf.png"></a></p>
<p>根据代码块图片得知，具体策略类是从策略工厂中获取，确实是取消了 if-else 设计，<strong>在工厂中使用 Map 存储策略实现</strong>。获取到策略类后执行具体的优惠策略方法就可以获取优惠后的金额。</p>
<p>通过分析大家得知，目前这种设计确实将应用代码的复杂性降低了。<strong>如果新增一个优惠策略，只需要新增一个策略算法实现类即可</strong>。但是，添加一个策略算法实现，<strong>意味着需要改动策略工厂中的代码</strong>，还是不符合开闭原则。</p>
<p>如何完整实现符合开闭原则的策略模式，需要借助 Spring 的帮助，详细案例请继续往下看。</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEB48rn"><img src="https://s21.ax1x.com/2025/03/25/pEB48rn.png" alt="pEB48rn.png"></a></p>
<p>可以看到，比对上面的示例代码，有两处明显的变化：</p>
<ol>
<li>抽象策略接口中，新定义了 mark() 接口，此接口用来标示算法的唯一性；</li>
<li>具体策略实现类，使用 @Component  修饰，将对象本身交由 Spring 进行管理</li>
</ol>
<p>接下来继续查看抽象策略工厂如何改造，才能满足开闭原则</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEB4YV0"><img src="https://s21.ax1x.com/2025/03/25/pEB4YV0.png" alt="pEB4YV0.png"></a></p>
<p>和之前责任链模式相同 （TODO 添加链接），都是通过 InitializingBean 接口实现中调用 IOC 容器查找对应策略实现，随后将策略实现 mark() 方法返回值作为 key， 策略实现本身作为 value 添加到 Map 容器中等待客户端的调用。</p>
<p>这里使用的 SpringBoot 测试类，注入策略工厂 Bean，通过策略工厂选择出具体的策略算法类，继而通过算法获取到优惠后的价格。</p>
<h1 id="公共组件库"><a href="#公共组件库" class="headerlink" title="公共组件库"></a>公共组件库</h1><h2 id="组件地址-4"><a href="#组件地址-4" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-common-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述-3"><a href="#组件概述-3" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>抽象常用枚举码值，比如：删除标记枚举、标识枚举、操作类型以及状态枚举等。</li>
<li>封装线程池相关功能，比如：线程池构造器、快速执行线程池、动态代理拒绝策略等。</li>
<li>常用工具类，比如：断言类、对象复制工具类、环境类以及线程工具类等。</li>
</ol>
<h2 id="组件功能-4"><a href="#组件功能-4" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-抽象常用枚举"><a href="#1-抽象常用枚举" class="headerlink" title="1. 抽象常用枚举"></a>1. 抽象常用枚举</h3><h3 id="1-抽象常用枚举-1"><a href="#1-抽象常用枚举-1" class="headerlink" title="1. 抽象常用枚举"></a>1. 抽象常用枚举</h3><p>枚举在日常开发项目中占着比较重要的位置，有一些每个项目都要用到的枚举可以尝试抽象出来，避免重复创建。比如说，逻辑删除枚举等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.common.enums;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除标记枚举</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DelEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正常状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NORMAL(<span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DELETE(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer statusCode;</span><br><span class="line"></span><br><span class="line">    DelEnum(Integer statusCode) &#123;</span><br><span class="line">        <span class="built_in">this</span>.statusCode = statusCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.statusCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">strCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(<span class="built_in">this</span>.statusCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> strCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-封装线程池"><a href="#2-封装线程池" class="headerlink" title="2. 封装线程池"></a>2. 封装线程池</h3><p>线程池封装这里，有两个比较有意思的功能。一个是封装快速消费线程池，另一个就是通过动态代理实现拒绝策略的扩展。</p>
<p>1）快速消费线程池。</p>
<p>首先定义快速消费线程池的阻塞队列，不能使用原有的常用队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.common.threadpool.support.eager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RejectedExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 快速消费任务队列</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskQueue</span>&lt;R <span class="keyword">extends</span> <span class="title class_">Runnable</span>&gt; <span class="keyword">extends</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> EagerThreadPoolExecutor executor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(capacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">currentPoolThreadSize</span> <span class="operator">=</span> executor.getPoolSize();</span><br><span class="line">        <span class="comment">// 如果有核心线程正在空闲，将任务加入阻塞队列，由核心线程进行处理任务</span></span><br><span class="line">        <span class="keyword">if</span> (executor.getSubmittedTaskCount() &lt; currentPoolThreadSize) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.offer(runnable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当前线程池线程数量小于最大线程数，返回 False，根据线程池源码，会创建非核心线程</span></span><br><span class="line">        <span class="keyword">if</span> (currentPoolThreadSize &lt; executor.getMaximumPoolSize()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前线程池数量大于最大线程数，任务加入阻塞队列</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.offer(runnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">retryOffer</span><span class="params">(Runnable o, <span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (executor.isShutdown()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Executor is shutdown!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.offer(o, timeout, unit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义快速消费线程池，这里参考了 Dubbo 的线程池模型之一。另外，Tomcat 也是这种消费模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.common.threadpool.support.eager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RejectedExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RejectedExecutionHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 快速消费线程池</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EagerThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">ThreadPoolExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EagerThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                                   <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                                   TimeUnit unit,</span></span><br><span class="line"><span class="params">                                   TaskQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                                   ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                                   RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">submittedTaskCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSubmittedTaskCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> submittedTaskCount.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123;</span><br><span class="line">        submittedTaskCount.decrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        submittedTaskCount.incrementAndGet();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.execute(command);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class="line">            <span class="type">TaskQueue</span> <span class="variable">taskQueue</span> <span class="operator">=</span> (TaskQueue) <span class="built_in">super</span>.getQueue();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!taskQueue.retryOffer(command, <span class="number">0</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">                    submittedTaskCount.decrementAndGet();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Queue capacity is full.&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException iex) &#123;</span><br><span class="line">                submittedTaskCount.decrementAndGet();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(iex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            submittedTaskCount.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）动态代理扩展线程池拒绝策略。</p>
<p>定义动态代理类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.common.threadpool.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池拒绝策略代理执行器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RejectedProxyInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Target object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reject count</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong rejectCount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        rejectCount.incrementAndGet();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;线程池执行拒绝策略, 此处模拟报警...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次去创建动态代理类的方法也比较麻烦，我们提供一个动态代理类创建的工具类。</p>
<p>并附带单元测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.common.threadpool.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AccessLevel;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.common.toolkit.ThreadUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RejectedExecutionHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒绝策略代理工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NoArgsConstructor(access = AccessLevel.PRIVATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RejectedProxyUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建拒绝策略代理类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rejectedExecutionHandler 真正的线程池拒绝策略执行器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rejectedNum              拒绝策略执行统计器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 代理拒绝策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RejectedExecutionHandler <span class="title function_">createProxy</span><span class="params">(RejectedExecutionHandler rejectedExecutionHandler, AtomicLong rejectedNum)</span> &#123;</span><br><span class="line">        <span class="comment">// 动态代理模式: 增强线程池拒绝策略，比如：拒绝任务报警或加入延迟队列重复放入等逻辑</span></span><br><span class="line">        <span class="keyword">return</span> (RejectedExecutionHandler) Proxy</span><br><span class="line">                .newProxyInstance(</span><br><span class="line">                        rejectedExecutionHandler.getClass().getClassLoader(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;RejectedExecutionHandler.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">RejectedProxyInvocationHandler</span>(rejectedExecutionHandler, rejectedNum));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试线程池拒绝策略动态代理程序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">1024</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        ThreadPoolExecutor.<span class="type">AbortPolicy</span> <span class="variable">abortPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();</span><br><span class="line">        <span class="type">AtomicLong</span> <span class="variable">rejectedNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line">        <span class="type">RejectedExecutionHandler</span> <span class="variable">proxyRejectedExecutionHandler</span> <span class="operator">=</span> RejectedProxyUtil.createProxy(abortPolicy, rejectedNum);</span><br><span class="line">        threadPoolExecutor.setRejectedExecutionHandler(proxyRejectedExecutionHandler);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                threadPoolExecutor.execute(() -&gt; ThreadUtil.sleep(<span class="number">100000L</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">                ignored.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;================ 线程池拒绝策略执行次数: &quot;</span> + rejectedNum.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="持久层组件库"><a href="#持久层组件库" class="headerlink" title="持久层组件库"></a>持久层组件库</h1><h2 id="组件地址-5"><a href="#组件地址-5" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-database-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述-4"><a href="#组件概述-4" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>封装通用分页组件。</li>
<li>封装数据持久层基础属性。</li>
<li>封装元数据处理器。</li>
<li>封装分页工具转换器。</li>
<li>封装自定义雪花算法。</li>
</ol>
<h2 id="组件功能-5"><a href="#组件功能-5" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-通用分页组件"><a href="#1-通用分页组件" class="headerlink" title="1. 通用分页组件"></a>1. 通用分页组件</h3><p>定义 MySQL 分页插件配置，避免每个项目都需要重新定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.database.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.incrementer.IdentifierGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.database.handler.CustomIdGenerator;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.database.handler.MyMetaObjectHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MybatisPlus 配置文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-实体基础属性"><a href="#2-实体基础属性" class="headerlink" title="2. 实体基础属性"></a>2. 实体基础属性</h3><p>因为每个表都有公共的一些属性，比如创建时间、修改时间以及是否逻辑删除标识。</p>
<p>避免每个实体上都重复定义，我们在持久层对象中抽象一个基础的 BaseDO 杜绝上述重复行为。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.database.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据持久层基础属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseDO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除标志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> Integer delFlag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-元数据处理器"><a href="#3-元数据处理器" class="headerlink" title="3. 元数据处理器"></a>3. 元数据处理器</h3><p>MyBatisPlus 为我们提供了一种便利的方式为这些实体基础属性赋值，那就是元数据处理器。</p>
<p>可在数据新增或修改，再或者新增和修改时对元数据进行变更。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.database.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.common.enums.DelEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 元数据处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title class_">MetaObjectHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据新增时填充</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaObject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;createTime&quot;</span>, Date.class, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, Date.class, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;delFlag&quot;</span>, Integer.class, DelEnum.NORMAL.code());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据修改时填充</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaObject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strictInsertFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, Date.class, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-分页转换器"><a href="#4-分页转换器" class="headerlink" title="4. 分页转换器"></a>4. 分页转换器</h3><p>这里提供 MyBatisPlus 的分页对象和规约分页对象的数据和类型转换工具类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.database.toolkit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.IPage;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.common.toolkit.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.page.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.page.PageResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> PageRequest&#125; to &#123;<span class="doctag">@link</span> Page&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Page <span class="title function_">convert</span><span class="params">(PageRequest pageRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> convert(pageRequest.getCurrent(), pageRequest.getSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> PageRequest&#125; to &#123;<span class="doctag">@link</span> Page&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Page <span class="title function_">convert</span><span class="params">(<span class="type">long</span> current, <span class="type">long</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Page</span>(current, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> IPage&#125; to &#123;<span class="doctag">@link</span> PageResponse&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PageResponse <span class="title function_">convert</span><span class="params">(IPage iPage)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buildConventionPage(iPage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> IPage&#125; to &#123;<span class="doctag">@link</span> PageResponse&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;TARGET, ORIGINAL&gt; PageResponse&lt;TARGET&gt; <span class="title function_">convert</span><span class="params">(IPage&lt;ORIGINAL&gt; iPage, Class&lt;TARGET&gt; targetClass)</span> &#123;</span><br><span class="line">        iPage.convert(each -&gt; BeanUtil.convert(each, targetClass));</span><br><span class="line">        <span class="keyword">return</span> buildConventionPage(iPage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> IPage&#125; to &#123;<span class="doctag">@link</span> PageResponse&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;TARGET, ORIGINAL&gt; PageResponse&lt;TARGET&gt; <span class="title function_">convert</span><span class="params">(IPage&lt;ORIGINAL&gt; iPage, Function&lt;? <span class="built_in">super</span> ORIGINAL, ? extends TARGET&gt; mapper)</span> &#123;</span><br><span class="line">        List&lt;TARGET&gt; targetDataList = iPage.getRecords().stream()</span><br><span class="line">                .map(mapper)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> PageResponse.&lt;TARGET&gt;builder()</span><br><span class="line">                .current(iPage.getCurrent())</span><br><span class="line">                .size(iPage.getSize())</span><br><span class="line">                .records(targetDataList)</span><br><span class="line">                .total(iPage.getTotal())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> IPage&#125; build to &#123;<span class="doctag">@link</span> PageResponse&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> PageResponse <span class="title function_">buildConventionPage</span><span class="params">(IPage iPage)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PageResponse.builder()</span><br><span class="line">                .current(iPage.getCurrent())</span><br><span class="line">                .size(iPage.getSize())</span><br><span class="line">                .records(iPage.getRecords())</span><br><span class="line">                .total(iPage.getTotal())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-自定义雪花算法"><a href="#5-自定义雪花算法" class="headerlink" title="5. 自定义雪花算法"></a>5. 自定义雪花算法</h3><p>定义雪花算法类，并替换 MyBatisPlus 原有的雪花 ID 生成器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.database.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.incrementer.IdentifierGenerator;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.distributedid.toolkit.SnowflakeIdUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义雪花算法生成器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdentifierGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Number <span class="title function_">nextId</span><span class="params">(Object entity)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SnowflakeIdUtil.nextId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置类中声明 <code>@Primary</code> 上述雪花算法生成器是主要的，不再使用默认的雪花 ID 生成器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.database.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.incrementer.IdentifierGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.database.handler.CustomIdGenerator;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.database.handler.MyMetaObjectHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MybatisPlus 配置文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义雪花算法 ID 生成器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> IdentifierGenerator <span class="title function_">idGenerator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomIdGenerator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="如何生成分布式雪花算法ID"><a href="#如何生成分布式雪花算法ID" class="headerlink" title="如何生成分布式雪花算法ID"></a>如何生成分布式雪花算法ID</h1><p>分布式系统中，有一些需要使用全局唯一 ID 的场景，这种时候为了防止 ID 冲突可以使用 36 位的 UUID，但是 UUID 有一些缺点，首先他相对比较长，另外 UUID 一般是无序的。</p>
<p>有些时候我们希望能使用一种简单些的 ID，并且希望 ID 能够按照时间有序生成。</p>
<h2 id="什么是雪花算法"><a href="#什么是雪花算法" class="headerlink" title="什么是雪花算法"></a>什么是雪花算法</h2><p>Snowflake 中文的意思是雪花，所以常被称为雪花算法，是 Twitter 开源的分布式 ID 生成算法。</p>
<p>Twitter 雪花算法生成后是一个 64bit 的 long 型的数值，组成部分引入了时间戳，基本保持了自增。</p>
<p><strong>SnowFlake 算法的优点：</strong></p>
<ol>
<li>高性能高可用：生成时不依赖于数据库，完全在内存中生成。</li>
<li>高吞吐：每秒钟能生成数百万的自增 ID。</li>
<li>ID 自增：存入数据库中，索引效率高。</li>
</ol>
<p><strong>SnowFlake 算法的缺点：</strong></p>
<p>依赖与系统时间的一致性，如果系统时间被回调，或者改变，可能会造成 ID 冲突或者重复</p>
<h3 id="1-雪花算法组成"><a href="#1-雪花算法组成" class="headerlink" title="1. 雪花算法组成"></a>1. 雪花算法组成</h3><p>包含四个组成部分：</p>
<p><strong>不使用</strong>：1bit，最高位是符号位，0 表示正，1 表示负，固定为 0。</p>
<p><strong>时间戳</strong>：41bit，毫秒级的时间戳（41 位的长度可以使用 69 年）。</p>
<p><strong>标识位</strong>：5bit 数据中心 ID，5bit 工作机器 ID，两个标识位组合起来最多可以支持部署 1024 个节点。</p>
<p><strong>序列号</strong>：12bit 递增序列号，表示节点毫秒内生成重复，通过序列号表示唯一，12bit 每毫秒可产生 4096 个 ID。</p>
<p>通过序列号 1 毫秒可以产生 4096 个不重复 ID，则 1 秒可以生成 4096 * 1000 &#x3D; 409w ID。</p>
<p>默认的雪花算法是 64 bit，具体的长度可以自行配置。如果希望运行更久，<strong>增加时间戳的位数</strong>；如果需要支持更多节点部署，<strong>增加标识位长度</strong>；如果并发很高，<strong>增加序列号位数。</strong></p>
<p><strong>总结</strong>：雪花算法并不是一成不变的，可以根据系统内具体场景进行定制。</p>
<h3 id="2-雪花算法适用场景"><a href="#2-雪花算法适用场景" class="headerlink" title="2. 雪花算法适用场景"></a>2. 雪花算法适用场景</h3><p>因为雪花算法有序自增，保障了 MySQL 中 B+ Tree 索引结构插入高性能。</p>
<p>所以，日常业务使用中，雪花算法更多是被应用在数据库的主键 ID 和业务关联主键。</p>
<h2 id="雪花算法生成-ID-重复问题"><a href="#雪花算法生成-ID-重复问题" class="headerlink" title="雪花算法生成 ID 重复问题"></a>雪花算法生成 ID 重复问题</h2><p><strong>假设</strong>：一个订单微服务，通过雪花算法生成 ID，共部署三个节点，标识位一致。</p>
<p>此时有 200 并发，均匀散布三个节点，三个节点同一毫秒同一序列号下生成 ID，那么就会产生重复 ID。</p>
<p>通过上述假设场景，可以知道雪花算法生成 ID 冲突存在一定的前提条件：</p>
<ol>
<li>服务通过集群的方式部署，其中部分机器标识位一致。</li>
<li>业务存在一定的并发量，没有并发量无法触发重复问题。</li>
<li>生成 ID 的时机：同一毫秒下的序列号一致。</li>
</ol>
<h3 id="1-标识位如何定义"><a href="#1-标识位如何定义" class="headerlink" title="1. 标识位如何定义"></a>1. 标识位如何定义</h3><p>如果能保证标识位不重复，那么雪花 ID 也不会重复。</p>
<p>通过上面的案例，知道了 ID 重复的必要条件。如果要避免服务内产生重复的 ID，那么就需要从标识位上动文章。</p>
<p>我们先看看开源框架中使用雪花算法，如何定义标识位。</p>
<p>Mybatis-Plus v3.4.2 雪花算法实现类 Sequence，提供了两种构造方法：无参构造，自动生成 dataCenterId 和 workerId；有参构造，创建 Sequence 时明确指定标识位。</p>
<p>Hutool v5.7.9 参照了 Mybatis-Plus dataCenterId 和 workerId 生成方案，提供了默认实现</p>
<p>一起看下 Sequence 的创建默认无参构造，如何生成 dataCenterId 和 workerId。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getDataCenterId</span><span class="params">(<span class="type">long</span> maxDatacenterId)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] mac = NetUtil.getLocalHardwareAddress();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != mac) &#123;</span><br><span class="line">        id = ((<span class="number">0x000000FF</span> &amp; (<span class="type">long</span>) mac[mac.length - <span class="number">2</span>])</span><br><span class="line">                | (<span class="number">0x0000FF00</span> &amp; (((<span class="type">long</span>) mac[mac.length - <span class="number">1</span>]) &lt;&lt; <span class="number">8</span>))) &gt;&gt; <span class="number">6</span>;</span><br><span class="line">        id = id % (maxDatacenterId + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>入参 <code>maxDatacenterId</code> 是一个固定值，代表数据中心 ID 最大值，默认值 31。</p>
<p>为什么最大值要是 31？因为 5bit 的二进制最大是 11111，对应十进制数值 31。</p>
<p>获取 dataCenterId 时存在两种情况，一种是网络接口为空，默认取 1L；另一种不为空，通过 Mac 地址获取 dataCenterId。</p>
<p>可以得知，dataCenterId 的取值与 Mac 地址有关。</p>
<p>接下来再看看 workerId</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getWorkerId</span><span class="params">(<span class="type">long</span> datacenterId, <span class="type">long</span> maxWorkerId)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">mpid</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    mpid.append(datacenterId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mpid.append(RuntimeUtil.getPid());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UtilException igonre) &#123;</span><br><span class="line">        <span class="comment">//ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (mpid.toString().hashCode() &amp; <span class="number">0xffff</span>) % (maxWorkerId + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>入参 maxWorkderId 也是一个固定值，代表工作机器 ID 最大值，默认值 31；datacenterId 取自上述的 getDatacenterId 方法。</p>
<p>name 变量值为 <code>PID@IP</code>，所以 name 需要根据 <code>@</code> 分割并获取下标 0，得到 PID。</p>
<p>通过 MAC + PID 的 hashcode 获取 16 个低位，进行运算，最终得到 workerId。</p>
<h3 id="2-分配标识位"><a href="#2-分配标识位" class="headerlink" title="2. 分配标识位"></a>2. 分配标识位</h3><p>Mybatis-Plus 标识位的获取依赖 Mac 地址和进程 PID，虽然能做到尽量不重复，但仍有小几率。</p>
<p>标识位如何定义才能不重复？有两种方案：<strong>预分配和动态分配。</strong></p>
<p><strong>预分配</strong></p>
<p>应用上线前，统计当前服务的节点数，人工去申请标识位。</p>
<p>这种方案，没有代码开发量，在服务节点固定或者项目少可以使用，但是解决不了服务节点动态扩容性问题。</p>
<p><strong>动态分配</strong></p>
<p>通过将标识位存放在 Redis、Zookeeper、MySQL 等中间件，在服务启动的时候去请求标识位，请求后标识位更新为下一个可用的。</p>
<p>通过存放标识位，延伸出一个问题：雪花算法的 ID 是 <strong>服务内唯一还是全局唯一。</strong></p>
<p>以 Redis 举例，如果要做服务内唯一，存放标识位的 Redis 节点使用自己项目内的就可以；如果是全局唯一，所有使用雪花算法的应用，要用同一个 Redis 节点。</p>
<p>两者的区别仅是 <strong>不同的服务间是否公用 Redis</strong>。如果没有全局唯一的需求，最好使 ID 服务内唯一，因为这样可以避免单点问题。</p>
<p>服务的节点数超过 1024，则需要做额外的扩展；可以扩展 10 bit 标识位，或者选择开源分布式 ID 框架。</p>
<p><strong>动态分配实现方案</strong></p>
<p>Redis 存储一个 Hash 结构 Key，包含两个键值对：dataCenterId 和 workerId。</p>
<p>在应用启动时，通过 Lua 脚本去 Redis 获取标识位。dataCenterId 和 workerId 的获取与自增在 Lua 脚本中完成，调用返回后就是可用的标示位。</p>
<p>具体 Lua 脚本逻辑如下：</p>
<ol>
<li>第一个服务节点在获取时，Redis 可能是没有 snowflake_work_id_key 这个 Hash 的，应该先判断 Hash 是否存在，不存在初始化 Hash，dataCenterId、workerId 初始化为 0。</li>
<li>如果 Hash 已存在，判断 dataCenterId、workerId 是否等于最大值 31，满足条件初始化 dataCenterId、workerId 设置为 0 返回。</li>
<li>dataCenterId 和 workerId 的排列组合一共是 1024，在进行分配时，先分配 workerId。</li>
<li>判断 workerId 是否 !&#x3D; 31，条件成立对 workerId 自增，并返回；如果 workerId &#x3D; 31，自增 dataCenterId 并将 workerId 设置为 0。</li>
</ol>
<p>dataCenterId、workerId 是一直向下推进的，总体形成一个环状。通过 <strong>Lua 脚本的原子性</strong>，保证 1024 节点下的雪花算法生成不重复。如果标识位等于 1024，则从头开始继续循环推进</p>
<h1 id="分布式id组件库"><a href="#分布式id组件库" class="headerlink" title="分布式id组件库"></a>分布式id组件库</h1><h2 id="组件地址-6"><a href="#组件地址-6" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-distributedid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述-5"><a href="#组件概述-5" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>实现分布式唯一雪花算法 ID 生成器。</li>
<li>封装分布式唯一雪花算法 ID 工具类。</li>
<li>封装分库或分表基因算法工具类。</li>
</ol>
<h2 id="组件功能-6"><a href="#组件功能-6" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-雪花算法生成器"><a href="#1-雪花算法生成器" class="headerlink" title="1. 雪花算法生成器"></a>1. 雪花算法生成器</h3><p>首先，雪花算法生成器是为了解决工作机器 ID 重复问题。通过分配抢占的方式获取机器 ID，存储机器 ID 的位置就是个比较难选择的事情。</p>
<p>默认是通过 Redis 缓存存储，但是当项目中没有 Redis 时，采用随机数方式获取机器 ID。</p>
<p>1）定义雪花算法获取机器 ID 模板抽象类。</p>
<p>采用模板方法模式，获取 Redis 或者随机数提供的机器 ID。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.distributedid.core.snowflake;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.SystemClock;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.distributedid.toolkit.SnowflakeIdUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 雪花算法模板生成</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractWorkIdChooseTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否使用 &#123;<span class="doctag">@link</span> SystemClock&#125; 获取当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;framework.distributed.id.snowflake.is-use-system-clock:false&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isUseSystemClock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据自定义策略获取 WorkId 生成器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> WorkIdWrapper <span class="title function_">chooseWorkId</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 选择 WorkId 并初始化雪花</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">chooseAndInit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 模板方法模式: 通过抽象方法获取 WorkId 包装器创建雪花算法</span></span><br><span class="line">        <span class="type">WorkIdWrapper</span> <span class="variable">workIdWrapper</span> <span class="operator">=</span> chooseWorkId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">workId</span> <span class="operator">=</span> workIdWrapper.getWorkId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">dataCenterId</span> <span class="operator">=</span> workIdWrapper.getDataCenterId();</span><br><span class="line">        <span class="type">Snowflake</span> <span class="variable">snowflake</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Snowflake</span>(workId, dataCenterId, isUseSystemClock);</span><br><span class="line">        log.info(<span class="string">&quot;Snowflake type: &#123;&#125;, workId: &#123;&#125;, dataCenterId: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.getClass().getSimpleName(), workId, dataCenterId);</span><br><span class="line">        SnowflakeIdUtil.initSnowflake(snowflake);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）Redis 获取机器 ID 处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.distributedid.core.snowflake;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.bases.ApplicationContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scripting.support.ResourceScriptSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用 Redis 获取雪花 WorkId</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalRedisWorkIdChoose</span> <span class="keyword">extends</span> <span class="title class_">AbstractWorkIdChooseTemplate</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LocalRedisWorkIdChoose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = ApplicationContextHolder.getBean(StringRedisTemplate.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WorkIdWrapper <span class="title function_">chooseWorkId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultRedisScript</span> <span class="variable">redisScript</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">        redisScript.setScriptSource(<span class="keyword">new</span> <span class="title class_">ResourceScriptSource</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/chooseWorkIdLua.lua&quot;</span>)));</span><br><span class="line">        List&lt;Long&gt; luaResultList = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisScript.setResultType(List.class);</span><br><span class="line">            luaResultList = (ArrayList) <span class="built_in">this</span>.stringRedisTemplate.execute(redisScript, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Redis Lua 脚本获取 WorkId 失败&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CollUtil.isNotEmpty(luaResultList) ? <span class="keyword">new</span> <span class="title class_">WorkIdWrapper</span>(luaResultList.get(<span class="number">0</span>), luaResultList.get(<span class="number">1</span>)) : <span class="keyword">new</span> <span class="title class_">RandomWorkIdChoose</span>().chooseWorkId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        chooseAndInit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>底层通过 Redis Lua 保障原子性。</p>
<p>脚本返回的 <code>resultWorkId, resultDataCenterId</code> 就是雪花算法组成本分的机器 ID 标识部分。</p>
<p>翻译成java的lua脚本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">translateLuaScript</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Long&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">String</span> <span class="variable">hashKey</span> <span class="operator">=</span> <span class="string">&quot;snowflake_work_id_key&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dataCenterIdKey</span> <span class="operator">=</span> <span class="string">&quot;dataCenterId&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">workIdKey</span> <span class="operator">=</span> <span class="string">&quot;workId&quot;</span>;</span><br><span class="line">    HashOperations&lt;String, String, String&gt; hashOps = redisTemplate.opsForHash();</span><br><span class="line">    <span class="keyword">if</span> (!redisTemplate.hasKey(hashKey)) &#123;</span><br><span class="line">        hashOps.increment(hashKey, dataCenterIdKey, <span class="number">0L</span>);</span><br><span class="line">        hashOps.increment(hashKey, workIdKey, <span class="number">0L</span>);</span><br><span class="line">        result.add(<span class="number">0L</span>);</span><br><span class="line">        result.add(<span class="number">0L</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dataCenterIdStr</span> <span class="operator">=</span> hashOps.get(hashKey, dataCenterIdKey);</span><br><span class="line">    <span class="type">String</span> <span class="variable">workIdStr</span> <span class="operator">=</span> hashOps.get(hashKey, workIdKey);</span><br><span class="line">    <span class="type">long</span> <span class="variable">dataCenterId</span> <span class="operator">=</span> Long.parseLong(dataCenterIdStr != <span class="literal">null</span> ? dataCenterIdStr : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">workId</span> <span class="operator">=</span> Long.parseLong(workIdStr != <span class="literal">null</span> ? workIdStr : <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">31</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">resultWorkId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">resultDataCenterId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (dataCenterId == max &amp;&amp; workId == max) &#123;</span><br><span class="line">        hashOps.put(hashKey, dataCenterIdKey, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        hashOps.put(hashKey, workIdKey, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workId != max) &#123;</span><br><span class="line">        resultWorkId = hashOps.increment(hashKey, workIdKey, <span class="number">1L</span>);</span><br><span class="line">        resultDataCenterId = dataCenterId;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterId != max) &#123;</span><br><span class="line">        resultWorkId = <span class="number">0</span>;</span><br><span class="line">        resultDataCenterId = hashOps.increment(hashKey, dataCenterIdKey, <span class="number">1L</span>);</span><br><span class="line">        hashOps.put(hashKey, workIdKey, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.add(resultDataCenterId);</span><br><span class="line">    result.add(resultWorkId);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）随机数生成机器 ID 处理器。</p>
<p>整体比较简单，调用 Random 随机函数获取两个值。就不过多介绍</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.distributedid.core.snowflake;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用随机数获取雪花 WorkId</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomWorkIdChoose</span> <span class="keyword">extends</span> <span class="title class_">AbstractWorkIdChooseTemplate</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WorkIdWrapper <span class="title function_">chooseWorkId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>, end = <span class="number">31</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WorkIdWrapper</span>(getRandom(start, end), getRandom(start, end));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        chooseAndInit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getRandom</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">random</span> <span class="operator">=</span> (<span class="type">long</span>) (Math.random() * (end - start + <span class="number">1</span>) + start);</span><br><span class="line">        <span class="keyword">return</span> random;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-雪花算法工具类"><a href="#2-雪花算法工具类" class="headerlink" title="2. 雪花算法工具类"></a>2. 雪花算法工具类</h3><p>对象属性 <code>SNOWFLAKE</code> 是在 <code>AbstractWorkIdChooseTemplate</code> 获取到机器 ID 标识位后初始化的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.distributedid.toolkit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.distributedid.core.snowflake.Snowflake;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.distributedid.core.snowflake.SnowflakeIdInfo;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.distributedid.handler.IdGeneratorManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分布式雪花 ID 生成器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SnowflakeIdUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 雪花算法对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Snowflake SNOWFLAKE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化雪花算法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initSnowflake</span><span class="params">(Snowflake snowflake)</span> &#123;</span><br><span class="line">        SnowflakeIdUtil.SNOWFLAKE = snowflake;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取雪花算法实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Snowflake <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SNOWFLAKE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取雪花算法下一个 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SNOWFLAKE.nextId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取雪花算法下一个字符串类型 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">nextIdStr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.toString(nextId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析雪花算法生成的 ID 为对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SnowflakeIdInfo <span class="title function_">parseSnowflakeId</span><span class="params">(String snowflakeId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SNOWFLAKE.parseSnowflakeId(Long.parseLong(snowflakeId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析雪花算法生成的 ID 为对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SnowflakeIdInfo <span class="title function_">parseSnowflakeId</span><span class="params">(<span class="type">long</span> snowflakeId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SNOWFLAKE.parseSnowflakeId(snowflakeId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 &#123;<span class="doctag">@param</span> serviceId&#125; 生成雪花算法 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">nextIdByService</span><span class="params">(String serviceId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IdGeneratorManager.getDefaultServiceIdGenerator().nextId(Long.parseLong(serviceId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 &#123;<span class="doctag">@param</span> serviceId&#125; 生成字符串类型雪花算法 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">nextIdStrByService</span><span class="params">(String serviceId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IdGeneratorManager.getDefaultServiceIdGenerator().nextIdStr(Long.parseLong(serviceId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 &#123;<span class="doctag">@param</span> serviceId&#125; 生成字符串类型雪花算法 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">nextIdStrByService</span><span class="params">(String resource, <span class="type">long</span> serviceId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IdGeneratorManager.getIdGenerator(resource).nextIdStr(serviceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 &#123;<span class="doctag">@param</span> serviceId&#125; 生成字符串类型雪花算法 ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">nextIdStrByService</span><span class="params">(String resource, String serviceId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IdGeneratorManager.getIdGenerator(resource).nextIdStr(serviceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析雪花算法生成的 ID 为对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SnowflakeIdInfo <span class="title function_">parseSnowflakeServiceId</span><span class="params">(String snowflakeId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IdGeneratorManager.getDefaultServiceIdGenerator().parseSnowflakeId(Long.parseLong(snowflakeId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析雪花算法生成的 ID 为对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SnowflakeIdInfo <span class="title function_">parseSnowflakeServiceId</span><span class="params">(String resource, String snowflakeId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IdGeneratorManager.getIdGenerator(resource).parseSnowflakeId(Long.parseLong(snowflakeId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="幂等组件库"><a href="#幂等组件库" class="headerlink" title="幂等组件库"></a>幂等组件库</h1><h2 id="组件地址-7"><a href="#组件地址-7" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-idempotent-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述-6"><a href="#组件概述-6" class="headerlink" title="组件概述"></a>组件概述</h2><ul>
<li>实现消息队列 RocketMQ、Kafka、ActiveMQ、RabbitMQ 等客户端消费幂等。</li>
</ul>
<h2 id="什么是幂等问题？"><a href="#什么是幂等问题？" class="headerlink" title="什么是幂等问题？"></a>什么是幂等问题？</h2><p>先说下什么是幂等，幂等性是数学和计算机科学中的概念，用于描述操作无论执行多少次，都产生相同结果的特性。在软件行业中，广泛应用该概念。当我们说一个接口支持幂等性时，无论调用多少次，系统的结果都保持一致。</p>
<p>一般我们在系统中，幂等可能存在两种类型的问题：</p>
<ul>
<li>接口幂等：常说的接口防重复提交。</li>
<li>消息队列幂等：如何保障消息队列客户端对相同的消息仅消费一次。</li>
</ul>
<p>如果不做防重复提交或者幂等，可能会导致以下问题：</p>
<ol>
<li>数据重复处理：如果用户在某个操作还在处理中时重复提交请求，可能会导致相同的数据被处理多次，造成数据的重复操作和处理逻辑的错误。</li>
<li>重复写入：在某些场景下，请求可能触发对数据库或其他存储系统的写入操作。如果请求被重复提交，可能会导致相同的数据被重复写入，破坏数据的一致性。</li>
<li>资源浪费：重复提交请求可能会导致服务器资源的浪费。如果请求处理的时间较长，重复提交会占用服务器的处理能力，增加服务器的负载，降低系统的性能和吞吐量。</li>
<li>业务逻辑错误：在某些业务场景下，重复提交可能会导致业务逻辑错误。例如，如果用户在生成订单的过程中重复提交订单请求，可能会导致生成多个相同的订单，引发订单的混乱和错误。</li>
</ol>
<h3 id="1-接口防重复提交"><a href="#1-接口防重复提交" class="headerlink" title="1. 接口防重复提交"></a>1. 接口防重复提交</h3><p>举个例子，你在淘宝上下单某个商品，然后提交订单时由于你快速点击多次，或者网络波动提交服务端多次请求，如果淘宝服务端没有做相关防重复提交处理，那么就有可能生成多笔相同的订单。</p>
<p>如果做了幂等处理，除了第一次正常请求外，第二次乃至更多次应该返回错误，比如说提示语“重复提交失败”等；再或者返回“提交成功”，但是真正保存数据库的只有一次请求。具体使用哪一种需要看程序设计以及产品逻辑。</p>
<h3 id="2-消息队列消费幂等"><a href="#2-消息队列消费幂等" class="headerlink" title="2. 消息队列消费幂等"></a>2. 消息队列消费幂等</h3><p>消息队列在消息传递过程中，由于网络延迟、系统故障或其他异常情况，可能会导致消息被重复消费的问题。造成消息重复消费的问题比较多，我们就不细分析了，知道有这种场景就好。</p>
<p>通常情况下，我们认为消息中间件是一个可靠的组件。这里的可靠性指的是，只要消息被成功投递到了消息中间件，它就不会丢失，至少能够被消费者成功消费一次。这是消息中间件最基本的特性之一，也就是我们通常所说的 “AT LEAST ONCE”，即消息至少会被成功消费一遍。</p>
<p>这也就说明，如果服务端出现了客户端是否消费成功的疑问时，会让客户端再次消费。</p>
<p>造成的问题也比较明显，如果订单支付消息被重复消费，可能会导致业务逻辑的错误执行。例如，系统可能会多次发放优惠券、赠品或其他奖励，使得商家承担不必要的成本或资源浪费。</p>
<h2 id="如何解决幂等问题？"><a href="#如何解决幂等问题？" class="headerlink" title="如何解决幂等问题？"></a>如何解决幂等问题？</h2><p>说幂等底层代码设计前，先把各自问题场景的解决方案说说，主要涵盖分布式锁、Token 令牌以及去重表。</p>
<p>分布式锁和 Token 令牌应用于防重复提交，去重表应对于消息重复防重复消费场景。</p>
<h3 id="1-分布式锁"><a href="#1-分布式锁" class="headerlink" title="1. 分布式锁"></a>1. 分布式锁</h3><p>当用户提交请求时，服务器端可以生成一个唯一的标识，例如使用 UUID。</p>
<p>在处理用户请求之前，服务器尝试获取一个分布式锁。如果成功获取到分布式锁，那么则执行接下来的正常业务逻辑流程。因为锁已经被获取，这样可以确保其他请求无法使用相同的标识，避免重复处理。在请求处理完成后，服务器需要释放分布式锁。</p>
<h3 id="2-Token-令牌"><a href="#2-Token-令牌" class="headerlink" title="2. Token 令牌"></a>2. Token 令牌</h3><p>为了防止重复操作，客户端在第一次调用业务请求之前会发送一个获取 Token 的请求。服务端会生成一个全局唯一的 ID 作为 Token，并将其保存在 Redis 中，同时将该 ID 返回给客户端。</p>
<p>在客户端进行第二次业务请求时，必须携带这个 Token。</p>
<p>服务端会验证这个 Token，如果验证成功，则执行业务逻辑并从 Redis 中删除该 Token。</p>
<p>如果验证失败，说明 Redis 中已经没有对应的 Token，表示重复操作，服务端会直接返回指定的结果给客户端。</p>
<h3 id="3-去重表"><a href="#3-去重表" class="headerlink" title="3. 去重表"></a>3. 去重表</h3><p>去重表是指在使用 Redis 或者 MySQL 作为存储时，为了实现幂等性而用于记录已经处理过的请求或操作，以防止重复执行。大部分场景下，大家会使用 Redis 作为去重组件实现。</p>
<p>去重表只是一个说法，存储到 Redis 的话，其实就是一个 String 的 Key 而已。</p>
<p>具体来说，当客户端发送请求时，服务端会先查询 Redis 去重表来检查该请求是否已经被处理过。如果在存在对应的记录，表示请求已经执行过，服务端可以直接返回之，而不再执行重复操作。如果在不存在对应的记录，表示请求是新的，服务端会执行相应的业务逻辑，并在处理完成后将请求的唯一标识（如请求 ID 或标识）添加到 Redis 去重表中，以便后续的重复请求可以被正确识别和处理。</p>
<p>另外，如果消息已经在消费中，抛出异常，消息会触发延迟消费，在消息队列消费失败的场景下即发送到重试队列 <code>RETRY TOPIC</code>。</p>
<h2 id="幂等组件如何设计？"><a href="#幂等组件如何设计？" class="headerlink" title="幂等组件如何设计？"></a>幂等组件如何设计？</h2><p>上面说了多种解决方案，那我们一起看下幂等组件是怎么实现的吧。既然是组件化设计，自然需要用到 SpringBoot Starter，通过自动装配的机制完成整体运行。然后通过注解和 AOP 的形式进行实现。</p>
<h3 id="1-幂等注解"><a href="#1-幂等注解" class="headerlink" title="1. 幂等注解"></a>1. 幂等注解</h3><p>幂等设计可能存在通用的代码，为此，我们可以通过注解形式进行抽象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentSceneEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentTypeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等注解</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Idempotent &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 幂等Key，只有在 &#123;<span class="doctag">@link</span> Idempotent#type()&#125; 为 &#123;<span class="doctag">@link</span> IdempotentTypeEnum#SPEL&#125; 时生效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">key</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 触发幂等失败逻辑时，返回的错误提示信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;您操作太快，请稍后再试&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证幂等场景，支持多种 &#123;<span class="doctag">@link</span> IdempotentSceneEnum&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IdempotentSceneEnum <span class="title function_">scene</span><span class="params">()</span> <span class="keyword">default</span> IdempotentSceneEnum.RESTAPI;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证幂等类型，支持多种幂等方式</span></span><br><span class="line"><span class="comment">     * RestAPI 建议使用 &#123;<span class="doctag">@link</span> IdempotentTypeEnum#TOKEN&#125; 或 &#123;<span class="doctag">@link</span> IdempotentTypeEnum#PARAM&#125;</span></span><br><span class="line"><span class="comment">     * 其它类型幂等验证，使用 &#123;<span class="doctag">@link</span> IdempotentTypeEnum#SPEL&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IdempotentTypeEnum <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> IdempotentTypeEnum.PARAM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置防重令牌 Key 前缀，MQ 幂等去重可选设置</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> IdempotentSceneEnum#MQ&#125; and &#123;<span class="doctag">@link</span> IdempotentTypeEnum#SPEL&#125; 时生效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">uniqueKeyPrefix</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置防重令牌 Key 过期时间，单位秒，默认 1 小时，MQ 幂等去重可选设置</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> IdempotentSceneEnum#MQ&#125; and &#123;<span class="doctag">@link</span> IdempotentTypeEnum#SPEL&#125; 时生效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">keyTimeout</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">3600L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重要的字段有两个，<code>scene</code> 和 <code>type</code>。先说场景 <code>scene</code> 字段，该字段代表了是接口的防重复提交还是消息队列的防重复消费，通过一个枚举标识。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.enums;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等验证场景枚举</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">IdempotentSceneEnum</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于 RestAPI 场景验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RESTAPI,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于 MQ 场景验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MQ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是 type 字段，记录了使用什么方式实现幂等，其中 TOKEN 和 PARAM 以及 SPEL 都可以应用于接口防重复提交，SPEL 应用于消息队列防重复消费。</p>
<p>然后从分布式锁、Token 令牌以及去重表实现上来说，有个对应关系：</p>
<ul>
<li>分布式锁：PARAM 和 SPEL。</li>
<li>Token 令牌：TOKEN。</li>
<li>去重表：SPEL。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.enums;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等验证类型枚举</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">IdempotentTypeEnum</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于 Token 方式验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TOKEN,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于方法参数方式验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PARAM,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于 SpEL 表达式方式验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SPEL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-幂等-AOP"><a href="#2-幂等-AOP" class="headerlink" title="2. 幂等 AOP"></a>2. 幂等 AOP</h3><p>我们使用 AOP 技术为方法增强提供了通用的幂等性保证，只需要在需要保证幂等性的方法上添加 <code>@Idempotent</code> 注解，<code>Aspect</code> 就会对该方法进行增强。</p>
<p>简单来说，就是先获取到方法上的幂等注解，然后获取到对应的幂等处理实现类。通过实现类进行幂等前置逻辑，执行完后操作具体被注解修饰的方法，最终执行释放资源的后置逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等注解 AOP 拦截器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IdempotentAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强方法标记 &#123;<span class="doctag">@link</span> Idempotent&#125; 注解逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">idempotentHandler</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 获取到方法上的幂等注解实际数据</span></span><br><span class="line">        <span class="type">Idempotent</span> <span class="variable">idempotent</span> <span class="operator">=</span> getIdempotent(joinPoint);</span><br><span class="line">        <span class="comment">// 通过幂等场景以及幂等类型，获取幂等执行处理器</span></span><br><span class="line">        <span class="type">IdempotentExecuteHandler</span> <span class="variable">instance</span> <span class="operator">=</span> IdempotentExecuteHandlerFactory.getInstance(idempotent.scene(), idempotent.type());</span><br><span class="line">        Object resultObj;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行幂等处理逻辑</span></span><br><span class="line">            instance.execute(joinPoint, idempotent);</span><br><span class="line">            <span class="comment">// 如果幂等处理逻辑没有抛异常，处理中间业务</span></span><br><span class="line">            resultObj = joinPoint.proceed();</span><br><span class="line">            <span class="comment">// 处理幂等后置逻辑，比如释放资源或者锁之类的</span></span><br><span class="line">            instance.postProcessing();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RepeatConsumptionException ex) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 该异常为消息队列防重复提交独有，触发幂等逻辑时可能有两种情况：</span></span><br><span class="line"><span class="comment">             *    * 1. 消息还在处理，但是不确定是否执行成功，那么需要返回错误，方便 RocketMQ 再次通过重试队列投递</span></span><br><span class="line"><span class="comment">             *    * 2. 消息处理成功了，该消息直接返回成功即可</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!ex.getError()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// 客户端消费存在异常，需要删除幂等标识方便下次 RocketMQ 再次通过重试队列投递</span></span><br><span class="line">            instance.exceptionProcessing();</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 清理幂等容器上下文</span></span><br><span class="line">            IdempotentContext.clean();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultObj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Idempotent <span class="title function_">getIdempotent</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getDeclaredMethod(methodSignature.getName(), methodSignature.getMethod().getParameterTypes());</span><br><span class="line">        <span class="keyword">return</span> targetMethod.getAnnotation(Idempotent.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-获取幂等处理器"><a href="#2-1-获取幂等处理器" class="headerlink" title="2.1. 获取幂等处理器"></a>2.1. 获取幂等处理器</h4><p>针对不同幂等验证场景以及幂等处理类型拆分为了一个个策略模式处理器，帮助我们实现高内聚低耦合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.bases.ApplicationContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.param.IdempotentParamService;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.spel.IdempotentSpELByMQExecuteHandler;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.spel.IdempotentSpELByRestAPIExecuteHandler;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.token.IdempotentTokenService;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentSceneEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentTypeEnum;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等执行处理器工厂</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Q：可能会有同学有疑问：这里为什么要采用简单工厂模式？策略模式不行么？</span></span><br><span class="line"><span class="comment"> * A：策略模式同样可以达到获取真正幂等处理器功能。但是简单工厂的语意更适合这个场景，所以选择了简单工厂</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IdempotentExecuteHandlerFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取幂等执行处理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> scene 指定幂等验证场景类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type  指定幂等处理类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 幂等执行处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IdempotentExecuteHandler <span class="title function_">getInstance</span><span class="params">(IdempotentSceneEnum scene, IdempotentTypeEnum type)</span> &#123;</span><br><span class="line">        <span class="type">IdempotentExecuteHandler</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (scene) &#123;</span><br><span class="line">            <span class="keyword">case</span> RESTAPI -&gt; &#123;</span><br><span class="line">                <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">                    <span class="keyword">case</span> PARAM -&gt; result = ApplicationContextHolder.getBean(IdempotentParamService.class);</span><br><span class="line">                    <span class="keyword">case</span> TOKEN -&gt; result = ApplicationContextHolder.getBean(IdempotentTokenService.class);</span><br><span class="line">                    <span class="keyword">case</span> SPEL -&gt; result = ApplicationContextHolder.getBean(IdempotentSpELByRestAPIExecuteHandler.class);</span><br><span class="line">                    <span class="keyword">default</span> -&gt; &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> MQ -&gt; result = ApplicationContextHolder.getBean(IdempotentSpELByMQExecuteHandler.class);</span><br><span class="line">            <span class="keyword">default</span> -&gt; &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-2-执行幂等逻辑"><a href="#2-2-执行幂等逻辑" class="headerlink" title="2.2. 执行幂等逻辑"></a>2.2. 执行幂等逻辑</h4><p>获取到对应的幂等处理器后，我们就开始处理幂等的真实处理逻辑。</p>
<p>不同的策略实现类都会自定义实现幂等处理逻辑，比如 <code>buildWrapper</code> 方法，这里使用了模版方法模式进行了一个封装，让具体的实现细节下沉到实现类中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象幂等执行处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractIdempotentExecuteHandler</span> <span class="keyword">implements</span> <span class="title class_">IdempotentExecuteHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建幂等验证过程中所需要的参数包装器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint AOP 方法处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 幂等参数包装器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> IdempotentParamWrapper <span class="title function_">buildWrapper</span><span class="params">(ProceedingJoinPoint joinPoint)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行幂等处理逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint  AOP 方法处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idempotent 幂等注解</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ProceedingJoinPoint joinPoint, Idempotent idempotent)</span> &#123;</span><br><span class="line">        <span class="comment">// 模板方法模式：构建幂等参数包装器  通过各策略实现类获取 IdempotentParamWrapper 参数</span></span><br><span class="line">        <span class="type">IdempotentParamWrapper</span> <span class="variable">idempotentParamWrapper</span> <span class="operator">=</span> buildWrapper(joinPoint).setIdempotent(idempotent);</span><br><span class="line">        handler(idempotentParamWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-释放幂等相关资源"><a href="#2-3-释放幂等相关资源" class="headerlink" title="2.3. 释放幂等相关资源"></a>2.3. 释放幂等相关资源</h4><p>方法的最后，通过 <code>instance.postProcessing();</code> 调用幂等释放资源方法，进行分布式锁的解锁等行为，同样是各个幂等策略实现类自定义，有的需要释放资源，有的不需要。不需要释放的，空实现即可。</p>
<p>以分布式解锁为参考：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock = (RLock) IdempotentContext.getKey(LOCK);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock != <span class="literal">null</span>) &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-消息中心防重复消费"><a href="#3-消息中心防重复消费" class="headerlink" title="3. 消息中心防重复消费"></a>3. 消息中心防重复消费</h3><p>我们以支付结果回调订单消费者举例，业务很简单，就是用户支付成功，需要进行订单状态反转等逻辑操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.orderservice.mq.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.common.constant.OrderRocketMQConstant;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.common.enums.OrderItemStatusEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.common.enums.OrderStatusEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.dto.domain.OrderStatusReversalDTO;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.mq.domain.MessageWrapper;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.mq.event.PayResultCallbackOrderEvent;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.orderservice.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentSceneEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentTypeEnum;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付结果回调订单消费者</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(</span></span><br><span class="line"><span class="meta">        topic = OrderRocketMQConstant.PAY_GLOBAL_TOPIC_KEY,</span></span><br><span class="line"><span class="meta">        selectorExpression = OrderRocketMQConstant.PAY_RESULT_CALLBACK_TAG_KEY,</span></span><br><span class="line"><span class="meta">        consumerGroup = OrderRocketMQConstant.PAY_RESULT_CALLBACK_ORDER_CG_KEY</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayResultCallbackOrderConsumer</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;MessageWrapper&lt;PayResultCallbackOrderEvent&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Idempotent(</span></span><br><span class="line"><span class="meta">            uniqueKeyPrefix = &quot;index12306-order:pay_result_callback:&quot;,</span></span><br><span class="line"><span class="meta">            key = &quot;#message.getKeys()+&#x27;_&#x27;+#message.hashCode()&quot;,</span></span><br><span class="line"><span class="meta">            type = IdempotentTypeEnum.SPEL,</span></span><br><span class="line"><span class="meta">            scene = IdempotentSceneEnum.MQ,</span></span><br><span class="line"><span class="meta">            keyTimeout = 7200L</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(MessageWrapper&lt;PayResultCallbackOrderEvent&gt; message)</span> &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-SpEL-表达式"><a href="#3-1-SpEL-表达式" class="headerlink" title="3.1. SpEL 表达式"></a>3.1. SpEL 表达式</h4><p>key 里面的那个参数是不清楚是什么的，这个就是 SpEL 表达式，Spring 提供的自然语言表达式。</p>
<p>SpEL（Spring Expression Language）是 Spring 框架提供的一种表达式语言，用于在运行时评估表达式。它支持在 Spring 应用程序中进行动态求值和访问对象的属性、方法调用、运算符操作等。</p>
<p>SpEL表达式的语法类似于其他编程语言的表达式语言，具有以下特点：</p>
<ol>
<li>属性访问：可以使用点号（.）来访问对象的属性，例如 person.name。</li>
<li>方法调用：可以通过在表达式中使用方法名和参数来调用对象的方法，例如 person.getName()。</li>
<li>运算符操作：支持常见的算术运算符（如加减乘除）、逻辑运算符（如与、或、非）和比较运算符（如等于、大于、小于等）。</li>
<li>条件表达式：支持条件表达式，例如三元运算符 condition ? value1 : value2。</li>
<li>……</li>
</ol>
<p>我们分步骤解析这个 SpEL 表达式最终运行结果是什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> #message.getKeys() <span class="number">2.</span> +<span class="string">&#x27;_&#x27;</span>+ <span class="number">3.</span> #message.hashCode()</span><br></pre></td></tr></table></figure>

<p>共分为三部分，第一部分，通过请求入参 message 对象，获取属性 keys 值，然后再获取 message 对象的 hashCode 值，通过 _ 的方式拼接在一起，就得到了本次请求的唯一幂等 Key。</p>
<h4 id="3-2-幂等处理逻辑"><a href="#3-2-幂等处理逻辑" class="headerlink" title="3.2. 幂等处理逻辑"></a>3.2. 幂等处理逻辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.core.spel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.cache.DistributedCache;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.AbstractIdempotentExecuteHandler;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.IdempotentAspect;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.IdempotentContext;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.IdempotentParamWrapper;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.core.RepeatConsumptionException;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.enums.IdempotentMQConsumeStatusEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.toolkit.LogUtil;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.toolkit.SpELUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 SpEL 方法验证请求幂等性，适用于 MQ 场景</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IdempotentSpELByMQExecuteHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractIdempotentExecuteHandler</span> <span class="keyword">implements</span> <span class="title class_">IdempotentSpELService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributedCache distributedCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">TIMEOUT</span> <span class="operator">=</span> <span class="number">600</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">WRAPPER</span> <span class="operator">=</span> <span class="string">&quot;wrapper:spEL:MQ&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> IdempotentParamWrapper <span class="title function_">buildWrapper</span><span class="params">(ProceedingJoinPoint joinPoint)</span> &#123;</span><br><span class="line">        <span class="type">Idempotent</span> <span class="variable">idempotent</span> <span class="operator">=</span> IdempotentAspect.getIdempotent(joinPoint);</span><br><span class="line">        <span class="comment">// 通过执行 SpEL 表达式获取值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) SpELUtil.parseKey(idempotent.key(), ((MethodSignature) joinPoint.getSignature()).getMethod(), joinPoint.getArgs());</span><br><span class="line">        <span class="keyword">return</span> IdempotentParamWrapper.builder().lockKey(key).joinPoint(joinPoint).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(IdempotentParamWrapper wrapper)</span> &#123;</span><br><span class="line">        <span class="comment">// 拼接前缀和 SpEL 表达式对应的 Key 生成最终放到 Redis 中的唯一标识</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uniqueKey</span> <span class="operator">=</span> wrapper.getIdempotent().uniqueKeyPrefix() + wrapper.getLockKey();</span><br><span class="line">        <span class="comment">// 向 Redis 触发命令，如果值不存在则存储返回 True，值存在返回 False</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> ((StringRedisTemplate) distributedCache.getInstance())</span><br><span class="line">                .opsForValue()</span><br><span class="line">                .setIfAbsent(uniqueKey, IdempotentMQConsumeStatusEnum.CONSUMING.getCode(), TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// 如果值为 False，那么就代表要么消息已经执行完成了或者执行中，两个不同的状态需要执行不同的逻辑</span></span><br><span class="line">        <span class="comment">// 为此，需要再进行判断</span></span><br><span class="line">        <span class="keyword">if</span> (setIfAbsent != <span class="literal">null</span> &amp;&amp; !setIfAbsent) &#123;</span><br><span class="line">            <span class="comment">// 获取幂等标识对应的值，判断是否为已执行成功</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">consumeStatus</span> <span class="operator">=</span> distributedCache.get(uniqueKey, String.class);</span><br><span class="line">            <span class="comment">// 如果已经执行成功了，那么 error 为 false；执行中 error 为 true</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">error</span> <span class="operator">=</span> IdempotentMQConsumeStatusEnum.isError(consumeStatus);</span><br><span class="line">            LogUtil.getLog(wrapper.getJoinPoint()).warn(<span class="string">&quot;[&#123;&#125;] MQ repeated consumption, &#123;&#125;.&quot;</span>, uniqueKey, error ? <span class="string">&quot;Wait for the client to delay consumption&quot;</span> : <span class="string">&quot;Status is completed&quot;</span>);</span><br><span class="line">            <span class="comment">// 将异常抛出到上层</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RepeatConsumptionException</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">        IdempotentContext.put(WRAPPER, wrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个异常很关键，决定了是抛出异常让 RocketMQ 重试，还是将该消息吞掉，不执行具体的消费流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.idempotent.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等注解 AOP 拦截器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IdempotentAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强方法标记 &#123;<span class="doctag">@link</span> Idempotent&#125; 注解逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(org.opengoofy.index12306.framework.starter.idempotent.annotation.Idempotent)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">idempotentHandler</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Idempotent</span> <span class="variable">idempotent</span> <span class="operator">=</span> getIdempotent(joinPoint);</span><br><span class="line">        <span class="type">IdempotentExecuteHandler</span> <span class="variable">instance</span> <span class="operator">=</span> IdempotentExecuteHandlerFactory.getInstance(idempotent.scene(), idempotent.type());</span><br><span class="line">        Object resultObj;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            instance.execute(joinPoint, idempotent);</span><br><span class="line">            resultObj = joinPoint.proceed();</span><br><span class="line">            instance.postProcessing();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (  ex) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 触发幂等逻辑时可能有两种情况，分别对应 error 为 true 还是 false</span></span><br><span class="line"><span class="comment">             *    * 1. 消息还在处理，但是不确定是否执行成功，那么需要返回错误，方便 RocketMQ 再次通过重试队列投递</span></span><br><span class="line"><span class="comment">             *    * 2. 消息处理成功了，该消息直接返回成功即可</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!ex.getError()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// 客户端消费存在异常，需要删除幂等标识方便下次 RocketMQ 再次通过重试队列投递</span></span><br><span class="line">            instance.exceptionProcessing();</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IdempotentContext.clean();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultObj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Idempotent <span class="title function_">getIdempotent</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">methodSignature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getDeclaredMethod(methodSignature.getName(), methodSignature.getMethod().getParameterTypes());</span><br><span class="line">        <span class="keyword">return</span> targetMethod.getAnnotation(Idempotent.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过捕获 <code>RepeatConsumptionException</code> 异常，获取里面 error 变量为 true 或者 false：</p>
<ul>
<li>如果 error 为 true，代表需要抛异常让 RocketMQ 重试。</li>
<li>如果 error 为 false，代表消息已经消费过了，不执行业务逻辑，将异常吞掉返回 RocketMQ 消费成功即可。</li>
</ul>
<h4 id="3-3-能保障永久幂等么？"><a href="#3-3-能保障永久幂等么？" class="headerlink" title="3.3. 能保障永久幂等么？"></a>3.3. 能保障永久幂等么？</h4><p>不能保障永久幂等，因为 Redis 内存资源比较珍贵，如果长时间保存幂等 Key，会造成 Redis 内存占用增加。</p>
<p>业务需要评估自己的消息队列消费情况，如果队列消费量级很高，keyTimeout 不能设置过长时间。设置 keyTimeout 时间过长，这意味着幂等 Key 将会长时间占用 Redis 内存。</p>
<h4 id="3-4-设置状态为已完成"><a href="#3-4-设置状态为已完成" class="headerlink" title="3.4. 设置状态为已完成"></a>3.4. 设置状态为已完成</h4><p>如果获取到了幂等标识，然后正常业务逻辑也执行成功了，会调用 <code>instance.postProcessing();</code> 将幂等标识的完成状态设置为已完成。</p>
<p>获取唯一标识幂等 Key，并设置幂等 Key 的状态为已完成，流程结束。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">IdempotentParamWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (IdempotentParamWrapper) IdempotentContext.getKey(WRAPPER);</span><br><span class="line">    <span class="keyword">if</span> (wrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Idempotent</span> <span class="variable">idempotent</span> <span class="operator">=</span> wrapper.getIdempotent();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uniqueKey</span> <span class="operator">=</span> idempotent.uniqueKeyPrefix() + wrapper.getLockKey();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            distributedCache.put(uniqueKey, IdempotentMQConsumeStatusEnum.CONSUMED.getCode(), idempotent.keyTimeout(), TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            LogUtil.getLog(wrapper.getJoinPoint()).error(<span class="string">&quot;[&#123;&#125;] Failed to set MQ anti-heavy token.&quot;</span>, uniqueKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Web组件库"><a href="#Web组件库" class="headerlink" title="Web组件库"></a>Web组件库</h1><h2 id="组件地址-8"><a href="#组件地址-8" class="headerlink" title="组件地址"></a>组件地址</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.opengoofy.index12306<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>index12306-web-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="组件概述-7"><a href="#组件概述-7" class="headerlink" title="组件概述"></a>组件概述</h2><ol>
<li>定义全局异常处理器。</li>
<li>全局返回对象构造器。</li>
<li>项目启动后初始化调用 HTTP 请求，增加第一次访问速度。</li>
</ol>
<p>这个速度慢是因为SprinBoot在自动集成Tomcat容器的时候，没有初始化DispatcherServlet，而选择在第一次进行Http请求时在StandardWrapper中触发DispatcherServlet的初始化，所以速度慢！</p>
<h2 id="组件功能-7"><a href="#组件功能-7" class="headerlink" title="组件功能"></a>组件功能</h2><h3 id="1-全局异常处理器"><a href="#1-全局异常处理器" class="headerlink" title="1. 全局异常处理器"></a>1. 全局异常处理器</h3><p>定义全局异常处理器，避免请求处理过程中出现代码中未曾捕获的异常返回到前端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.errorcode.BaseErrorCode;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.exception.AbstractException;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.result.Result;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.BindingResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.FieldError;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.MethodArgumentNotValidException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截参数验证异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">validExceptionHandler</span><span class="params">(HttpServletRequest request, MethodArgumentNotValidException ex)</span> &#123;</span><br><span class="line">        <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> ex.getBindingResult();</span><br><span class="line">        <span class="type">FieldError</span> <span class="variable">firstFieldError</span> <span class="operator">=</span> CollectionUtil.getFirst(bindingResult.getFieldErrors());</span><br><span class="line">        <span class="type">String</span> <span class="variable">exceptionStr</span> <span class="operator">=</span> Optional.ofNullable(firstFieldError)</span><br><span class="line">                .map(FieldError::getDefaultMessage)</span><br><span class="line">                .orElse(StrUtil.EMPTY);</span><br><span class="line">        log.error(<span class="string">&quot;[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;&quot;</span>, request.getMethod(), getUrl(request), exceptionStr);</span><br><span class="line">        <span class="keyword">return</span> Results.failure(BaseErrorCode.CLIENT_ERROR.code(), exceptionStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截应用内抛出的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = &#123;AbstractException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">abstractException</span><span class="params">(HttpServletRequest request, AbstractException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex.getCause() != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;&quot;</span>, request.getMethod(), request.getRequestURL().toString(), ex.toString(), ex.getCause());</span><br><span class="line">            <span class="keyword">return</span> Results.failure(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        log.error(<span class="string">&quot;[&#123;&#125;] &#123;&#125; [ex] &#123;&#125;&quot;</span>, request.getMethod(), request.getRequestURL().toString(), ex.toString());</span><br><span class="line">        <span class="keyword">return</span> Results.failure(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截未捕获异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Throwable.class)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">defaultErrorHandler</span><span class="params">(HttpServletRequest request, Throwable throwable)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;[&#123;&#125;] &#123;&#125; &quot;</span>, request.getMethod(), getUrl(request), throwable);</span><br><span class="line">        <span class="keyword">return</span> Results.failure();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getUrl</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(request.getQueryString())) &#123;</span><br><span class="line">            <span class="keyword">return</span> request.getRequestURL().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> request.getRequestURL().toString() + <span class="string">&quot;?&quot;</span> + request.getQueryString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>处理由 <code>@Valid</code> 或 <code>@Validated</code> 校验失败引发的种种异常</p>
<h3 id="2-返回对象构造器"><a href="#2-返回对象构造器" class="headerlink" title="2. 返回对象构造器"></a>2. 返回对象构造器</h3><p>配合规约中的 Result 全局返回对象使用，Results 提供 Result 的快捷构建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.errorcode.BaseErrorCode;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.exception.AbstractException;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.result.Result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局返回对象构造器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Results</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造成功响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result&lt;Void&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;Void&gt;()</span><br><span class="line">                .setCode(Result.SUCCESS_CODE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造带返回数据的成功响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;()</span><br><span class="line">                .setCode(Result.SUCCESS_CODE)</span><br><span class="line">                .setData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建服务端失败响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Result&lt;Void&gt; <span class="title function_">failure</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;Void&gt;()</span><br><span class="line">                .setCode(BaseErrorCode.SERVICE_ERROR.code())</span><br><span class="line">                .setMessage(BaseErrorCode.SERVICE_ERROR.message());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过 &#123;<span class="doctag">@link</span> AbstractException&#125; 构建失败响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Result&lt;Void&gt; <span class="title function_">failure</span><span class="params">(AbstractException abstractException)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorCode</span> <span class="operator">=</span> Optional.ofNullable(abstractException.getErrorCode())</span><br><span class="line">                .orElse(BaseErrorCode.SERVICE_ERROR.code());</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> Optional.ofNullable(abstractException.getErrorMessage())</span><br><span class="line">                .orElse(BaseErrorCode.SERVICE_ERROR.message());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;Void&gt;()</span><br><span class="line">                .setCode(errorCode)</span><br><span class="line">                .setMessage(errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过 errorCode、errorMessage 构建失败响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Result&lt;Void&gt; <span class="title function_">failure</span><span class="params">(String errorCode, String errorMessage)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;Void&gt;()</span><br><span class="line">                .setCode(errorCode)</span><br><span class="line">                .setMessage(errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-优化项目初次调用响应"><a href="#3-优化项目初次调用响应" class="headerlink" title="3. 优化项目初次调用响应"></a>3. 优化项目初次调用响应</h3><p>不知道大家有没有注意过，SpringBoot 第一次调用的接口影响速度，相比对之后的，显得格外的慢。</p>
<p>为此，我在 Web 中定义了伪 Controller 接口，并在项目启动后进行自己调用自己。极大优化了第一次调用的接口性能响应。</p>
<p>1）定义伪 Controller 接口，方便自己调用自己。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.framework.starter.web.initialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.opengoofy.index12306.framework.starter.web.config.WebAutoConfiguration.INITIALIZE_PATH;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Initialize DispatcherServlet&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">InitializeDispatcherServletController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(INITIALIZE_PATH)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeDispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Initialized the dispatcherServlet to improve the first response time of the interface...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 2）继承 <code>CommandLineRunner</code> 接口，在项目启动后进行自调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.DispatcherServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.opengoofy.index12306.framework.starter.web.config.WebAutoConfiguration.INITIALIZE_PATH;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过 &#123;<span class="doctag">@link</span> InitializeDispatcherServletController&#125; 初始化 &#123;<span class="doctag">@link</span> DispatcherServlet&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">InitializeDispatcherServletHandler</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurableEnvironment configurableEnvironment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> String.format(<span class="string">&quot;http://127.0.0.1:%s%s&quot;</span>,</span><br><span class="line">                configurableEnvironment.getProperty(<span class="string">&quot;server.port&quot;</span>, <span class="string">&quot;8080&quot;</span>) + configurableEnvironment.getProperty(<span class="string">&quot;server.servlet.context-path&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">                INITIALIZE_PATH);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            restTemplate.execute(url, HttpMethod.GET, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Allimac</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/03/26/Compinent-Library-12306/">http://example.com/2025/03/26/Compinent-Library-12306/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">AllimacBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BB%84%E4%BB%B6%E5%BA%93/">组件库</a><a class="post-meta__tags" href="/tags/%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">全局异常处理</a><a class="post-meta__tags" href="/tags/%E5%B9%82%E7%AD%89/">幂等</a><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95id/">分布式雪花算法id</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/22/BloomFilter/" title="BloomFilter"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">BloomFilter</div></div><div class="info-2"><div class="info-item-1">布隆过滤器入门</div></div></div></a><a class="pagination-related" href="/2025/03/30/Cache-the-Three-Musketeers/" title="Cache-the-Three-Musketeers"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Cache-the-Three-Musketeers</div></div><div class="info-2"><div class="info-item-1">缓存击穿，缓存穿透，缓存雪崩问题解析</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Allimac</div><div class="author-info-description">华丽的仓库存放着我简陋的思想</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">67</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/AillemaCc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AillemaCc" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="http://www.swindle.icu/#/Home" target="_blank" title="曾经的博客"><i class="fas fa-envelope" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这里是小梦一场的大床</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot-Starter"><span class="toc-number">1.1.</span> <span class="toc-text">SpringBoot Starter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Starter-%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. Starter 定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Starter-%E5%A5%BD%E5%A4%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. Starter 好处</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Starter"><span class="toc-number">1.2.</span> <span class="toc-text">自定义 Starter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Starter-%E5%91%BD%E5%90%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. Starter 命名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">2.</span> <span class="toc-text">基础组件模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80"><span class="toc-number">2.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%A7%88"><span class="toc-number">2.2.</span> <span class="toc-text">组件概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD"><span class="toc-number">2.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F-%E7%BB%84%E4%BB%B6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text">1. 全局变量&amp;组件执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%94%A8%E6%88%B7%E5%B8%B8%E9%87%8F"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">全局用户常量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%B8%B8%E9%87%8F%E7%B1%BB"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">全局过滤器顺序执行常量类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Spring-%E5%AE%B9%E5%99%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">2.3.2.</span> <span class="toc-text">2. Spring 容器上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-FastJSON-%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.3.</span> <span class="toc-text">3. FastJSON 安全模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AE%89%E5%85%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%8B%E4%BB%B6"><span class="toc-number">2.3.4.</span> <span class="toc-text">4. 安全初始化事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%8D%95%E4%BE%8B%E5%AF%B9%E8%B1%A1%E5%AE%B9%E5%99%A8"><span class="toc-number">2.3.5.</span> <span class="toc-text">5. 单例对象容器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%84%E7%BA%A6%E7%BB%84%E4%BB%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">3.</span> <span class="toc-text">规约组件模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-1"><span class="toc-number">3.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">3.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-1"><span class="toc-number">3.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BC%82%E5%B8%B8%E7%A0%81%E6%8A%BD%E8%B1%A1%E5%92%8C%E5%85%AC%E5%85%B1%E5%BC%82%E5%B8%B8%E7%A0%81"><span class="toc-number">3.3.1.</span> <span class="toc-text">1. 异常码抽象和公共异常码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%BC%82%E5%B8%B8%E7%A0%81%E6%8E%A5%E5%8F%A3%E6%8A%BD%E8%B1%A1%E3%80%82"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">1）异常码接口抽象。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%B0%81%E8%A3%85%E5%B8%B8%E7%94%A8%E7%9A%84%E5%85%AC%E5%85%B1%E5%BC%82%E5%B8%B8%E7%A0%81%E3%80%82"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">2）封装常用的公共异常码。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8A%BD%E8%B1%A1%E5%BC%82%E5%B8%B8%E4%BD%93%E7%B3%BB"><span class="toc-number">3.3.2.</span> <span class="toc-text">2. 抽象异常体系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B0%81%E8%A3%85%E5%88%86%E9%A1%B5%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.3.3.</span> <span class="toc-text">3. 封装分页对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B0%81%E8%A3%85%E5%85%AC%E5%85%B1%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.3.4.</span> <span class="toc-text">4. 封装公共响应对象</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">4.</span> <span class="toc-text">用户基础组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-2"><span class="toc-number">4.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-1"><span class="toc-number">4.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-2"><span class="toc-number">4.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-JWT-Token-%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">4.3.1.</span> <span class="toc-text">1. JWT Token 生成器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">5.</span> <span class="toc-text">设计模式组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-3"><span class="toc-number">5.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-2"><span class="toc-number">5.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-3"><span class="toc-number">5.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B0%81%E8%A3%85%E6%9E%84%E5%BB%BA%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.1.</span> <span class="toc-text">1. 封装构建者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%81%E8%A3%85%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.2.</span> <span class="toc-text">2. 封装责任链模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">什么是责任链模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%9C%BA%E6%99%AF%E4%B8%9A%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">责任链场景业务设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A5%BD%E5%A4%84"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">好处</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mybatis-Interceptor%E5%BA%95%E5%B1%82%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">Mybatis Interceptor底层责任链模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8A%BD%E8%B1%A1%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.2.5.</span> <span class="toc-text">如何抽象责任链模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E9%87%8D%E6%9E%84"><span class="toc-number">5.3.2.5.1.</span> <span class="toc-text">责任链重构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%8A%BD%E8%B1%A1"><span class="toc-number">5.3.2.5.2.</span> <span class="toc-text">责任链抽象</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E4%B8%9A%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.2.5.2.1.</span> <span class="toc-text">抽象业务接口</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B0%81%E8%A3%85%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.3.3.</span> <span class="toc-text">3. 封装策略模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">策略模式示例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AC%E5%85%B1%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">6.</span> <span class="toc-text">公共组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-4"><span class="toc-number">6.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-3"><span class="toc-number">6.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-4"><span class="toc-number">6.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8A%BD%E8%B1%A1%E5%B8%B8%E7%94%A8%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.3.1.</span> <span class="toc-text">1. 抽象常用枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8A%BD%E8%B1%A1%E5%B8%B8%E7%94%A8%E6%9E%9A%E4%B8%BE-1"><span class="toc-number">6.3.2.</span> <span class="toc-text">1. 抽象常用枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%81%E8%A3%85%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">6.3.3.</span> <span class="toc-text">2. 封装线程池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%B1%82%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">7.</span> <span class="toc-text">持久层组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-5"><span class="toc-number">7.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-4"><span class="toc-number">7.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-5"><span class="toc-number">7.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%80%9A%E7%94%A8%E5%88%86%E9%A1%B5%E7%BB%84%E4%BB%B6"><span class="toc-number">7.3.1.</span> <span class="toc-text">1. 通用分页组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9E%E4%BD%93%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7"><span class="toc-number">7.3.2.</span> <span class="toc-text">2. 实体基础属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%85%83%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">7.3.3.</span> <span class="toc-text">3. 元数据处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%86%E9%A1%B5%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">7.3.4.</span> <span class="toc-text">4. 分页转换器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="toc-number">7.3.5.</span> <span class="toc-text">5. 自定义雪花算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95ID"><span class="toc-number">8.</span> <span class="toc-text">如何生成分布式雪花算法ID</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="toc-number">8.1.</span> <span class="toc-text">什么是雪花算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E7%BB%84%E6%88%90"><span class="toc-number">8.1.1.</span> <span class="toc-text">1. 雪花算法组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">8.1.2.</span> <span class="toc-text">2. 雪花算法适用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90-ID-%E9%87%8D%E5%A4%8D%E9%97%AE%E9%A2%98"><span class="toc-number">8.2.</span> <span class="toc-text">雪花算法生成 ID 重复问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A0%87%E8%AF%86%E4%BD%8D%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89"><span class="toc-number">8.2.1.</span> <span class="toc-text">1. 标识位如何定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%86%E9%85%8D%E6%A0%87%E8%AF%86%E4%BD%8D"><span class="toc-number">8.2.2.</span> <span class="toc-text">2. 分配标识位</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8Fid%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">9.</span> <span class="toc-text">分布式id组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-6"><span class="toc-number">9.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-5"><span class="toc-number">9.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-6"><span class="toc-number">9.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">9.3.1.</span> <span class="toc-text">1. 雪花算法生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">9.3.2.</span> <span class="toc-text">2. 雪花算法工具类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">10.</span> <span class="toc-text">幂等组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-7"><span class="toc-number">10.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-6"><span class="toc-number">10.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%82%E7%AD%89%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">10.3.</span> <span class="toc-text">什么是幂等问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8E%A5%E5%8F%A3%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4"><span class="toc-number">10.3.1.</span> <span class="toc-text">1. 接口防重复提交</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%B6%88%E8%B4%B9%E5%B9%82%E7%AD%89"><span class="toc-number">10.3.2.</span> <span class="toc-text">2. 消息队列消费幂等</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%B9%82%E7%AD%89%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">10.4.</span> <span class="toc-text">如何解决幂等问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">10.4.1.</span> <span class="toc-text">1. 分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Token-%E4%BB%A4%E7%89%8C"><span class="toc-number">10.4.2.</span> <span class="toc-text">2. Token 令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8E%BB%E9%87%8D%E8%A1%A8"><span class="toc-number">10.4.3.</span> <span class="toc-text">3. 去重表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E7%BB%84%E4%BB%B6%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%EF%BC%9F"><span class="toc-number">10.5.</span> <span class="toc-text">幂等组件如何设计？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B9%82%E7%AD%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">10.5.1.</span> <span class="toc-text">1. 幂等注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B9%82%E7%AD%89-AOP"><span class="toc-number">10.5.2.</span> <span class="toc-text">2. 幂等 AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E8%8E%B7%E5%8F%96%E5%B9%82%E7%AD%89%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">10.5.2.1.</span> <span class="toc-text">2.1. 获取幂等处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%89%A7%E8%A1%8C%E5%B9%82%E7%AD%89%E9%80%BB%E8%BE%91"><span class="toc-number">10.5.2.2.</span> <span class="toc-text">2.2. 执行幂等逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E9%87%8A%E6%94%BE%E5%B9%82%E7%AD%89%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90"><span class="toc-number">10.5.2.3.</span> <span class="toc-text">2.3. 释放幂等相关资源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%B6%88%E6%81%AF%E4%B8%AD%E5%BF%83%E9%98%B2%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="toc-number">10.5.3.</span> <span class="toc-text">3. 消息中心防重复消费</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">10.5.3.1.</span> <span class="toc-text">3.1. SpEL 表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%B9%82%E7%AD%89%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">10.5.3.2.</span> <span class="toc-text">3.2. 幂等处理逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E8%83%BD%E4%BF%9D%E9%9A%9C%E6%B0%B8%E4%B9%85%E5%B9%82%E7%AD%89%E4%B9%88%EF%BC%9F"><span class="toc-number">10.5.3.3.</span> <span class="toc-text">3.3. 能保障永久幂等么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E8%AE%BE%E7%BD%AE%E7%8A%B6%E6%80%81%E4%B8%BA%E5%B7%B2%E5%AE%8C%E6%88%90"><span class="toc-number">10.5.3.4.</span> <span class="toc-text">3.4. 设置状态为已完成</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">11.</span> <span class="toc-text">Web组件库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%9C%B0%E5%9D%80-8"><span class="toc-number">11.1.</span> <span class="toc-text">组件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0-7"><span class="toc-number">11.2.</span> <span class="toc-text">组件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD-7"><span class="toc-number">11.3.</span> <span class="toc-text">组件功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">11.3.1.</span> <span class="toc-text">1. 全局异常处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">11.3.2.</span> <span class="toc-text">2. 返回对象构造器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BC%98%E5%8C%96%E9%A1%B9%E7%9B%AE%E5%88%9D%E6%AC%A1%E8%B0%83%E7%94%A8%E5%93%8D%E5%BA%94"><span class="toc-number">11.3.3.</span> <span class="toc-text">3. 优化项目初次调用响应</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/JavaBasic8Gu/" title="JavaBasic8Gu">JavaBasic8Gu</a><time datetime="2025-04-22T10:30:18.000Z" title="发表于 2025-04-22 18:30:18">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/Hot100-1/" title="Hot100-1">Hot100-1</a><time datetime="2025-04-22T10:22:09.000Z" title="发表于 2025-04-22 18:22:09">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/TechDuck200/" title="TechDuck200">TechDuck200</a><time datetime="2025-04-22T10:20:48.000Z" title="发表于 2025-04-22 18:20:48">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/12306Business-2/" title="12306Business-2">12306Business-2</a><time datetime="2025-04-22T10:14:27.000Z" title="发表于 2025-04-22 18:14:27">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/12306Business-1/" title="12306Business-1">12306Business-1</a><time datetime="2025-04-22T10:10:07.000Z" title="发表于 2025-04-22 18:10:07">2025-04-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Allimac</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>