<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>12306Business-1 | AllimacBlog</title><meta name="author" content="Allimac"><meta name="copyright" content="Allimac"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="用户注册流程解析；列车信息查询V1;列车信息查询V2">
<meta property="og:type" content="article">
<meta property="og:title" content="12306Business-1">
<meta property="og:url" content="http://example.com/2025/04/22/12306Business-1/index.html">
<meta property="og:site_name" content="AllimacBlog">
<meta property="og:description" content="用户注册流程解析；列车信息查询V1;列车信息查询V2">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.png">
<meta property="article:published_time" content="2025-04-22T10:10:07.000Z">
<meta property="article:modified_time" content="2025-04-22T10:14:15.430Z">
<meta property="article:author" content="Allimac">
<meta property="article:tag" content="缓存穿透">
<meta property="article:tag" content="加密存储">
<meta property="article:tag" content="脱密展示">
<meta property="article:tag" content="列车信息查询">
<meta property="article:tag" content="12306业务梳理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "12306Business-1",
  "url": "http://example.com/2025/04/22/12306Business-1/",
  "image": "http://example.com/img/avatar.png",
  "datePublished": "2025-04-22T10:10:07.000Z",
  "dateModified": "2025-04-22T10:14:15.430Z",
  "author": [
    {
      "@type": "Person",
      "name": "Allimac",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/faviconcute.png"><link rel="canonical" href="http://example.com/2025/04/22/12306Business-1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '12306Business-1',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">67</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/nature_top_image.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">AllimacBlog</span></a><a class="nav-page-title" href="/"><span class="site-name">12306Business-1</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">12306Business-1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-22T10:10:07.000Z" title="发表于 2025-04-22 18:10:07">2025-04-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-22T10:14:15.430Z" title="更新于 2025-04-22 18:14:15">2025-04-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/12306/">12306</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">13.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="用户注册流程"><a href="#用户注册流程" class="headerlink" title="用户注册流程"></a>用户注册流程</h1><h2 id="责任链校验模式"><a href="#责任链校验模式" class="headerlink" title="责任链校验模式"></a>责任链校验模式</h2><p>在整个系统当中，关于责任链校验模式我们采用了多层架构抽象的模式</p>
<p>下面是关系图</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEh6nOO"><img src="https://s21.ax1x.com/2025/04/17/pEh6nOO.png" alt="pEh6nOO.png"></a></p>
<p>可以具体看一个关于“用户注册检查证件号是否多次注销”的校验器，他的依赖关系是什么样子的</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pE47up8"><img src="https://s21.ax1x.com/2025/04/20/pE47up8.png" alt="pE47up8.png"></a></p>
<p>可以看到这样将责任链抽象出来，有一个好处，可以更清晰的观看到每个业务单独的责任链是什么。因为对于这样服务很多的项目，我们更关注一个业务当中，甚至是一个方法的责任链的抽象。就比如说，在IDEA里面，针对我上面的这个校验类，就能通过它实现的接口，直接看到这个业务当中有哪些校验的类</p>
<h3 id="异常码"><a href="#异常码" class="headerlink" title="异常码"></a>异常码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"> * contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"> * this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"> * (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"> * the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.common.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.errorcode.IErrorCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册错误码枚举</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserRegisterErrorCodeEnum</span> <span class="keyword">implements</span> <span class="title class_">IErrorCode</span> &#123;</span><br><span class="line"></span><br><span class="line">    USER_REGISTER_FAIL(<span class="string">&quot;A006000&quot;</span>, <span class="string">&quot;用户注册失败&quot;</span>),</span><br><span class="line"></span><br><span class="line">    USER_NAME_NOTNULL(<span class="string">&quot;A006001&quot;</span>, <span class="string">&quot;用户名不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    PASSWORD_NOTNULL(<span class="string">&quot;A006002&quot;</span>, <span class="string">&quot;密码不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    PHONE_NOTNULL(<span class="string">&quot;A006003&quot;</span>, <span class="string">&quot;手机号不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    ID_TYPE_NOTNULL(<span class="string">&quot;A006004&quot;</span>, <span class="string">&quot;证件类型不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    ID_CARD_NOTNULL(<span class="string">&quot;A006005&quot;</span>, <span class="string">&quot;证件号不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    HAS_USERNAME_NOTNULL(<span class="string">&quot;A006006&quot;</span>, <span class="string">&quot;用户名已存在&quot;</span>),</span><br><span class="line"></span><br><span class="line">    PHONE_REGISTERED(<span class="string">&quot;A006007&quot;</span>, <span class="string">&quot;手机号已被占用&quot;</span>),</span><br><span class="line"></span><br><span class="line">    MAIL_REGISTERED(<span class="string">&quot;A006008&quot;</span>, <span class="string">&quot;邮箱已被占用&quot;</span>),</span><br><span class="line"></span><br><span class="line">    MAIL_NOTNULL(<span class="string">&quot;A006009&quot;</span>, <span class="string">&quot;邮箱不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    USER_TYPE_NOTNULL(<span class="string">&quot;A006010&quot;</span>, <span class="string">&quot;旅客类型不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    POST_CODE_NOTNULL(<span class="string">&quot;A006011&quot;</span>, <span class="string">&quot;邮编不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    ADDRESS_NOTNULL(<span class="string">&quot;A006012&quot;</span>, <span class="string">&quot;地址不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    REGION_NOTNULL(<span class="string">&quot;A006012&quot;</span>, <span class="string">&quot;国家/地区不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    TELEPHONE_NOTNULL(<span class="string">&quot;A006013&quot;</span>, <span class="string">&quot;固定电话不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    VERIFY_STATE_NOTNULL(<span class="string">&quot;A006014&quot;</span>, <span class="string">&quot;审核状态不能为空&quot;</span>),</span><br><span class="line"></span><br><span class="line">    REAL_NAME_NOTNULL(<span class="string">&quot;A006015&quot;</span>, <span class="string">&quot;真实姓名不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误提示消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="请求DTO"><a href="#请求DTO" class="headerlink" title="请求DTO"></a>请求DTO</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"> * contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"> * this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"> * (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"> * the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.dto.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册请求参数</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRegisterReqDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真实姓名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String realName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证件类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer idType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证件号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String mail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 旅客类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer userType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer verifyState;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮编</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String postCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 国家/地区</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String region;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 固定电话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String telephone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="参数必填校验"><a href="#参数必填校验" class="headerlink" title="参数必填校验"></a>参数必填校验</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.service.handler.filter.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.common.enums.UserRegisterErrorCodeEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.dto.req.UserRegisterReqDTO;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.exception.ClientException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册参数必填检验</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserRegisterParamNotNullChainHandler</span> <span class="keyword">implements</span> <span class="title class_">UserRegisterCreateChainFilter</span>&lt;UserRegisterReqDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(UserRegisterReqDTO requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(requestParam.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.USER_NAME_NOTNULL);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.isNull(requestParam.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.PASSWORD_NOTNULL);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.isNull(requestParam.getPhone())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.PHONE_NOTNULL);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.isNull(requestParam.getIdType())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.ID_TYPE_NOTNULL);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.isNull(requestParam.getIdCard())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.ID_CARD_NOTNULL);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.isNull(requestParam.getMail())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.MAIL_NOTNULL);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Objects.isNull(requestParam.getRealName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.REAL_NAME_NOTNULL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="唯一校验–防止缓存穿透的关键所在"><a href="#唯一校验–防止缓存穿透的关键所在" class="headerlink" title="唯一校验–防止缓存穿透的关键所在"></a>唯一校验–防止缓存穿透的关键所在</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"> * contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"> * this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"> * (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"> * the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.service.handler.filter.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.common.enums.UserRegisterErrorCodeEnum;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.dto.req.UserRegisterReqDTO;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.service.UserLoginService;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.framework.starter.convention.exception.ClientException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册用户名唯一检验</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserRegisterHasUsernameChainHandler</span> <span class="keyword">implements</span> <span class="title class_">UserRegisterCreateChainFilter</span>&lt;UserRegisterReqDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLoginService userLoginService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(UserRegisterReqDTO requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!userLoginService.hasUsername(requestParam.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(UserRegisterErrorCodeEnum.HAS_USERNAME_NOTNULL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="布隆过滤器判重-查询可复用set"><a href="#布隆过滤器判重-查询可复用set" class="headerlink" title="布隆过滤器判重+查询可复用set"></a><strong>布隆过滤器判重</strong>+查询可复用set</h4><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pE5EOnH"><img src="https://s21.ax1x.com/2025/04/21/pE5EOnH.png" alt="pE5EOnH.png"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">hasUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasUsername</span> <span class="operator">=</span> userRegisterCachePenetrationBloomFilter.contains(username);</span><br><span class="line">    <span class="keyword">if</span> (hasUsername) &#123;</span><br><span class="line">        <span class="type">StringRedisTemplate</span> <span class="variable">instance</span> <span class="operator">=</span> (StringRedisTemplate) distributedCache.getInstance();</span><br><span class="line">        <span class="keyword">return</span> instance.opsForSet().isMember(USER_REGISTER_REUSE_SHARDING + hashShardingIdx(username), username);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于系统当中的分布式设计，我们设计的是一套分布式缓存系统。</p>
<p>下面要说的，也是如何从分布式缓存当中获取缓存实例</p>
<p>我们以这段代码为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringRedisTemplate</span> <span class="variable">instance</span> <span class="operator">=</span> (StringRedisTemplate) distributedCache.getInstance();</span><br></pre></td></tr></table></figure>

<p>来看一下我们的代码当中是怎么获取redis实例的</p>
<p>其实对于getInstance方法，最终回来到一个构建者模式，<code>在public class StringRedisTemplateProxy implements DistributedCache</code>当中，有这样一个方法做了具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> stringRedisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回了一个stringRedisTemplate实例</p>
<p>从而可以实现后续的对于实例的操作，也就是<code>return instance.opsForSet().isMember(USER_REGISTER_REUSE_SHARDING + hashShardingIdx(username), username);</code></p>
<table>
<thead>
<tr>
<th>代码部分</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>instance</code></td>
<td>前文获取的 <code>StringRedisTemplate</code> 实例</td>
</tr>
<tr>
<td><code>.opsForSet()</code></td>
<td>获取Redis的Set集合操作接口</td>
</tr>
<tr>
<td><code>.isMember(key, value)</code></td>
<td>检查<code>value</code>是否是Set集合<code>key</code>的成员</td>
</tr>
<tr>
<td><code>USER_REGISTER_REUSE_SHARDING + hashShardingIdx(username)</code></td>
<td>动态生成Redis的Key</td>
</tr>
<tr>
<td><code>username</code></td>
<td>要检查的用户名</td>
</tr>
</tbody></table>
<p>对于hashShardingIdx还可以多说一点，也就是哈希分片技术</p>
<h4 id="哈希分片–减少大key问题"><a href="#哈希分片–减少大key问题" class="headerlink" title="哈希分片–减少大key问题"></a>哈希分片–减少大key问题</h4><p><code>hashShardingIdx</code> 函数的作用是 <strong>通过哈希计算对数据进行分片（Sharding）</strong>，目的是将数据分散存储到多个Redis Key中，避免单个Key过大的问题。</p>
<p>可以简单看一下这个实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hashShardingIdx</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 计算用户名哈希值</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> username.hashCode(); </span><br><span class="line">    <span class="comment">// 2. 取绝对值（避免负数）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">absHash</span> <span class="operator">=</span> Math.abs(hashCode); </span><br><span class="line">    <span class="comment">// 3. 取模分片（假设分成16个片）</span></span><br><span class="line">    <span class="keyword">return</span> absHash % <span class="number">16</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多次注销校验"><a href="#多次注销校验" class="headerlink" title="多次注销校验"></a>多次注销校验</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册检查证件号是否多次注销</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserRegisterCheckDeletionChainHandler</span> <span class="keyword">implements</span> <span class="title class_">UserRegisterCreateChainFilter</span>&lt;UserRegisterReqDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(UserRegisterReqDTO requestParam)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userDeletionNum</span> <span class="operator">=</span> userService.queryUserDeletionNum(requestParam.getIdType(), requestParam.getIdCard());</span><br><span class="line">        <span class="keyword">if</span> (userDeletionNum &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;证件号多次注销账号已被加入黑名单&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么需要校验拦截多次注销呢</p>
<p>我们举一个例子</p>
<ul>
<li>同一用户反复注册→注销账号，可能用于刷优惠券、薅羊毛、绕过风控规则。</li>
<li>黑产分子利用注销-注册循环占用系统资源（如手机号、邮箱等绑定名额）。</li>
</ul>
<p>在系统当中，我们维护一个<code>t_user_deletion</code>表，用来记录每一个证件（type，id）的注销数量</p>
<p>校验的最后，千言万语汇成一句话</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abstractChainContext.handler(UserChainMarkEnum.USER_REGISTER_FILTER.name(), requestParam);</span><br></pre></td></tr></table></figure>

<p>通过抽象出来的责任链上下文，调用责任链进行校验</p>
<h2 id="分布式锁抢占"><a href="#分布式锁抢占" class="headerlink" title="分布式锁抢占"></a>分布式锁抢占</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(LOCK_USER_REGISTER + requestParam.getUsername());</span><br></pre></td></tr></table></figure>

<p>使用Redisson对用户名加锁（<code>LOCK_USER_REGISTER + username</code>），防止并发注册相同用户名（锁失败直接返回”用户名已存在”）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!tryLock) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(HAS_USERNAME_NOTNULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="插入主表"><a href="#插入主表" class="headerlink" title="插入主表"></a>插入主表</h2><p>插入主表简单的一个语句就可以吗</p>
<p>其实是不行的。还有很多异常我们都没有捕获</p>
<p>编程的时候不能想当然，有些情况我们必须考虑的全面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">inserted</span> <span class="operator">=</span> userMapper.insert(BeanUtil.convert(requestParam, UserDO.class));</span><br><span class="line">    <span class="keyword">if</span> (inserted &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(USER_REGISTER_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (DuplicateKeyException dke) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;用户名 [&#123;&#125;] 重复注册&quot;</span>, requestParam.getUsername());</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(HAS_USERNAME_NOTNULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果用户名已存在，会先触发 <code>DuplicateKeyException</code>，<strong>不会执行到 <code>inserted &lt; 1</code> 的判断</strong>。</p>
<p>为什么还需要这个判断呢</p>
<p>即使 SQL 语法正确，某些数据库故障（如隐式回滚）可能导致插入无报错但实际未写入。</p>
<p>假如数据库故障了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">inserted</span> <span class="operator">=</span> userMapper.insert(newUser); <span class="comment">// 返回 0（因表空间不足）</span></span><br><span class="line"><span class="keyword">if</span> (inserted &lt; <span class="number">1</span>) &#123; <span class="comment">// 条件成立</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(USER_REGISTER_FAIL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>inserted &lt; 1</code></strong> 是 <strong>对数据库插入操作失败的兜底检查</strong>，处理那些未抛出异常但实际未写入的情况。</li>
<li>与 <code>DuplicateKeyException</code> 配合，覆盖了插入失败的两种主要场景：<ul>
<li><strong>显式冲突</strong>（唯一键重复 → 异常捕获）。</li>
<li><strong>隐式失败</strong>（其他原因 → 返回值检查）。</li>
</ul>
</li>
</ul>
<p>执行插入主表之后，我们才去写手机号和邮箱表。因为若先写手机号&#x2F;邮箱表，可能因主表写入失败产生垃圾数据。</p>
<h2 id="插入手机号表和邮箱表"><a href="#插入手机号表和邮箱表" class="headerlink" title="插入手机号表和邮箱表"></a>插入手机号表和邮箱表</h2><h4 id="手机号表"><a href="#手机号表" class="headerlink" title="手机号表"></a>手机号表</h4><p><strong>为什么需要一个手机号表</strong></p>
<p>在登录功能中，用户一栏明确标出可以使用用户名、邮箱或手机号中的任意一个搭配密码进行登录。但是需要强调的是，在分库分表中，我们是通过用户名进行分片的。因此，如果在查询用户信息时不带用户名，将会触发读扩散问题。</p>
<p>为了解决这个问题，我们引入了两张路由表：用户手机号表和用户邮箱表。这些表的核心字段是手机号和邮箱，以及它们对应的用户名。通过这样的设计，我们能够在用户登录时，灵活地使用手机号、邮箱或用户名来进行认证。</p>
<p>拿手机号登录方式来说，我们通过手机号定位到路由表中的某一条用户数据，拿到对应的用户名，再根据用户名去查询真实的用户数据。这样就很好避免了读扩散问题。</p>
<p>这个在注册的时候向插入的手机号，实际上是插入到路由表当中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户手机号实体对象</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span></span><br><span class="line"><span class="variable">@Builder</span></span><br><span class="line"><span class="variable">@TableName</span>(&quot;t_user_phone&quot;)</span><br><span class="line">public class UserPhoneDO extends BaseDO &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private String phone;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注销时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private Long deletionTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UserPhoneDO</span> <span class="variable">userPhoneDO</span> <span class="operator">=</span> UserPhoneDO.builder()</span><br><span class="line">                    .phone(requestParam.getPhone())</span><br><span class="line">                    .username(requestParam.getUsername())</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                userPhoneMapper.insert(userPhoneDO);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (DuplicateKeyException dke) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;用户 [&#123;&#125;] 注册手机号 [&#123;&#125;] 重复&quot;</span>, requestParam.getUsername(), requestParam.getPhone());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(PHONE_REGISTERED);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>手机号与用户名解耦，支持后续换绑操作。</p>
<p>单独的唯一索引（<code>phone</code>字段）防止手机号重复注册。</p>
<h4 id="邮箱表"><a href="#邮箱表" class="headerlink" title="邮箱表"></a>邮箱表</h4><p>没那么重要，所以设置成存在的时候才使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(requestParam.getMail())) &#123;</span><br><span class="line">                <span class="type">UserMailDO</span> <span class="variable">userMailDO</span> <span class="operator">=</span> UserMailDO.builder()</span><br><span class="line">                        .mail(requestParam.getMail())</span><br><span class="line">                        .username(requestParam.getUsername())</span><br><span class="line">                        .build();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    userMailMapper.insert(userMailDO);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (DuplicateKeyException dke) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;用户 [&#123;&#125;] 注册邮箱 [&#123;&#125;] 重复&quot;</span>, requestParam.getUsername(), requestParam.getMail());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(MAIL_REGISTERED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>仅当邮箱参数存在时执行邮箱表写入</p>
</li>
<li><p>后续可独立验证邮箱，不影响主流程。</p>
</li>
</ul>
<h2 id="后处理"><a href="#后处理" class="headerlink" title="后处理"></a>后处理</h2><p><code>@Transactional(rollbackFor = Exception.class)</code>确保任意步骤失败时全部回滚。</p>
<p>写入数据，其实就代表这个username注册成功了，当用户<strong>成功注册</strong>时，需确保该用户名<strong>不能被标记为”可复用”</strong>，否则会导致逻辑冲突：用户A注册<code>magestack</code>，但系统中残留该用户名的”可复用”标记。另一个服务误认为<code>magestack</code>可用，导致数据不一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 删除数据库中的可复用记录</span></span><br><span class="line">userReuseMapper.delete(Wrappers.update(<span class="keyword">new</span> <span class="title class_">UserReuseDO</span>(username)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 删除Redis缓存中的可复用记录</span></span><br><span class="line"><span class="type">StringRedisTemplate</span> <span class="variable">instance</span> <span class="operator">=</span> (StringRedisTemplate) distributedCache.getInstance();</span><br><span class="line">instance.opsForSet().remove(USER_REGISTER_REUSE_SHARDING + hashShardingIdx(username), username);</span><br></pre></td></tr></table></figure>

<p><strong>清理历史状态</strong>，确保新注册的用户名立即被系统确认为”已占用”。</p>
<p>加入布隆过滤器，是防止缓存穿透。对于已经存在的username，布隆过滤器添加存在之后，新建这个username会在布隆过滤器当中检索到，告诉是不可用的。</p>
<p>假如用户注销了之后，我们希望这个用户名重新变得可用，但是布隆过滤器不能删除，怎么办呢</p>
<p>我们维护了一个可复用表，用来记录那些，曾经存在过，但是已经被释放的username</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户名复用表实体</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;t_user_reuse&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserReuseDO</span> <span class="keyword">extends</span> <span class="title class_">BaseDO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="如何应对海量并发注册带来的缓存穿透问题"><a href="#如何应对海量并发注册带来的缓存穿透问题" class="headerlink" title="如何应对海量并发注册带来的缓存穿透问题"></a>如何应对海量并发注册带来的缓存穿透问题</h1><h2 id="用户出现缓存穿透的场景"><a href="#用户出现缓存穿透的场景" class="headerlink" title="用户出现缓存穿透的场景"></a>用户出现缓存穿透的场景</h2><p>在不施加任何缓存穿透解决措施的情况下</p>
<p>在高并发的会员注册场景下，可能会出现缓存穿透问题。主要原因可能是：</p>
<ul>
<li>用户注册时，需要验证用户名是否已存在，这通常需要查询数据库。</li>
<li>如果缓存中没有该用户名，就会去数据库查询，如果数据库中也没有，就可以判断该用户名可用。</li>
<li>在高并发的情况下，可能有大量的新用户同时注册，输入的用户名极有可能都不存在于数据库中。这将导致大量的缓存不存在，都去查询数据库，造成数据库压力剧增。</li>
<li>且这些查询数据库的 Key 都不会被缓存，因为数据库中没有，不会写入缓存。那么这些 Key 对应的 Null 值也不会被缓存，造成每次请求都查不到缓存，直接查询数据库。</li>
<li>这样就形成了缓存穿透情况。</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="空值缓存"><a href="#空值缓存" class="headerlink" title="空值缓存"></a>空值缓存</h3><p><strong>即使数据库查询结果为空（即 Key 不存在），仍然在缓存中存储一个特殊标记（如 <code>null</code>），并设置较短的过期时间（如 60s），以减少对数据库的无效查询</strong>。</p>
<p>对不存在的 Key 进行缓存，值设为 Null，并设置短暂过期时间，如 60 秒。</p>
<ul>
<li>假设用户 A 注册 username 为 magestack，查询 DB 不存在，返回请求成功，并放入 Redis 缓存。但是用户 A 并没有使用该值作为 username。</li>
<li>如果有另一个用户 B 注册 username 为 magestack，将返回失败。也就是说每尝试一次不存在的用户名，该值 60 秒内都不可被注册。</li>
</ul>
<p>结论：对用户使用体验不友好。此外，如果有大量并发请求查询不存在的用户名，可能会导致数据库短时间内被打挂。</p>
<h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><p>使用布隆过滤器，将所有已注册的用户名存入布隆过滤器，判断时先判断该用户名是否在布隆过滤器中，不在的一定不存在，避免直接查询数据库。</p>
<ul>
<li>这种解决方案算是网上八股说的比较多的一个版本。但是依然不能解决实际场景问题。</li>
<li>如果用户注销了账号，该用户名就可以再次被使用。然而，布隆过滤器由于无法删除元素，因此无法处理这种情况。</li>
</ul>
<p>结论：布隆过滤器不能删除元素的限制，让这个方案出现了很大的弊端。但我们单独维护了一个reuse表，解决了这个问题。</p>
<h3 id="Redis-Set存储已经注册的用户名"><a href="#Redis-Set存储已经注册的用户名" class="headerlink" title="Redis Set存储已经注册的用户名"></a>Redis Set存储已经注册的用户名</h3><p>使用确定的数据结构如 Redis 的 Set 集合来存储已注册用户名，判断时检查是否在集合内。</p>
<ul>
<li>永久存储十几亿的用户信息到 Redis 缓存中显然不太现实，因为这会占用大量的内存资源。</li>
<li>即使是临时存储，如果在缓存中查询不到数据，仍然无法避免查询数据库的场景。</li>
<li>此外，对于这么多的用户信息，是否应该将其存储在一个 Key 中呢？显然是不可行的。即使进行分片，也会增加系统的复杂度。</li>
</ul>
<p>结论：由于该方案占用内存较多且复杂度较高，因此不适合实际应用。</p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>这个原理不说了，主要的问题就是在于如果在用户注册高峰期，只有一个线程访问数据库，这可能会导致大量用户的注册请求缓慢或超时。</p>
<h2 id="综合解决方案"><a href="#综合解决方案" class="headerlink" title="综合解决方案"></a>综合解决方案</h2><p>要解决两个痛点</p>
<ul>
<li>大量用户同时注册，导致大量不存在数据库的数据请求打到数据库，压力太大</li>
<li>假如使用布隆过滤器解决痛点1，布隆过滤器不能删除的特点会让这个方法不能应用到生产环境</li>
</ul>
<p>解决方法其实就是一个综合方案</p>
<p>第一层，责任链校验当中：</p>
<ol>
<li>用户名 “mading” 成功注册后，将其添加至布隆过滤器。</li>
<li>当其他用户查询”mading”是否已被使用时，首先检查布隆过滤器是否包含该用户名。</li>
<li>如果布隆过滤器中不存在该用户名，根据布隆过滤器的特点，可以确认该用户名一定没有被使用过，因此返回成功，证明该用户名可用。</li>
<li>如果布隆过滤器中存在该用户名，进一步检查Redis Set结构中是否包含该用户名。如果存在，表示该用户名已被注销，同样可被再次使用。</li>
<li>如果布隆过滤器中存在该用户名，但 Redis Set 结构中不存在，说明该用户名已被使用且尚未被注销，因此不可用。</li>
</ol>
<p>第二层筛选其实是一个抢占式分布式锁，在注册阶段根据你传入的用户名去缓存当中拿锁。假如这个锁没拿到，说明这个用户名被其他锁拿到了。当然，这个用户名虽然已经拿到，但是注不注册，另说。但是这个抢占式分布式锁确实起到了快速失败的作用。</p>
<p>拿到了分布式锁，正式开始流程就可以了</p>
<p>所以我们的综合解决方案，其实是用到了bollmfliter，redis set，以及分布式锁的。</p>
<blockquote>
<p>1）Redis Set 结构是什么？</p>
<p>当用户注销后，系统会将其用户名放入缓存结构中。如果其他用户想要使用该用户名，会检查缓存是否存在该用户名。如果缓存中存在该用户名，就表示该用户名已被注销，可以被再次使用。</p>
<p>2）使用这种方式后，会面临以下问题：</p>
<ol>
<li>查询性能消耗增加：由于采用了额外的 Redis Set 结构，查询过程需要进行两次查询，一次是查询布隆过滤器，另一次是查询Redis Set结构，这导致查询性能相比之前有所增加。</li>
<li>存储损耗增加：相较于之前仅使用布隆过滤器的存储，现在需要额外存储 Redis Set 结构，这导致存储开销增加。</li>
</ol>
<p>3）上面这种方式真的是没有问题的么？</p>
<p>有一个问题可能会出现：如果用户频繁申请账号再注销，可能导致用户注销可复用的 Username Redis Set 结构变得庞大，增加了存储和查询的负担。</p>
<p>为了防止这种情况，我采取了以下解决方案：</p>
<ol>
<li>异常行为限制：每次用户注销时，记录用户的证件号，并限制证件号仅可用于注销五次。超过这个限制的次数，将禁止该证件号再次用于注册账号。</li>
<li>缓存分片处理：对 Username Redis Set 结构进行分片。即使我们对异常行为进行了限制，如果有大量用户注销账户，存储这些数据在一个 Redis Set 结构中可能成为一个灾难，可能出现 Redis 大 Key 问题。因此，我将 Set 结构进行分片，根据用户名的 HashCode 进行取模操作，将数据分散存储在 1024 个 Set 结构中，从而有效地解决了这个问题。</li>
</ol>
</blockquote>
<h1 id="敏感数据的加密存储和脱敏展示"><a href="#敏感数据的加密存储和脱敏展示" class="headerlink" title="敏感数据的加密存储和脱敏展示"></a>敏感数据的加密存储和脱敏展示</h1><h2 id="加密存储"><a href="#加密存储" class="headerlink" title="加密存储"></a>加密存储</h2><p> ShardingSphereJDBC给我们提供了加密存储的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置数据源，底层被 ShardingSphere 进行了代理</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">ds_0:</span></span><br><span class="line">    <span class="attr">dataSourceClassName:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">jdbcUrl:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/12306_user_0?useUnicode=true&amp;characterEncoding=UTF-8&amp;rewriteBatchedStatements=true&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="comment"># 数据加密存储规则</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!ENCRYPT</span></span><br><span class="line">    <span class="comment"># 需要加密的表集合</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="comment"># 用户表</span></span><br><span class="line">      <span class="attr">t_user:</span></span><br><span class="line">        <span class="comment"># 用户表中哪些字段需要进行加密</span></span><br><span class="line">        <span class="attr">columns:</span></span><br><span class="line">          <span class="comment"># 身份证字段，逻辑字段，不一定是在数据库中真实存在</span></span><br><span class="line">          <span class="attr">id_card:</span></span><br><span class="line">            <span class="comment"># 身份证字段存储的密文字段，这个是数据库中真实存在的字段</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">id_card</span></span><br><span class="line">            <span class="comment"># 身份证字段加密算法</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">          <span class="attr">phone:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">phone</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">          <span class="attr">mail:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">mail</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">          <span class="attr">address:</span></span><br><span class="line">            <span class="attr">cipherColumn:</span> <span class="string">address</span></span><br><span class="line">            <span class="attr">encryptorName:</span> <span class="string">common_encryptor</span></span><br><span class="line">        <span class="comment"># 是否按照密文字段查询</span></span><br><span class="line">        <span class="attr">queryWithCipherColumn:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 加密算法</span></span><br><span class="line">    <span class="attr">encryptors:</span></span><br><span class="line">      <span class="comment"># 自定义加密算法名称</span></span><br><span class="line">      <span class="attr">common_encryptor:</span></span><br><span class="line">        <span class="comment"># 加密算法类型</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">AES</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="comment"># AES 加密密钥</span></span><br><span class="line">          <span class="attr">aes-key-value:</span> <span class="string">d6oadClrrb9A3GWo</span></span><br><span class="line"><span class="attr">props:</span></span><br><span class="line">  <span class="attr">sql-show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>新插入一条用户信息之后，在应用程序里还是明文，经过 ShardingSphere 代理后，存储数据库时，就已经是密文的了。</p>
<p>原始 SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert into</span> t_user (id_card, phone, mail, address) <span class="keyword">values</span> (<span class="string">&#x27;34020xx023081xx338&#x27;</span>, <span class="string">&#x27;1x60111xx983&#x27;</span>, <span class="string">&#x27;mading@axxche.org&#x27;</span>, <span class="string">&#x27;xx东城x&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>修改之后的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert into</span> t_user (id_card, phone, mail, address) <span class="keyword">values</span> (<span class="string">&#x27;YUvr+8Xf17VCgGonU2WXqmKuhB5FMazUEbh3y+h0B38=&#x27;</span>, <span class="string">&#x27;MZObk+5TeYPLHtP2A6+aiw==&#x27;</span>, <span class="string">&#x27;vX/5iWTyfAvMJMt+ioipj9vd6cnZ4rz4qKBAXQ9C9oU=&#x27;</span>, <span class="string">&#x27;vX/5iWTyfAvMJMt+ioipj9vd6cnZ4rz4qKBAXQ9C9oU=&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>存储到数据库是密文，那查询时展示不就有问题了吗？ShardingSphere 在执行查询语句时，如果涉及到相关加密表，会自动将加密数据转换为明文数据，也就是会把 <code>YUvr+8Xf17VCgGonU2WXqmKuhB5FMazUEbh3y+h0B38=</code> 转换为 <code>34020xx023081xx338</code>。</p>
<p>这样就能形成一个加密敏感信息落库闭环。</p>
<h2 id="脱敏展示"><a href="#脱敏展示" class="headerlink" title="脱敏展示"></a>脱敏展示</h2><p>将用户敏感信息脱敏展示到前端是出于保护用户隐私和信息安全的考虑。</p>
<p>敏感信息包括但不限于手机号码、身份证号、银行卡号等，这些信息泄露可能导致用户个人信息的滥用、身份盗用等严重问题。脱敏是一种常用的保护用户隐私的方式，它的目的是减少潜在的风险，同时保持一定的用户信息可读性。</p>
<p>比如咱们在选择用户信息以及展示选座信息时，用户证件号码的脱敏展示。</p>
<p><code>111111********1111</code></p>
<p>网上很多教程都是在说，通过 AOP、自定义注解和反射的方式完成字段脱敏功能。但是这种方式有点重量级且性能一般，遇到高并发场景存在性能瓶颈。</p>
<p>假如有循环嵌套，最中间的一层打了自定义注解需要被脱敏处理的话，就需要一层一层的解析嵌套对象直到找到自定义加密注解进行脱敏，性能可想而知。</p>
<h3 id="Jackson序列化方案–更加轻量级"><a href="#Jackson序列化方案–更加轻量级" class="headerlink" title="Jackson序列化方案–更加轻量级"></a>Jackson序列化方案–更加轻量级</h3><p>在 SpringMVC 返回数据时，通过默认的 Jackson 序列化器进行指定，替换为咱们已经包装后的序列化器，这样就能依赖现有解决方案，降低技术复杂度</p>
<p>实现序列化器，需要继承<code>extends JsonSerializer&lt;String&gt;</code>，对序列化方法进行重写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.DesensitizedUtil;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份证号脱敏反序列化</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdCardDesensitizationSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(String idCard, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneDesensitization</span> <span class="operator">=</span> DesensitizedUtil.idCardNum(idCard, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        jsonGenerator.writeString(phoneDesensitization);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.DesensitizedUtil;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 手机号脱敏反序列化</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneDesensitizationSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(String phone, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phoneDesensitization</span> <span class="operator">=</span> DesensitizedUtil.mobilePhone(phone);</span><br><span class="line">        jsonGenerator.writeString(phoneDesensitization);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.opengoofy.index12306.biz.userservice.dto.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.serialize.IdCardDesensitizationSerializer;</span><br><span class="line"><span class="keyword">import</span> org.opengoofy.index12306.biz.userservice.serialize.PhoneDesensitizationSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 乘车人返回参数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerRespDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 证件号码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonSerialize(using = IdCardDesensitizationSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonSerialize(using = PhoneDesensitizationSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回给前端的数据通常需要经过序列化过程。在检测到需要序列化的字段之后，注解会对这个字段应用序列化方法，返回最终的json字符串</p>
<hr>
<p>对接前端的敏感数据脱敏展示功能做到上面这些就已经实现了。但是总感觉哪里不对，因为咱们在购票服务中，下单接口会调用乘车人详细信息接口获取到手机号、证件号等信息保存入库。</p>
<p>如果我在后端服务里去调用乘车人的信息接口，那岂不是也是脱敏的？这样的话，存储到数据库的数据就不准确了，期望是真实的数据，但是实际是脱敏后的。</p>
<p>基于这种真实情况，目前 12306 中的做法是拆分一个新的实体，叫做 <code>PassengerActualRespDTO</code>，返回的信息是不脱敏的。其实本质上就是复制了一个乘车人实体，但是在证件号和手机号字段上不添加 <code>@JsonSerialize</code> 注解，以此满足业务需求。不暴露给前端，仅在后台当中进行使用。</p>
<h1 id="列车信息查询V1"><a href="#列车信息查询V1" class="headerlink" title="列车信息查询V1"></a>列车信息查询V1</h1><h2 id="责任链校验模式-1"><a href="#责任链校验模式-1" class="headerlink" title="责任链校验模式"></a>责任链校验模式</h2><h3 id="非空校验"><a href="#非空校验" class="headerlink" title="非空校验"></a>非空校验</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询列车车票流程过滤器之验证数据是否为空或空的字符串</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainTicketQueryParamNotNullChainFilter</span> <span class="keyword">implements</span> <span class="title class_">TrainTicketQueryChainFilter</span>&lt;TicketPageQueryReqDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(TicketPageQueryReqDTO requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(requestParam.getFromStation())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发地不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(requestParam.getToStation())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;目的地不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestParam.getDepartureDate() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发日期不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基础数据校验"><a href="#基础数据校验" class="headerlink" title="基础数据校验"></a>基础数据校验</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询列车车票流程过滤器之基础数据验证</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainTicketQueryParamBaseVerifyChainFilter</span> <span class="keyword">implements</span> <span class="title class_">TrainTicketQueryChainFilter</span>&lt;TicketPageQueryReqDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(TicketPageQueryReqDTO requestParam)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestParam.getDepartureDate().toInstant().atZone(ZoneId.systemDefault()).toLocalDate().isBefore(LocalDate.now())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发日期不能小于当前日期&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(requestParam.getFromStation(), requestParam.getToStation())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发地和目的地不能相同&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<h2 id="分步拆解"><a href="#分步拆解" class="headerlink" title="分步拆解"></a>分步拆解</h2><ol>
<li><strong><code>requestParam.getDepartureDate()</code></strong><ul>
<li>获取请求参数中的出发日期，这通常是一个<code>Date</code>或<code>Timestamp</code>类型的对象</li>
</ul>
</li>
<li><strong><code>.toInstant()</code></strong><ul>
<li>将<code>Date</code>对象转换为<code>Instant</code>对象（表示时间线上的一个瞬时点）</li>
<li>例如：<code>Date</code> → <code>Instant</code></li>
</ul>
</li>
<li><strong><code>.atZone(ZoneId.systemDefault())</code></strong><ul>
<li>将<code>Instant</code>转换为带时区的<code>ZonedDateTime</code></li>
<li><code>ZoneId.systemDefault()</code>获取系统默认时区</li>
<li>例如：<code>Instant</code> → <code>ZonedDateTime</code>（如2023-11-15T00:00:00+08:00[Asia&#x2F;Shanghai]）</li>
</ul>
</li>
<li><strong><code>.toLocalDate()</code></strong><ul>
<li>从<code>ZonedDateTime</code>中提取日期部分（去掉时间及时区信息）</li>
<li>例如：<code>ZonedDateTime</code> → <code>LocalDate</code>（如2023-11-15）</li>
</ul>
</li>
<li><strong><code>.isBefore(LocalDate.now())</code></strong><ul>
<li>将转换后的出发日期与当前日期（<code>LocalDate.now()</code>）比较</li>
<li>如果出发日期早于当前日期，返回<code>true</code></li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="出发地目的地校验"><a href="#出发地目的地校验" class="headerlink" title="出发地目的地校验"></a>出发地目的地校验</h3><p>先贴上源代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询列车车票流程过滤器之验证数据是否正确</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainTicketQueryParamVerifyChainFilter</span> <span class="keyword">implements</span> <span class="title class_">TrainTicketQueryChainFilter</span>&lt;TicketPageQueryReqDTO&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RegionMapper regionMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StationMapper stationMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributedCache distributedCache;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存数据为空并且已经加载过-标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">CACHE_DATA_ISNULL_AND_LOAD_FLAG</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(TicketPageQueryReqDTO requestParam)</span> &#123;</span><br><span class="line">        <span class="type">StringRedisTemplate</span> <span class="variable">stringRedisTemplate</span> <span class="operator">=</span> (StringRedisTemplate) distributedCache.getInstance();</span><br><span class="line">        HashOperations&lt;String, Object, Object&gt; hashOperations = stringRedisTemplate.opsForHash();</span><br><span class="line">        List&lt;Object&gt; actualExistList = hashOperations.multiGet(</span><br><span class="line">                QUERY_ALL_REGION_LIST,</span><br><span class="line">                ListUtil.toList(requestParam.getFromStation(), requestParam.getToStation())</span><br><span class="line">        );</span><br><span class="line">        <span class="type">long</span> <span class="variable">emptyCount</span> <span class="operator">=</span> actualExistList.stream().filter(Objects::isNull).count();</span><br><span class="line">        <span class="keyword">if</span> (emptyCount == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (emptyCount == <span class="number">1L</span> || (emptyCount == <span class="number">2L</span> &amp;&amp; CACHE_DATA_ISNULL_AND_LOAD_FLAG &amp;&amp; distributedCache.hasKey(QUERY_ALL_REGION_LIST))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发地或目的地不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(LOCK_QUERY_ALL_REGION_LIST);</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (distributedCache.hasKey(QUERY_ALL_REGION_LIST)) &#123;</span><br><span class="line">                actualExistList = hashOperations.multiGet(</span><br><span class="line">                        QUERY_ALL_REGION_LIST,</span><br><span class="line">                        ListUtil.toList(requestParam.getFromStation(), requestParam.getToStation())</span><br><span class="line">                );</span><br><span class="line">                emptyCount = actualExistList.stream().filter(Objects::nonNull).count();</span><br><span class="line">                <span class="keyword">if</span> (emptyCount != <span class="number">2L</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发地或目的地不存在&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;RegionDO&gt; regionDOList = regionMapper.selectList(Wrappers.emptyWrapper());</span><br><span class="line">            List&lt;StationDO&gt; stationDOList = stationMapper.selectList(Wrappers.emptyWrapper());</span><br><span class="line">            HashMap&lt;Object, Object&gt; regionValueMap = Maps.newHashMap();</span><br><span class="line">            <span class="keyword">for</span> (RegionDO each : regionDOList) &#123;</span><br><span class="line">                regionValueMap.put(each.getCode(), each.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (StationDO each : stationDOList) &#123;</span><br><span class="line">                regionValueMap.put(each.getCode(), each.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            hashOperations.putAll(QUERY_ALL_REGION_LIST, regionValueMap);</span><br><span class="line">            CACHE_DATA_ISNULL_AND_LOAD_FLAG = <span class="literal">true</span>;</span><br><span class="line">            emptyCount = regionValueMap.keySet().stream()</span><br><span class="line">                    .filter(each -&gt; StrUtil.equalsAny(each.toString(), requestParam.getFromStation(), requestParam.getToStation()))</span><br><span class="line">                    .count();</span><br><span class="line">            <span class="keyword">if</span> (emptyCount != <span class="number">2L</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发地或目的地不存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>private static boolean CACHE_DATA_ISNULL_AND_LOAD_FLAG = false;</code>上来第一个就是这样一个标识，作用是作为一个标志位，一个判断缓存当中不存在xx数据并且缓存已经加载过的标志位。因为我们查询出发站点和到达站点，是从缓存当中进行查询的。</p>
<p>我们看一下从缓存当中的查询过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringRedisTemplate</span> <span class="variable">stringRedisTemplate</span> <span class="operator">=</span> (StringRedisTemplate) distributedCache.getInstance();</span><br><span class="line">        HashOperations&lt;String, Object, Object&gt; hashOperations = stringRedisTemplate.opsForHash();</span><br><span class="line">        List&lt;Object&gt; actualExistList = hashOperations.multiGet(</span><br><span class="line">                QUERY_ALL_REGION_LIST,</span><br><span class="line">                ListUtil.toList(requestParam.getFromStation(), requestParam.getToStation())</span><br><span class="line">        );</span><br><span class="line">        <span class="type">long</span> <span class="variable">emptyCount</span> <span class="operator">=</span> actualExistList.stream().filter(Objects::isNull).count();</span><br></pre></td></tr></table></figure>

<p>获取操作redis的实例这一部分就不多说了，通过multiGet减少网络IO优化速度，再</p>
<p>查询起始站和终点站当中的空值</p>
<p>空值个数分为这么几种情况</p>
<ul>
<li>0；起始站和终点站都能在缓存当中查到，校验结束</li>
<li>1；起始站和终点站在缓存当中只能查到一个，说明我们是已经建立起缓存，并且有一个站点根本是不在缓存当中存在的。那这样肯定有出发地或者到达地是不存在的</li>
<li>2；两种情况<ul>
<li>我们没有建立起缓存，也就是没有加载过数据库建立缓存的过程。这个时候缓存数据为空，查不到很正常，我们是需要继续往下开始建立缓存的过程的</li>
<li>我们建立起缓存，<code>CACHE_DATA_ISNULL_AND_LOAD_FLAG == true</code>：表示缓存已经加载过，但数据确实为空。并且<code>distributedCache.hasKey(QUERY_ALL_REGION_LIST)</code>：表示缓存键 <code>QUERY_ALL_REGION_LIST</code> 存在于 Redis 中（尽管值为空）就是我们限制住了一切可能出现“非站点不存在而数据空的问题”，就可以抛出出发地或者目的地不存在的情况</li>
</ul>
</li>
</ul>
<h3 id="查询数据库建立缓存"><a href="#查询数据库建立缓存" class="headerlink" title="查询数据库建立缓存"></a>查询数据库建立缓存</h3><p>首先还是熟悉的分布式锁限流并且防止并发问题，</p>
<ul>
<li>确保只有一个线程能够进入关键逻辑，从而避免数据不一致。</li>
</ul>
<p>加了锁，进入锁逻辑之后，我们还是要再判断一下，在我们获取锁加锁的过程当中，是不是有线程重建了缓存。</p>
<p><code>if (distributedCache.hasKey(QUERY_ALL_REGION_LIST)) &#123;    ... &#125;</code></p>
<p>再次检查 Redis 中是否已经存在 <code>QUERY_ALL_REGION_LIST</code> 的缓存。</p>
<p>如果缓存存在，说明其他线程已经加载了数据。就不用再重复加载缓存了</p>
<p>再验证缓存当中的数据是不是符合要求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">actualExistList = hashOperations.multiGet(</span><br><span class="line">    QUERY_ALL_REGION_LIST,</span><br><span class="line">    ListUtil.toList(requestParam.getFromStation(), requestParam.getToStation())</span><br><span class="line">);</span><br><span class="line">emptyCount = actualExistList.stream().filter(Objects::nonNull).count();</span><br></pre></td></tr></table></figure>

<ul>
<li>如果缓存中的数据仍然无效（例如出发地或目的地不存在），抛出异常。</li>
<li>如果缓存中的数据有效，直接返回。</li>
</ul>
<p>假如没有这一步，这其实是很轻量级的一步，可能就一直会重建一遍内存，还会有数据不一致的状态</p>
<h4 id="建立缓存"><a href="#建立缓存" class="headerlink" title="建立缓存"></a>建立缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;RegionDO&gt; regionDOList = regionMapper.selectList(Wrappers.emptyWrapper());</span><br><span class="line">List&lt;StationDO&gt; stationDOList = stationMapper.selectList(Wrappers.emptyWrapper());</span><br></pre></td></tr></table></figure>

<p><code>emptyWrapper()</code> 的使用是为了加载所有区域（<code>Region</code>）和车站（<code>Station</code>）的数据到缓存中。它表示不添加任何查询条件，即查询表中的所有记录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Object, Object&gt; regionValueMap = Maps.newHashMap();</span><br><span class="line">            <span class="keyword">for</span> (RegionDO each : regionDOList) &#123;</span><br><span class="line">                regionValueMap.put(each.getCode(), each.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (StationDO each : stationDOList) &#123;</span><br><span class="line">                regionValueMap.put(each.getCode(), each.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            hashOperations.putAll(QUERY_ALL_REGION_LIST, regionValueMap);</span><br><span class="line">            CACHE_DATA_ISNULL_AND_LOAD_FLAG = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>重建全量的缓存，并且把缓存重建的标志设置为true</p>
<h4 id="后处理-1"><a href="#后处理-1" class="headerlink" title="后处理"></a>后处理</h4><p>缓存重建之后，还需要再一步验证</p>
<p>即使完成了缓存重建（即从数据库加载所有区域和车站数据并写入缓存），也不能保证用户请求的出发地和目的地一定有效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> matchedCount=<span class="number">0</span>;</span><br><span class="line">matchedCount = regionValueMap.keySet().stream()</span><br><span class="line">        .filter(each -&gt; StrUtil.equalsAny(each.toString(), requestParam.getFromStation(), requestParam.getToStation()))</span><br><span class="line">        .count();</span><br><span class="line"><span class="keyword">if</span> (matchedCount != <span class="number">2L</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClientException</span>(<span class="string">&quot;出发地或目的地不存在&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>匹配成功的数值还是不是2的话，那还是失败的</p>
<hr>
<p>最后的最后，这些校验规则总结成一行代码</p>
<p><code>ticketPageQueryAbstractChainContext.handler(TicketChainMarkEnum.TRAIN_QUERY_FILTER.name(), requestParam);</code></p>
<h2 id="加载城市数据"><a href="#加载城市数据" class="headerlink" title="加载城市数据"></a>加载城市数据</h2><p>12306 站点查询实际功能中，比如你搜索了北京南到杭州东的搜索条件，它会帮你列出北京到杭州所有的列车车次。这个很好实现，直接通过站点关联到城市，通过城市查询列车即可。</p>
<p>我们在缓存中，有一个 Hash 结构数据，专门负责保存列车站点 Code 值与城市之间的关联关系。</p>
<p>Redis当中的Hash结构，它是一个string类型的field和value的映射表，一个key可对应多个field，一个field对应一个value；其中value只能是字符串，不能嵌套其他类型。</p>
<p>可以这么理解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Key: REGION_TRAIN_STATION_MAPPING</span><br><span class="line">Fields:</span><br><span class="line">  &quot;北京站&quot; -&gt; &#123;&quot;name&quot;: &quot;北京站&quot;, &quot;location&quot;: &quot;北京市&quot;&#125;</span><br><span class="line">  &quot;上海站&quot; -&gt; &#123;&quot;name&quot;: &quot;上海站&quot;, &quot;location&quot;: &quot;上海市&quot;&#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>老样子，先贴出源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; stationDetails = stringRedisTemplate.opsForHash()</span><br><span class="line">                .multiGet(REGION_TRAIN_STATION_MAPPING, Lists.newArrayList(requestParam.getFromStation(), requestParam.getToStation()));</span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stationDetails.stream().filter(Objects::isNull).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(LOCK_REGION_TRAIN_STATION_MAPPING);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stationDetails = stringRedisTemplate.opsForHash()</span><br><span class="line">                        .multiGet(REGION_TRAIN_STATION_MAPPING, Lists.newArrayList(requestParam.getFromStation(), requestParam.getToStation()));</span><br><span class="line">                count = stationDetails.stream().filter(Objects::isNull).count();</span><br><span class="line">                <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    List&lt;StationDO&gt; stationDOList = stationMapper.selectList(Wrappers.emptyWrapper());</span><br><span class="line">                    Map&lt;String, String&gt; regionTrainStationMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    stationDOList.forEach(each -&gt; regionTrainStationMap.put(each.getCode(), each.getRegionName()));</span><br><span class="line">                    stringRedisTemplate.opsForHash().putAll(REGION_TRAIN_STATION_MAPPING, regionTrainStationMap);</span><br><span class="line">                    stationDetails = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                    stationDetails.add(regionTrainStationMap.get(requestParam.getFromStation()));</span><br><span class="line">                    stationDetails.add(regionTrainStationMap.get(requestParam.getToStation()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="批量查询方式获取出发站点和到达站点对应的城市集合"><a href="#批量查询方式获取出发站点和到达站点对应的城市集合" class="headerlink" title="批量查询方式获取出发站点和到达站点对应的城市集合"></a>批量查询方式获取出发站点和到达站点对应的城市集合</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; stationDetails = stringRedisTemplate.opsForHash()</span><br><span class="line">        .multiGet(REGION_TRAIN_STATION_MAPPING, Lists.newArrayList(requestParam.getFromStation(), requestParam.getToStation()));</span><br></pre></td></tr></table></figure>

<p>原因还是一如既往地减少网络IO</p>
<h3 id="校验判空和加载数据库逻辑"><a href="#校验判空和加载数据库逻辑" class="headerlink" title="校验判空和加载数据库逻辑"></a>校验判空和加载数据库逻辑</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stationDetails.stream().filter(Objects::isNull).count();</span><br><span class="line"><span class="comment">// 如果城市数据为空，代表缓存中没有这个值，需要从数据库加载</span></span><br><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 避免缓存击穿，通过分布式锁方式解决该问题</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(LOCK_REGION_TRAIN_STATION_MAPPING);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 双重判定锁，规避数据库无效请求</span></span><br><span class="line">        stationDetails = stringRedisTemplate.opsForHash()</span><br><span class="line">                .multiGet(REGION_TRAIN_STATION_MAPPING, Lists.newArrayList(requestParam.getFromStation(), requestParam.getToStation()));</span><br><span class="line">        count = stationDetails.stream().filter(Objects::isNull).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 查询列车站点数据与城市信息</span></span><br><span class="line">            List&lt;StationDO&gt; stationDOList = stationMapper.selectList(Wrappers.emptyWrapper());</span><br><span class="line">            Map&lt;String, String&gt; regionTrainStationMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            stationDOList.forEach(each -&gt; regionTrainStationMap.put(each.getCode(), each.getRegionName()));</span><br><span class="line">            <span class="comment">// 通过 putAll 批量保存方式存入 Redis，避免多次 put 网络 IO 消耗</span></span><br><span class="line">            stringRedisTemplate.opsForHash().putAll(REGION_TRAIN_STATION_MAPPING, regionTrainStationMap);</span><br><span class="line">            stationDetails = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            stationDetails.add(regionTrainStationMap.get(requestParam.getFromStation()));</span><br><span class="line">            stationDetails.add(regionTrainStationMap.get(requestParam.getToStation()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是使用双重判定锁再去查询缓存。避免缓存重复加载。</p>
<hr>
<p>我刚才想到一个问题，在责任链校验的过程当中，我们经过校验的参数是一定合理的。校验的参数是什么呢？无非就是三个</p>
<ul>
<li>出发地点</li>
<li>到达地点</li>
<li>出发时间</li>
</ul>
<p>但是对于下面这个分页查询的实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 车票分页查询请求参数</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TicketPageQueryReqDTO</span> <span class="keyword">extends</span> <span class="title class_">PageRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发地 Code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String fromStation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目的地 Code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String toStation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date departureDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发站点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String departure;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到达站点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String arrival;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>出发站点和到达站点是什么呢</p>
<p>我觉得其实没用到，因为在我们查询的请求当中，可以分为两种</p>
<p>假如你使用站点作为出发地code，那再好不过，因为在redis存储的结构当中，我们的key就是站点code。value关联城市名称。查询的时候，就是通过站点关联到城市，通过城市查询列车即可。那假如我用了城市查询列车怎么办。其实我觉得还可以设计一个默认逻辑。比如对于输入的是城市，我们默认指定站点</p>
<p><strong>上面的都是废话</strong></p>
<hr>
<p>梳理一下加载城市数据的部分</p>
<p>其实我刚才没搞懂的就是，因为输入参数可以是城市，可以是站点。那我怎么决断呢？好像这个代码当中没有进行这样的判断</p>
<p>其实是有的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; stationDetails = stringRedisTemplate.opsForHash()</span><br><span class="line">        .multiGet(REGION_TRAIN_STATION_MAPPING, Lists.newArrayList(requestParam.getFromStation(), requestParam.getToStation()));</span><br><span class="line"><span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stationDetails.stream().filter(Objects::isNull).count();</span><br></pre></td></tr></table></figure>

<p>这个count，其实是代表着能不能从哈希结构当中，查到城市数据。而不是查到站点数据。这个城市数据是起始站点和结束站点的对应的城市。</p>
<p>假如这个count不为0，那就说明有的城市数据在缓存当中，是查询不到的。就不能满足我们加载城市数据的要求，也就不能满足我们通过城市数据，关联城市之下站点的要求。</p>
<h2 id="查询列车站点信息"><a href="#查询列车站点信息" class="headerlink" title="查询列车站点信息"></a>查询列车站点信息</h2><p>我们上面其实最终确定的，或者说最终加入到stationDetails当中的，是FromStation对应的code再对应的城市，还有getToStation对应的城市</p>
<p>总而言之第一步，就是不管你输入了什么，我把城市信息给你弄出来，在这一步查询列车信息</p>
<p>老样子，先贴源代码，再说步骤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">List&lt;TicketListDTO&gt; seatResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">buildRegionTrainStationHashKey</span> <span class="operator">=</span> String.format(REGION_TRAIN_STATION, stationDetails.get(<span class="number">0</span>), stationDetails.get(<span class="number">1</span>));</span><br><span class="line">        Map&lt;Object, Object&gt; regionTrainStationAllMap = stringRedisTemplate.opsForHash().entries(buildRegionTrainStationHashKey);</span><br><span class="line">        <span class="keyword">if</span> (MapUtil.isEmpty(regionTrainStationAllMap)) &#123;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(LOCK_REGION_TRAIN_STATION);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                regionTrainStationAllMap = stringRedisTemplate.opsForHash().entries(buildRegionTrainStationHashKey);</span><br><span class="line">                <span class="keyword">if</span> (MapUtil.isEmpty(regionTrainStationAllMap)) &#123;</span><br><span class="line">                    LambdaQueryWrapper&lt;TrainStationRelationDO&gt; queryWrapper = Wrappers.lambdaQuery(TrainStationRelationDO.class)</span><br><span class="line">                            .eq(TrainStationRelationDO::getStartRegion, stationDetails.get(<span class="number">0</span>))</span><br><span class="line">                            .eq(TrainStationRelationDO::getEndRegion, stationDetails.get(<span class="number">1</span>));</span><br><span class="line">                    List&lt;TrainStationRelationDO&gt; trainStationRelationList = trainStationRelationMapper.selectList(queryWrapper);</span><br><span class="line">                    <span class="keyword">for</span> (TrainStationRelationDO each : trainStationRelationList) &#123;</span><br><span class="line">                        <span class="type">TrainDO</span> <span class="variable">trainDO</span> <span class="operator">=</span> distributedCache.safeGet(</span><br><span class="line">                                TRAIN_INFO + each.getTrainId(),</span><br><span class="line">                                TrainDO.class,</span><br><span class="line">                                () -&gt; trainMapper.selectById(each.getTrainId()),</span><br><span class="line">                                ADVANCE_TICKET_DAY,</span><br><span class="line">                                TimeUnit.DAYS);</span><br><span class="line">                        <span class="type">TicketListDTO</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketListDTO</span>();</span><br><span class="line">                        result.setTrainId(String.valueOf(trainDO.getId()));</span><br><span class="line">                        result.setTrainNumber(trainDO.getTrainNumber());</span><br><span class="line">                        result.setDepartureTime(convertDateToLocalTime(each.getDepartureTime(), <span class="string">&quot;HH:mm&quot;</span>));</span><br><span class="line">                        result.setArrivalTime(convertDateToLocalTime(each.getArrivalTime(), <span class="string">&quot;HH:mm&quot;</span>));</span><br><span class="line">                        result.setDuration(DateUtil.calculateHourDifference(each.getDepartureTime(), each.getArrivalTime()));</span><br><span class="line">                        result.setDeparture(each.getDeparture());</span><br><span class="line">                        result.setArrival(each.getArrival());</span><br><span class="line">                        result.setDepartureFlag(each.getDepartureFlag());</span><br><span class="line">                        result.setArrivalFlag(each.getArrivalFlag());</span><br><span class="line">                        result.setTrainType(trainDO.getTrainType());</span><br><span class="line">                        result.setTrainBrand(trainDO.getTrainBrand());</span><br><span class="line">                        <span class="keyword">if</span> (StrUtil.isNotBlank(trainDO.getTrainTag())) &#123;</span><br><span class="line">                            result.setTrainTags(StrUtil.split(trainDO.getTrainTag(), <span class="string">&quot;,&quot;</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">betweenDay</span> <span class="operator">=</span> cn.hutool.core.date.DateUtil.betweenDay(each.getDepartureTime(), each.getArrivalTime(), <span class="literal">false</span>);</span><br><span class="line">                        result.setDaysArrived((<span class="type">int</span>) betweenDay);</span><br><span class="line">                        result.setSaleStatus(<span class="keyword">new</span> <span class="title class_">Date</span>().after(trainDO.getSaleTime()) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">                        result.setSaleTime(convertDateToLocalTime(trainDO.getSaleTime(), <span class="string">&quot;MM-dd HH:mm&quot;</span>));</span><br><span class="line">                        seatResults.add(result);</span><br><span class="line">                        regionTrainStationAllMap.put(CacheUtil.buildKey(String.valueOf(each.getTrainId()), each.getDeparture(), each.getArrival()), JSON.toJSONString(result));</span><br><span class="line">                    &#125;</span><br><span class="line">                    stringRedisTemplate.opsForHash().putAll(buildRegionTrainStationHashKey, regionTrainStationAllMap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="根据城市信息查询城市下站点信息"><a href="#根据城市信息查询城市下站点信息" class="headerlink" title="根据城市信息查询城市下站点信息"></a>根据城市信息查询城市下站点信息</h3><p>这一步当中用的是另一个RedisHash结构，key为<code>REGION_TRAIN_STATION</code></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pE5l6aD"><img src="https://s21.ax1x.com/2025/04/21/pE5l6aD.png" alt="pE5l6aD.png"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;TicketListDTO&gt; seatResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// 构建查询 Redis 中 Hash 结构 Key，Key前缀 + 出发城市 + 到达城市</span></span><br><span class="line"><span class="type">String</span> <span class="variable">buildRegionTrainStationHashKey</span> <span class="operator">=</span> String.format(REGION_TRAIN_STATION, stationDetails.get(<span class="number">0</span>), stationDetails.get(<span class="number">1</span>));</span><br><span class="line">Map&lt;Object, Object&gt; regionTrainStationAllMap = stringRedisTemplate.opsForHash().entries(buildRegionTrainStationHashKey);</span><br></pre></td></tr></table></figure>

<p>假如redis第一次初始化，肯定是查不到什么东西了。我们就继续构建缓存</p>
<h3 id="构建缓存"><a href="#构建缓存" class="headerlink" title="构建缓存"></a>构建缓存</h3><p>构建谁的缓存呢，当然是 <code>出发城市-到达城市：当中的列车信息</code>这样一套Hash缓存</p>
<p>条件判空和获取分布式锁以及双重判定锁就不贴代码了</p>
<p>首先我们在<code>t_train_station_relation</code>当中，也就是列车和站点关系实体当中，进行查询</p>
<p>因为这个表，或者关系实体里面，包含两个我们需要的字段，并且还是我们能提供的字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 起始城市</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String startRegion;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 终点城市</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String endRegion;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LambdaQueryWrapper&lt;TrainStationRelationDO&gt; queryWrapper = Wrappers.lambdaQuery(TrainStationRelationDO.class)</span><br><span class="line">        .eq(TrainStationRelationDO::getStartRegion, stationDetails.get(<span class="number">0</span>))</span><br><span class="line">        .eq(TrainStationRelationDO::getEndRegion, stationDetails.get(<span class="number">1</span>));</span><br><span class="line">List&lt;TrainStationRelationDO&gt; trainStationRelationList = trainStationRelationMapper.selectList(queryWrapper);</span><br></pre></td></tr></table></figure>

<p>通过对我们拿到的城市进行查询，我们就能找到城市之下，列车和站点的关系，也就是<code>trainStationRelationList</code></p>
<p>DO代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列车站点关系实体</span></span><br><span class="line"><span class="comment"> * 公众号：马丁玩编程，回复：加群，添加马哥微信（备注：12306）获取项目资料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;t_train_station_relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainStationRelationDO</span> <span class="keyword">extends</span> <span class="title class_">BaseDO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long trainId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发站点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String departure;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到达站点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String arrival;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 起始城市</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String startRegion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 终点城市</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String endRegion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 始发站标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean departureFlag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 终点站标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean arrivalFlag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date departureTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到达时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date arrivalTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步，就是根据这个结果，从分布式缓存当中，拿到列车的信息。假如有缓存我们肯定要优先使用缓存，速度快，成本低，毋庸置疑。缓存当中没有，就去数据库拿就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">TrainDO</span> <span class="variable">trainDO</span> <span class="operator">=</span> distributedCache.safeGet(</span><br><span class="line">    TRAIN_INFO + each.getTrainId(),  <span class="comment">// 缓存Key</span></span><br><span class="line">    TrainDO.class,                   <span class="comment">// 返回值类型</span></span><br><span class="line">    () -&gt; trainMapper.selectById(each.getTrainId()),  <span class="comment">// 缓存未命中时的数据加载逻辑</span></span><br><span class="line">    ADVANCE_TICKET_DAY,              <span class="comment">// 缓存过期时间</span></span><br><span class="line">    TimeUnit.DAYS                    <span class="comment">// 时间单位</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这段代码执行结束之后，<code>trainStationRelationList</code>对应的<code>trainDO</code>就构建完成了</p>
<h4 id="数据构建"><a href="#数据构建" class="headerlink" title="数据构建"></a>数据构建</h4><p>接下来就是用上我们上面查到的所有数据，构建一个result出来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TicketListDTO</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketListDTO</span>();</span><br><span class="line">result.setTrainId(String.valueOf(trainDO.getId()));</span><br><span class="line">result.setTrainNumber(trainDO.getTrainNumber());</span><br><span class="line">result.setDepartureTime(convertDateToLocalTime(each.getDepartureTime(), <span class="string">&quot;HH:mm&quot;</span>));</span><br><span class="line">result.setArrivalTime(convertDateToLocalTime(each.getArrivalTime(), <span class="string">&quot;HH:mm&quot;</span>));</span><br><span class="line">result.setDuration(DateUtil.calculateHourDifference(each.getDepartureTime(), each.getArrivalTime()));</span><br><span class="line">result.setDeparture(each.getDeparture());</span><br><span class="line">result.setArrival(each.getArrival());</span><br><span class="line">result.setDepartureFlag(each.getDepartureFlag());</span><br><span class="line">result.setArrivalFlag(each.getArrivalFlag());</span><br><span class="line">result.setTrainType(trainDO.getTrainType());</span><br><span class="line">result.setTrainBrand(trainDO.getTrainBrand());</span><br></pre></td></tr></table></figure>

<ol>
<li>创建新的<code>TicketListDTO</code>对象</li>
<li>设置基础列车信息：<ul>
<li>列车ID(<code>trainId</code>)</li>
<li>车次号(<code>trainNumber</code>)</li>
<li>列车类型(<code>trainType</code>)</li>
<li>列车品牌(<code>trainBrand</code>)</li>
</ul>
</li>
<li>设置行程信息：<ul>
<li>出发时间(<code>departureTime</code>)，格式化为”HH:mm”</li>
<li>到达时间(<code>arrivalTime</code>)，格式化为”HH:mm”</li>
<li>行程时长(<code>duration</code>)，计算出发和到达时间差</li>
<li>出发站(<code>departure</code>)</li>
<li>到达站(<code>arrival</code>)</li>
<li>出发站标志(<code>departureFlag</code>)</li>
<li>到达站标志(<code>arrivalFlag</code>)</li>
</ul>
</li>
</ol>
<h4 id="附加信息处理模块"><a href="#附加信息处理模块" class="headerlink" title="附加信息处理模块"></a>附加信息处理模块</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(trainDO.getTrainTag())) &#123;</span><br><span class="line">    result.setTrainTags(StrUtil.split(trainDO.getTrainTag(), <span class="string">&quot;,&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="variable">betweenDay</span> <span class="operator">=</span> cn.hutool.core.date.DateUtil.betweenDay(each.getDepartureTime(), each.getArrivalTime(), <span class="literal">false</span>);</span><br><span class="line">result.setDaysArrived((<span class="type">int</span>) betweenDay);</span><br></pre></td></tr></table></figure>

<ol>
<li>检查并处理列车标签：<ul>
<li>如果<code>trainTag</code>不为空，按逗号分割为列表</li>
<li>设置到<code>trainTags</code>字段</li>
</ul>
</li>
<li>计算行程是否跨天：<ul>
<li>使用<code>DateUtil.betweenDay</code>计算出发和到达时间之间的天数差</li>
<li>设置到<code>daysArrived</code>字段</li>
</ul>
</li>
</ol>
<h4 id="售票状态处理"><a href="#售票状态处理" class="headerlink" title="售票状态处理"></a>售票状态处理</h4><p>判断并设置列车的售票状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result.setSaleStatus(<span class="keyword">new</span> <span class="title class_">Date</span>().after(trainDO.getSaleTime()) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">result.setSaleTime(convertDateToLocalTime(trainDO.getSaleTime(), <span class="string">&quot;MM-dd HH:mm&quot;</span>));</span><br></pre></td></tr></table></figure>

<ol>
<li>判断售票状态：<ul>
<li>当前时间晚于售票时间(<code>saleTime</code>)：设置为0(已开售)</li>
<li>当前时间早于售票时间：设置为1(未开售)</li>
</ul>
</li>
<li>格式化售票时间：<ul>
<li>将<code>saleTime</code>格式化为”MM-dd HH:mm”格式</li>
</ul>
</li>
</ol>
<h4 id="结果收集模块"><a href="#结果收集模块" class="headerlink" title="结果收集模块"></a>结果收集模块</h4><p>收集处理完的DTO对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seatResults.add(result);</span><br></pre></td></tr></table></figure>

<p>把这个result添加到坐席集合当中，其实叫坐席集合不一定准确，但是我们筛选坐席，是需要靠这个车次信息的。</p>
<h4 id="缓存处理模块"><a href="#缓存处理模块" class="headerlink" title="缓存处理模块"></a>缓存处理模块</h4><p>将处理后的数据存入Redis缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">regionTrainStationAllMap.put(CacheUtil.buildKey(String.valueOf(each.getTrainId()), each.getDeparture(), each.getArrival()), JSON.toJSONString(result));</span><br><span class="line">stringRedisTemplate.opsForHash().putAll(buildRegionTrainStationHashKey, regionTrainStationAllMap);</span><br></pre></td></tr></table></figure>

<ol>
<li>构建缓存Key：<ul>
<li>使用<code>CacheUtil.buildKey</code>生成唯一Key，格式为”trainId:departure:arrival”</li>
</ul>
</li>
<li>序列化数据：<ul>
<li>将<code>TicketListDTO</code>对象转为JSON字符串</li>
</ul>
</li>
<li>存入本地Map：<ul>
<li>以Key-Value形式存入<code>regionTrainStationAllMap</code></li>
</ul>
</li>
<li>批量写入Redis：<ul>
<li>使用<code>stringRedisTemplate.opsForHash().putAll</code>将整个Map写入Redis哈希结构</li>
</ul>
</li>
</ol>
<h2 id="查询列车余票信息"><a href="#查询列车余票信息" class="headerlink" title="查询列车余票信息"></a>查询列车余票信息</h2><p>列车余票数据是实时变更的，如果在存储到基本信息中，就没办法变更了，所以单独存储。</p>
<h3 id="数据初始化与回退"><a href="#数据初始化与回退" class="headerlink" title="数据初始化与回退"></a>数据初始化与回退</h3><p>确保<code>seatResults</code>有数据，如果为空则从缓存Map中获取。seatResults其实是车票的集合，但是还没有和票价匹配，也没有做余量的限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seatResults = CollUtil.isEmpty(seatResults)</span><br><span class="line">        ? regionTrainStationAllMap.values().stream().map(each -&gt; JSON.parseObject(each.toString(), TicketListDTO.class)).toList()</span><br><span class="line">        : seatResults;</span><br></pre></td></tr></table></figure>

<p>在多线程环境下，<code>seatResults</code>可能被意外清空，多加一层保护，不是坏事</p>
<h3 id="数据排序"><a href="#数据排序" class="headerlink" title="数据排序"></a>数据排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seatResults = seatResults.stream().sorted(new TimeStringComparator()).toList();</span><br></pre></td></tr></table></figure>

<p>通过时间比较器对座位进行排序，比较的是出发时间。出发时间越早，排序越靠前</p>
<p>先转换为流之后转换为list集合</p>
<h3 id="座位价格与余量处理"><a href="#座位价格与余量处理" class="headerlink" title="座位价格与余量处理"></a>座位价格与余量处理</h3><p>为每趟列车查询座位价格和余量信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历处理每趟列车的信息</span></span><br><span class="line"><span class="keyword">for</span> (TicketListDTO each : seatResults) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 获取座位价格信息（缓存优先策略）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 使用分布式缓存安全获取数据，逻辑如下：</span></span><br><span class="line"><span class="comment">     * - 先尝试从缓存读取</span></span><br><span class="line"><span class="comment">     * - 若缓存不存在/失效，则执行Lambda表达式从数据库查询</span></span><br><span class="line"><span class="comment">     * - 查询结果会自动写入缓存</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 参数说明：</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存键，格式：&quot;TRAIN_STATION_PRICE:&#123;trainId&#125;:&#123;departure&#125;:&#123;arrival&#125;&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String.class 返回值类型（JSON字符串）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> () -&gt; &#123;...&#125; 缓存未命中时的数据加载逻辑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ADVANCE_TICKET_DAY 缓存过期时间（天数）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> TimeUnit.DAYS 时间单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trainStationPriceStr</span> <span class="operator">=</span> distributedCache.safeGet(</span><br><span class="line">            String.format(TRAIN_STATION_PRICE, each.getTrainId(), each.getDeparture(), each.getArrival()),</span><br><span class="line">            String.class,</span><br><span class="line">            () -&gt; &#123;</span><br><span class="line">                <span class="comment">// 构建MyBatis-Plus查询条件：查询指定车次、出发站、到达站的票价信息</span></span><br><span class="line">                LambdaQueryWrapper&lt;TrainStationPriceDO&gt; queryWrapper = Wrappers.lambdaQuery(TrainStationPriceDO.class)</span><br><span class="line">                        .eq(TrainStationPriceDO::getDeparture, each.getDeparture())  <span class="comment">// 出发站匹配</span></span><br><span class="line">                        .eq(TrainStationPriceDO::getArrival, each.getArrival())      <span class="comment">// 到达站匹配</span></span><br><span class="line">                        .eq(TrainStationPriceDO::getTrainId, each.getTrainId());     <span class="comment">// 车次ID匹配</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 执行查询并将结果转为JSON字符串（便于缓存存储）</span></span><br><span class="line">                <span class="keyword">return</span> JSON.toJSONString(trainStationPriceMapper.selectList(queryWrapper));</span><br><span class="line">            &#125;,</span><br><span class="line">            ADVANCE_TICKET_DAY,</span><br><span class="line">            TimeUnit.DAYS</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. 处理座位余量信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 将缓存/数据库查询得到的JSON字符串反序列化为对象列表</span></span><br><span class="line"><span class="comment">     * 格式：List&lt;TrainStationPriceDO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;TrainStationPriceDO&gt; trainStationPriceDOList = JSON.parseArray(trainStationPriceStr, TrainStationPriceDO.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化座位类型列表（用于前端展示）</span></span><br><span class="line">    List&lt;SeatClassDTO&gt; seatClassList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 3. 遍历每个座位价格信息，组装完整座位数据</span></span><br><span class="line"><span class="comment">             * 为什么循环遍历座位价格数据，就能获取到座位对应的余票呢</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * 核心逻辑在于 **票价和余票的关联是通过相同的业务主键（列车+区间+座位类型）绑定**</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * 遍历票价数据时，每一条票价记录天然包含 **列车ID、出发站、到达站、座位类型**，这些字段组合即可唯一确定余票的存储位置：</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    trainStationPriceDOList.forEach(item -&gt; &#123;</span><br><span class="line">        <span class="comment">// 3.1 获取座位类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">seatType</span> <span class="operator">=</span> String.valueOf(item.getSeatType());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.2 构建Redis查询Key后缀（格式：&quot;&#123;trainId&#125;_&#123;departure&#125;_&#123;arrival&#125;&quot;）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;_&quot;</span>, each.getTrainId(), item.getDeparture(), item.getArrival());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 3.3 从Redis获取实时余票数量</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Redis数据结构：</span></span><br><span class="line"><span class="comment">         * - Key: &quot;TRAIN_STATION_REMAINING_TICKET:&#123;trainId&#125;_&#123;departure&#125;_&#123;arrival&#125;&quot;</span></span><br><span class="line"><span class="comment">         * - Field: 座位类型（如&quot;1&quot;、&quot;2&quot;等）</span></span><br><span class="line"><span class="comment">         * - Value: 剩余票数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">quantityObj</span> <span class="operator">=</span> stringRedisTemplate.opsForHash()</span><br><span class="line">                .get(TRAIN_STATION_REMAINING_TICKET + keySuffix, seatType);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 3.4 处理余量信息（多级获取策略）</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 优先级：</span></span><br><span class="line"><span class="comment">         * 1. 先尝试从Redis获取实时余量</span></span><br><span class="line"><span class="comment">         * 2. 若Redis没有，则通过seatMarginCacheLoader加载</span></span><br><span class="line"><span class="comment">         * 3. 最终回退到0（防止NPE）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">quantity</span> <span class="operator">=</span> Optional.ofNullable(quantityObj)  <span class="comment">// 处理可能为null的情况</span></span><br><span class="line">                .map(Object::toString)                  <span class="comment">// 转为字符串</span></span><br><span class="line">                .map(Integer::parseInt)                 <span class="comment">// 转为整数</span></span><br><span class="line">                .orElseGet(() -&gt; &#123;                     <span class="comment">// 若Redis无数据，执行回退逻辑</span></span><br><span class="line">                    <span class="comment">// 通过缓存加载器获取余量数据</span></span><br><span class="line">                    Map&lt;String, String&gt; seatMarginMap = seatMarginCacheLoader.load(</span><br><span class="line">                            String.valueOf(each.getTrainId()), </span><br><span class="line">                            seatType, </span><br><span class="line">                            item.getDeparture(), </span><br><span class="line">                            item.getArrival());</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 从加载的数据中获取对应座位类型的余量</span></span><br><span class="line">                    <span class="keyword">return</span> Optional.ofNullable(seatMarginMap.get(String.valueOf(item.getSeatType())))</span><br><span class="line">                            .map(Integer::parseInt)</span><br><span class="line">                            .orElse(<span class="number">0</span>);  <span class="comment">// 最终回退到0</span></span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 3.5 构建座位类型DTO</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 包含：</span></span><br><span class="line"><span class="comment">         * - seatType: 座位类型</span></span><br><span class="line"><span class="comment">         * - quantity: 剩余数量</span></span><br><span class="line"><span class="comment">         * - price: 价格（除以100转为元单位，保留1位小数）</span></span><br><span class="line"><span class="comment">         * - 其他业务标记（如本例中的false）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        seatClassList.add(<span class="keyword">new</span> <span class="title class_">SeatClassDTO</span>(</span><br><span class="line">                item.getSeatType(),                     <span class="comment">// 座位类型</span></span><br><span class="line">                quantity,                               <span class="comment">// 余量</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getPrice())          <span class="comment">// 价格处理：</span></span><br><span class="line">                    .divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;100&quot;</span>),      <span class="comment">// 1. 除以100（分转元）</span></span><br><span class="line">                    <span class="number">1</span>,                                  <span class="comment">// 2. 保留1位小数</span></span><br><span class="line">                    RoundingMode.HALF_UP),              <span class="comment">// 3. 四舍五入</span></span><br><span class="line">                <span class="literal">false</span>));                                <span class="comment">// 业务标记（如&quot;是否可选&quot;）</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将组装好的座位列表设置到车次信息中</span></span><br><span class="line">    each.setSeatClassList(seatClassList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="响应构建"><a href="#响应构建" class="headerlink" title="响应构建"></a>响应构建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> TicketPageQueryRespDTO.builder()</span><br><span class="line">        .trainList(seatResults)</span><br><span class="line">        .departureStationList(buildDepartureStationList(seatResults))</span><br><span class="line">        .arrivalStationList(buildArrivalStationList(seatResults))</span><br><span class="line">        .trainBrandList(buildTrainBrandList(seatResults))</span><br><span class="line">        .seatClassTypeList(buildSeatClassList(seatResults))</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<h1 id="列车信息查询V2"><a href="#列车信息查询V2" class="headerlink" title="列车信息查询V2"></a>列车信息查询V2</h1><p>以下是对完整代码的 <strong>逐方法详细注释</strong>，包含每个方法的用途、参数说明、实现逻辑和关键点解释：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * V2版本车票分页查询接口 - 企业级高并发优化实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestParam 查询参数(DTO)，包含出发站、到达站、日期等信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 车票分页查询响应，包含列车列表、站点信息、座位类型等</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> 相比V1版本性能提升300%-500%，采用多级缓存+批量操作优化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TicketPageQueryRespDTO <span class="title function_">pageListTicketQueryV2</span><span class="params">(TicketPageQueryReqDTO requestParam)</span> &#123;</span><br><span class="line">    <span class="comment">// ===================== 1. 参数校验阶段 =====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 责任链模式校验参数：</span></span><br><span class="line"><span class="comment">     * 1. 验证城市名称是否存在</span></span><br><span class="line"><span class="comment">     * 2. 检查出发日期是否有效（不小于当前日期）</span></span><br><span class="line"><span class="comment">     * 3. 其他业务规则校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> TicketChainMarkEnum.TRAIN_QUERY_FILTER 定义的责任链节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ticketPageQueryAbstractChainContext.handler(TicketChainMarkEnum.TRAIN_QUERY_FILTER.name(), requestParam);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取Redis操作实例（根据配置可能指向不同环境的缓存）</span></span><br><span class="line">    <span class="type">StringRedisTemplate</span> <span class="variable">stringRedisTemplate</span> <span class="operator">=</span> (StringRedisTemplate) distributedCache.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 2. 基础数据准备阶段 =====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从Redis哈希表获取车站详细信息：</span></span><br><span class="line"><span class="comment">     * - REGION_TRAIN_STATION_MAPPING: 车站名称到编码的映射表</span></span><br><span class="line"><span class="comment">     * - 一次性获取出发站和到达站的编码等信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Object&gt; stationDetails = stringRedisTemplate.opsForHash()</span><br><span class="line">            .multiGet(REGION_TRAIN_STATION_MAPPING, </span><br><span class="line">                     Lists.newArrayList(requestParam.getFromStation(), requestParam.getToStation()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建列车班次缓存Key：</span></span><br><span class="line"><span class="comment">     * - 格式：REGION_TRAIN_STATION:&#123;出发站编码&#125;:&#123;到达站编码&#125;</span></span><br><span class="line"><span class="comment">     * - 例如：REGION_TRAIN_STATION:BJSH:SHBZ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">buildRegionTrainStationHashKey</span> <span class="operator">=</span> String.format(</span><br><span class="line">            REGION_TRAIN_STATION, </span><br><span class="line">            stationDetails.get(<span class="number">0</span>), </span><br><span class="line">            stationDetails.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量获取该路线下的所有列车班次信息（Hash结构存储）</span></span><br><span class="line">    Map&lt;Object, Object&gt; regionTrainStationAllMap = stringRedisTemplate.opsForHash()</span><br><span class="line">            .entries(buildRegionTrainStationHashKey);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 3. 列车数据处理阶段 =====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据转换与排序：</span></span><br><span class="line"><span class="comment">     * 1. 将Redis中的JSON字符串反序列化为TicketListDTO对象</span></span><br><span class="line"><span class="comment">     * 2. 使用TimeStringComparator按出发时间排序</span></span><br><span class="line"><span class="comment">     * 3. 转换为不可变List保证线程安全</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;TicketListDTO&gt; seatResults = regionTrainStationAllMap.values().stream()</span><br><span class="line">            .map(each -&gt; JSON.parseObject(each.toString(), TicketListDTO.class))</span><br><span class="line">            .sorted(<span class="keyword">new</span> <span class="title class_">TimeStringComparator</span>()) <span class="comment">// 自定义时间比较器（实现Comparator接口）</span></span><br><span class="line">            .toList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 4. 批量获取价格信息 =====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建所有列车价格信息的Redis Key列表：</span></span><br><span class="line"><span class="comment">     * - 格式：&#123;前缀&#125;TRAIN_STATION_PRICE:&#123;车次ID&#125;:&#123;出发站&#125;:&#123;到达站&#125;</span></span><br><span class="line"><span class="comment">     * - 例如：cache:TRAIN_STATION_PRICE:G123:BJSH:SHBZ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;String&gt; trainStationPriceKeys = seatResults.stream()</span><br><span class="line">            .map(each -&gt; String.format(</span><br><span class="line">                    cacheRedisPrefix + TRAIN_STATION_PRICE, </span><br><span class="line">                    each.getTrainId(), </span><br><span class="line">                    each.getDeparture(), </span><br><span class="line">                    each.getArrival()))</span><br><span class="line">            .toList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用Redis管道批量获取价格信息：</span></span><br><span class="line"><span class="comment">     * - 管道技术减少网络往返时间（RTT）</span></span><br><span class="line"><span class="comment">     * - 一次发送所有GET命令，然后统一接收结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Object&gt; trainStationPriceObjs = stringRedisTemplate.executePipelined(</span><br><span class="line">            (RedisCallback&lt;String&gt;) connection -&gt; &#123;</span><br><span class="line">                trainStationPriceKeys.forEach(each -&gt; </span><br><span class="line">                    connection.stringCommands().get(each.getBytes()));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 5. 处理价格与余量信息 =====================</span></span><br><span class="line">    <span class="comment">// 存储所有列车的价格信息</span></span><br><span class="line">    List&lt;TrainStationPriceDO&gt; trainStationPriceDOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 存储所有余量查询Key（用于后续批量查询）</span></span><br><span class="line">    List&lt;String&gt; trainStationRemainingKeyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理价格信息：</span></span><br><span class="line"><span class="comment">     * 1. 反序列化JSON为TrainStationPriceDO列表</span></span><br><span class="line"><span class="comment">     * 2. 为每个座位类型构建余量查询Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (Object each : trainStationPriceObjs) &#123;</span><br><span class="line">        List&lt;TrainStationPriceDO&gt; trainStationPriceList = </span><br><span class="line">                JSON.parseArray(each.toString(), TrainStationPriceDO.class);</span><br><span class="line">        trainStationPriceDOList.addAll(trainStationPriceList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TrainStationPriceDO item : trainStationPriceList) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">trainStationRemainingKey</span> <span class="operator">=</span> cacheRedisPrefix + </span><br><span class="line">                    TRAIN_STATION_REMAINING_TICKET + </span><br><span class="line">                    StrUtil.join(<span class="string">&quot;_&quot;</span>, item.getTrainId(), item.getDeparture(), item.getArrival());</span><br><span class="line">            trainStationRemainingKeyList.add(trainStationRemainingKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用管道批量获取余量信息：</span></span><br><span class="line"><span class="comment">     * - 每个列车班次对应一个Hash结构，field为座位类型</span></span><br><span class="line"><span class="comment">     * - 示例命令：HGET cache:TRAIN_STATION_REMAINING_TICKET:G123_BJSH_SHBZ 1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Object&gt; trainStationRemainingObjs = stringRedisTemplate.executePipelined(</span><br><span class="line">            (RedisCallback&lt;String&gt;) connection -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; trainStationRemainingKeyList.size(); i++) &#123;</span><br><span class="line">                    connection.hashCommands().hGet(</span><br><span class="line">                            trainStationRemainingKeyList.get(i).getBytes(), </span><br><span class="line">                            trainStationPriceDOList.get(i).getSeatType().toString().getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 6. 组装最终数据 =====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为每趟列车组装座位信息：</span></span><br><span class="line"><span class="comment">     * 1. 根据车型获取支持的座位类型列表</span></span><br><span class="line"><span class="comment">     * 2. 提取对应的余量和价格数据</span></span><br><span class="line"><span class="comment">     * 3. 构建座位类型DTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (TicketListDTO each : seatResults) &#123;</span><br><span class="line">        <span class="comment">// 根据车型代码获取支持的座位类型（如高铁可能有1-一等座, 2-二等座）</span></span><br><span class="line">        List&lt;Integer&gt; seatTypesByCode = VehicleTypeEnum.findSeatTypesByCode(each.getTrainType());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 提取当前列车对应的数据子集（按座位类型数量截取）</span></span><br><span class="line">        List&lt;Object&gt; remainingTicket = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">                trainStationRemainingObjs.subList(<span class="number">0</span>, seatTypesByCode.size()));</span><br><span class="line">        List&lt;TrainStationPriceDO&gt; trainStationPriceDOSub = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">                trainStationPriceDOList.subList(<span class="number">0</span>, seatTypesByCode.size()));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 移除已处理的数据（避免重复处理）</span></span><br><span class="line">        trainStationRemainingObjs.subList(<span class="number">0</span>, seatTypesByCode.size()).clear();</span><br><span class="line">        trainStationPriceDOList.subList(<span class="number">0</span>, seatTypesByCode.size()).clear();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构建座位类型DTO列表</span></span><br><span class="line">        List&lt;SeatClassDTO&gt; seatClassList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; trainStationPriceDOSub.size(); i++) &#123;</span><br><span class="line">            <span class="type">TrainStationPriceDO</span> <span class="variable">trainStationPriceDO</span> <span class="operator">=</span> trainStationPriceDOSub.get(i);</span><br><span class="line">            <span class="type">SeatClassDTO</span> <span class="variable">seatClassDTO</span> <span class="operator">=</span> SeatClassDTO.builder()</span><br><span class="line">                    .type(trainStationPriceDO.getSeatType()) <span class="comment">// 座位类型编码</span></span><br><span class="line">                    .quantity(Integer.parseInt(remainingTicket.get(i).toString())) <span class="comment">// 余量</span></span><br><span class="line">                    .price(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(trainStationPriceDO.getPrice())</span><br><span class="line">                            .divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;100&quot;</span>), <span class="number">1</span>, RoundingMode.HALF_UP)) <span class="comment">// 价格（分转元）</span></span><br><span class="line">                    .candidate(<span class="literal">false</span>) <span class="comment">// 是否可候补（默认false）</span></span><br><span class="line">                    .build();</span><br><span class="line">            seatClassList.add(seatClassDTO);</span><br><span class="line">        &#125;</span><br><span class="line">        each.setSeatClassList(seatClassList); <span class="comment">// 关联到车票对象</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 7. 构建响应对象 =====================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造返回DTO：</span></span><br><span class="line"><span class="comment">     * - 列车列表（含完整座位信息）</span></span><br><span class="line"><span class="comment">     * - 辅助筛选列表（出发站、到达站、品牌、座位类型等）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> TicketPageQueryRespDTO.builder()</span><br><span class="line">            .trainList(seatResults) <span class="comment">// 主数据列表</span></span><br><span class="line">            .departureStationList(buildDepartureStationList(seatResults)) <span class="comment">// 去重后的出发站列表</span></span><br><span class="line">            .arrivalStationList(buildArrivalStationList(seatResults)) <span class="comment">// 去重后的到达站列表</span></span><br><span class="line">            .trainBrandList(buildTrainBrandList(seatResults)) <span class="comment">// 列车品牌分类</span></span><br><span class="line">            .seatClassTypeList(buildSeatClassList(seatResults)) <span class="comment">// 支持的座位类型</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="关键方法说明"><a href="#关键方法说明" class="headerlink" title="关键方法说明"></a>关键方法说明</h3><ol>
<li><p><strong><code>ticketPageQueryAbstractChainContext.handler()</code></strong>  </p>
<ul>
<li><strong>作用</strong>：责任链模式校验参数  </li>
<li><strong>实现</strong>：依次执行多个校验处理器，如：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(String mark, TicketPageQueryReqDTO requestParam)</span> &#123;</span><br><span class="line">    List&lt;AbstractChainHandler&gt; handlers = chainContainer.get(mark);</span><br><span class="line">    handlers.forEach(handler -&gt; handler.handler(requestParam));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong><code>TimeStringComparator</code></strong>  </p>
<ul>
<li><strong>作用</strong>：按出发时间排序  </li>
<li><strong>核心逻辑</strong>：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(TicketListDTO o1, TicketListDTO o2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> o1.getDepartureTime().compareTo(o2.getDepartureTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong><code>VehicleTypeEnum.findSeatTypesByCode()</code></strong>  </p>
<ul>
<li><strong>作用</strong>：根据车型获取支持的座位类型  </li>
<li><strong>示例数据</strong>：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HIGH_SPEED_RAIL(<span class="number">1</span>, <span class="string">&quot;高铁&quot;</span>, Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)), <span class="comment">// 1-商务座, 2-一等座, 3-二等座</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>辅助构建方法</strong>（如<code>buildDepartureStationList</code>）  </p>
<ul>
<li><strong>作用</strong>：从结果中提取去重后的站点列表  </li>
<li><strong>实现</strong>：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">buildDepartureStationList</span><span class="params">(List&lt;TicketListDTO&gt; list)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> list.stream()</span><br><span class="line">            .map(TicketListDTO::getDeparture)</span><br><span class="line">            .distinct()</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<hr>
<h3 id="性能优化点总结"><a href="#性能优化点总结" class="headerlink" title="性能优化点总结"></a>性能优化点总结</h3><ol>
<li><p><strong>多级缓存策略</strong>  </p>
<ul>
<li>第一级：列车班次信息（Hash结构）  </li>
<li>第二级：座位价格（String-JSON）  </li>
<li>第三级：余量信息（Hash）</li>
</ul>
</li>
<li><p><strong>批量操作</strong>  </p>
<ul>
<li>使用<code>executePipelined</code>批量获取数据  </li>
<li>减少网络往返时间（RTT）</li>
</ul>
</li>
<li><p><strong>数据分片处理</strong>  </p>
<ul>
<li>按列车分批处理余量和价格数据  </li>
<li>及时清理已处理数据（<code>subList.clear()</code>）</li>
</ul>
</li>
<li><p><strong>内存优化</strong>  </p>
<ul>
<li>使用流式处理避免中间集合  </li>
<li>采用不可变集合（<code>.toList()</code>）</li>
</ul>
</li>
</ol>
<p>此实现通过以上优化，在保证功能完整性的同时，显著提升了高并发场景下的性能表现。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Allimac</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/22/12306Business-1/">http://example.com/2025/04/22/12306Business-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">AllimacBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/">缓存穿透</a><a class="post-meta__tags" href="/tags/%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8/">加密存储</a><a class="post-meta__tags" href="/tags/%E8%84%B1%E5%AF%86%E5%B1%95%E7%A4%BA/">脱密展示</a><a class="post-meta__tags" href="/tags/%E5%88%97%E8%BD%A6%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2/">列车信息查询</a><a class="post-meta__tags" href="/tags/12306%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/">12306业务梳理</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/22/12306Impl-4/" title="12306Impl-4"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">12306Impl-4</div></div><div class="info-2"><div class="info-item-1">防止库存超卖；布隆过滤器快速返回；抗节假日高并发；中间站点余票如何更新；Binlog更新延迟问题怎么解决；如何保证消息顿列顺序性</div></div></div></a><a class="pagination-related" href="/2025/04/22/12306Business-2/" title="12306Business-2"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">12306Business-2</div></div><div class="info-2"><div class="info-item-1">解决海量下单并发压力；下单过程解析；</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/22/12306Impl-1/" title="12306Impl-1"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-22</div><div class="info-item-2">12306Impl-1</div></div><div class="info-2"><div class="info-item-1">12306开发的过程当中，会对核心业务的思路进行梳理。一个文档可能涉及七八个技术点左右。这篇文章主要介绍：发起支付的流程，搜索技术的选型。如何防止用户注册高并发情况下的缓存穿透。责任链模式进行校验</div></div></div></a><a class="pagination-related" href="/2025/04/22/12306Business-2/" title="12306Business-2"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-22</div><div class="info-item-2">12306Business-2</div></div><div class="info-2"><div class="info-item-1">解决海量下单并发压力；下单过程解析；</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Allimac</div><div class="author-info-description">华丽的仓库存放着我简陋的思想</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">67</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/AillemaCc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AillemaCc" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="http://www.swindle.icu/#/Home" target="_blank" title="曾经的博客"><i class="fas fa-envelope" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这里是小梦一场的大床</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">用户注册流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A0%A1%E9%AA%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">责任链校验模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">异常码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82DTO"><span class="toc-number">1.1.2.</span> <span class="toc-text">请求DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%BF%85%E5%A1%AB%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.</span> <span class="toc-text">参数必填校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E6%A0%A1%E9%AA%8C%E2%80%93%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%9A%84%E5%85%B3%E9%94%AE%E6%89%80%E5%9C%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text">唯一校验–防止缓存穿透的关键所在</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%88%A4%E9%87%8D-%E6%9F%A5%E8%AF%A2%E5%8F%AF%E5%A4%8D%E7%94%A8set"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">布隆过滤器判重+查询可复用set</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E5%88%86%E7%89%87%E2%80%93%E5%87%8F%E5%B0%91%E5%A4%A7key%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">哈希分片–减少大key问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%AC%A1%E6%B3%A8%E9%94%80%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.5.</span> <span class="toc-text">多次注销校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%8A%A2%E5%8D%A0"><span class="toc-number">1.2.</span> <span class="toc-text">分布式锁抢占</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E4%B8%BB%E8%A1%A8"><span class="toc-number">1.3.</span> <span class="toc-text">插入主表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%89%8B%E6%9C%BA%E5%8F%B7%E8%A1%A8%E5%92%8C%E9%82%AE%E7%AE%B1%E8%A1%A8"><span class="toc-number">1.4.</span> <span class="toc-text">插入手机号表和邮箱表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E6%9C%BA%E5%8F%B7%E8%A1%A8"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">手机号表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%82%AE%E7%AE%B1%E8%A1%A8"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">邮箱表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%A4%84%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">后处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E6%B5%B7%E9%87%8F%E5%B9%B6%E5%8F%91%E6%B3%A8%E5%86%8C%E5%B8%A6%E6%9D%A5%E7%9A%84%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">如何应对海量并发注册带来的缓存穿透问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%87%BA%E7%8E%B0%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">2.1.</span> <span class="toc-text">用户出现缓存穿透的场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E5%80%BC%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.1.</span> <span class="toc-text">空值缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.2.2.</span> <span class="toc-text">布隆过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-Set%E5%AD%98%E5%82%A8%E5%B7%B2%E7%BB%8F%E6%B3%A8%E5%86%8C%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">2.2.3.</span> <span class="toc-text">Redis Set存储已经注册的用户名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">2.2.4.</span> <span class="toc-text">分布式锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.</span> <span class="toc-text">综合解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8%E5%92%8C%E8%84%B1%E6%95%8F%E5%B1%95%E7%A4%BA"><span class="toc-number">3.</span> <span class="toc-text">敏感数据的加密存储和脱敏展示</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8"><span class="toc-number">3.1.</span> <span class="toc-text">加密存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%B1%E6%95%8F%E5%B1%95%E7%A4%BA"><span class="toc-number">3.2.</span> <span class="toc-text">脱敏展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jackson%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E6%A1%88%E2%80%93%E6%9B%B4%E5%8A%A0%E8%BD%BB%E9%87%8F%E7%BA%A7"><span class="toc-number">3.2.1.</span> <span class="toc-text">Jackson序列化方案–更加轻量级</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%97%E8%BD%A6%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2V1"><span class="toc-number">4.</span> <span class="toc-text">列车信息查询V1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A0%A1%E9%AA%8C%E6%A8%A1%E5%BC%8F-1"><span class="toc-number">4.1.</span> <span class="toc-text">责任链校验模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%A9%BA%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.1.1.</span> <span class="toc-text">非空校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.1.2.</span> <span class="toc-text">基础数据校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%AD%A5%E6%8B%86%E8%A7%A3"><span class="toc-number">4.2.</span> <span class="toc-text">分步拆解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E5%8F%91%E5%9C%B0%E7%9B%AE%E7%9A%84%E5%9C%B0%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.2.1.</span> <span class="toc-text">出发地目的地校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BB%BA%E7%AB%8B%E7%BC%93%E5%AD%98"><span class="toc-number">4.2.2.</span> <span class="toc-text">查询数据库建立缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E7%BC%93%E5%AD%98"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">建立缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E5%A4%84%E7%90%86-1"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">后处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%9F%8E%E5%B8%82%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.</span> <span class="toc-text">加载城市数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F%E8%8E%B7%E5%8F%96%E5%87%BA%E5%8F%91%E7%AB%99%E7%82%B9%E5%92%8C%E5%88%B0%E8%BE%BE%E7%AB%99%E7%82%B9%E5%AF%B9%E5%BA%94%E7%9A%84%E5%9F%8E%E5%B8%82%E9%9B%86%E5%90%88"><span class="toc-number">4.3.1.</span> <span class="toc-text">批量查询方式获取出发站点和到达站点对应的城市集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C%E5%88%A4%E7%A9%BA%E5%92%8C%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%BB%E8%BE%91"><span class="toc-number">4.3.2.</span> <span class="toc-text">校验判空和加载数据库逻辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%88%97%E8%BD%A6%E7%AB%99%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">查询列车站点信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%9F%8E%E5%B8%82%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2%E5%9F%8E%E5%B8%82%E4%B8%8B%E7%AB%99%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.1.</span> <span class="toc-text">根据城市信息查询城市下站点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98"><span class="toc-number">4.4.2.</span> <span class="toc-text">构建缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9E%84%E5%BB%BA"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">数据构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%84%E5%8A%A0%E4%BF%A1%E6%81%AF%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">附加信息处理模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%94%AE%E7%A5%A8%E7%8A%B6%E6%80%81%E5%A4%84%E7%90%86"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">售票状态处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E6%94%B6%E9%9B%86%E6%A8%A1%E5%9D%97"><span class="toc-number">4.4.2.4.</span> <span class="toc-text">结果收集模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">4.4.2.5.</span> <span class="toc-text">缓存处理模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%88%97%E8%BD%A6%E4%BD%99%E7%A5%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.</span> <span class="toc-text">查询列车余票信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E5%9B%9E%E9%80%80"><span class="toc-number">4.5.1.</span> <span class="toc-text">数据初始化与回退</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8E%92%E5%BA%8F"><span class="toc-number">4.5.2.</span> <span class="toc-text">数据排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%A7%E4%BD%8D%E4%BB%B7%E6%A0%BC%E4%B8%8E%E4%BD%99%E9%87%8F%E5%A4%84%E7%90%86"><span class="toc-number">4.5.3.</span> <span class="toc-text">座位价格与余量处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%9E%84%E5%BB%BA"><span class="toc-number">4.5.4.</span> <span class="toc-text">响应构建</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%97%E8%BD%A6%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2V2"><span class="toc-number">5.</span> <span class="toc-text">列车信息查询V2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95%E8%AF%B4%E6%98%8E"><span class="toc-number">5.0.1.</span> <span class="toc-text">关键方法说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">5.0.2.</span> <span class="toc-text">性能优化点总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/JavaBasic8Gu/" title="JavaBasic8Gu">JavaBasic8Gu</a><time datetime="2025-04-22T10:30:18.000Z" title="发表于 2025-04-22 18:30:18">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/Hot100-1/" title="Hot100-1">Hot100-1</a><time datetime="2025-04-22T10:22:09.000Z" title="发表于 2025-04-22 18:22:09">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/TechDuck200/" title="TechDuck200">TechDuck200</a><time datetime="2025-04-22T10:20:48.000Z" title="发表于 2025-04-22 18:20:48">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/12306Business-2/" title="12306Business-2">12306Business-2</a><time datetime="2025-04-22T10:14:27.000Z" title="发表于 2025-04-22 18:14:27">2025-04-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/22/12306Business-1/" title="12306Business-1">12306Business-1</a><time datetime="2025-04-22T10:10:07.000Z" title="发表于 2025-04-22 18:10:07">2025-04-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Allimac</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>